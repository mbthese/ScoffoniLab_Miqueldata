---
title: "Script_Final"
author: "Marion Boisseaux"
date: "2025-12-03"
output: html_document
---

#libraries 

```{r}
library(ggplot2)
library(agricolae)
library(plyr)
library(multcomp)
library(corrplot)
library(factoextra)
library(readxl)
library(dplyr)
library(ggpubr)
library(cowplot)
library(tidyr)
library(readr)
library(tibble)
library(purrr)
library(kableExtra) 
library(webshot2)
library(Hmisc)
library(drc)
library(RColorBrewer) 

```


#///////Figure 1
Kleaf, Kplant, Kroot, A, gs

##data - using GEXdata dehydration dataset
```{r}
GExdata<-read_xlsx(path = "../data/C3C4 Grasses - GEx_PsifrompVcurves.xlsx", sheet = "C3C4G GEx R")
colnames(GExdata)
GExdata$Dataset<-factor(GExdata$Dataset)
GExdata$Metabolism<-factor(GExdata$Metabolism)
GExdata$Species<-factor(GExdata$Species,levels=c("Avsa","Hovu","Trae","Pegl","Zema","Chga"))
GExdata$Individual<-factor(GExdata$Individual)
GExdata$Leaf<-factor(GExdata$Leaf)
GExdata$Time.min<-factor(GExdata$Time.min)

# variable calculation
GExdata$FW <- as.numeric(GExdata$FW) 
GExdata$DW <- as.numeric(GExdata$DW)
GExdata$RW <- as.numeric(GExdata$RW)
GExdata$RWC<-as.numeric(GExdata$RWC)
GExdata$Psip<-as.numeric(GExdata$Psip)
GExdata$Ps<-as.numeric(GExdata$Ps)
GExdata$`Psileaf from RWC`<-as.numeric(GExdata$`Psileaf from RWC`)
GExdata$An.area <- as.numeric(GExdata$An.area) 
GExdata$gsw.area <- as.numeric(GExdata$gsw.area) 
GExdata$Ci <- as.numeric(GExdata$Ci) 
GExdata$WUEi <- as.numeric(GExdata$WUEi) 
GExdata$phiPSII <- as.numeric(GExdata$phiPSII) 
GExdata$An.mass.LMApv <- as.numeric(GExdata$An.mass.LMApv) 

# subsets
GExdata.0<-subset(GExdata,Time.min=="0") #combines midday and dehydration time = 0 datasets
GExdata.midd<-subset(GExdata,Dataset=="Midday") #time = 0 
GExdata.dehy<-subset(GExdata,Dataset== "Dehydration") #here time varies from 0 to X minutes

# means GEx midday
m.GExdata.midd<-ddply(GExdata.midd,c("Species","Metabolism"),summarise,
            m.An.area=mean(An.area,na.rm=TRUE),n.An.area=sum(!is.na(An.area)),se.An.area=sd(An.area,na.rm=T)/sqrt(n.An.area),
            m.gsw.area=mean(gsw.area,na.rm=TRUE),n.gsw.area=sum(!is.na(gsw.area)),se.gsw.area=sd(gsw.area,na.rm=T)/sqrt(n.gsw.area),
            m.Ci=mean(Ci,na.rm=TRUE),n.Ci=sum(!is.na(Ci)),se.Ci=sd(Ci,na.rm=T)/sqrt(n.Ci),
            m.WUEi=mean(WUEi,na.rm=TRUE),n.WUEi=sum(!is.na(WUEi)),se.WUEi=sd(WUEi,na.rm=T)/sqrt(n.WUEi),
            m.phiPSII=mean(phiPSII,na.rm=TRUE),n.phiPSII=sum(!is.na(phiPSII)),se.phiPSII=sd(phiPSII,na.rm=T)/sqrt(n.phiPSII))

#max values for relative plotting
max.GExdata.dehy<-ddply(GExdata.dehy,c("Species","Metabolism"),summarise,
            max.An.area=max(An.area,na.rm=TRUE),
            max.gsw.area=max(gsw.area,na.rm=TRUE), 
            max_WUEi = max(WUEi, na.rm=TRUE))

#dataset that will look if midday range values are similar to maximum dehydration values
max.GExdata.dehy_long <- max.GExdata.dehy %>%
  rename("A" = "max.An.area", "gs"=  "max.gsw.area", "WUE" = "max_WUEi") %>%
  pivot_longer(cols = c("A" , "gs", "WUE"), values_to = "values" ) %>%
  rename(trait = name) %>%
  mutate(time = "max_dehy")

m.GExdata.midd_long <- GExdata.midd %>%
  dplyr::select("Species", "Metabolism",  "An.area" ,"gsw.area" , "WUEi" ) %>%
   rename("A" = "An.area", "gs"=  "gsw.area", "WUE" = "WUEi") 

A_plot_max_range <- ggplot()+
  geom_boxplot(data = GExdata.midd, aes(x=Species, y=An.area))+
  geom_point(data= max.GExdata.dehy, aes(x= Species, y=max.An.area), color = 'red', size = 2)+
  theme_minimal()+
  ylab(expression(paste("A"[n], " ("*mu*"mol m"^{-2}~"s"^{-1}*")")))
  
A_plot_max_range

g_plot_max_range <- ggplot()+
  geom_boxplot(data = GExdata.midd, aes(x=Species, y=gsw.area))+
  geom_point(data= max.GExdata.dehy, aes(x= Species, y=max.gsw.area), color = 'red', size = 2)+
  theme_minimal()+
    ylab(expression(paste("g"[sw], " (mol m"^{-2}~"s"^{-1}*")")))
  
g_plot_max_range

W_plot_max_range <- ggplot()+
  geom_boxplot(data = GExdata.midd, aes(x=Species, y=WUEi))+
  geom_point(data= max.GExdata.dehy, aes(x= Species, y=max_WUEi), color = 'red', size = 2)+
  theme_minimal()+
    ylab(expression(paste("WUE"[i])))
  
W_plot_max_range

plot_max_range <- ggarrange(A_plot_max_range, g_plot_max_range, W_plot_max_range,ncol = 1 )
```




# Assimilation -fit curves 
```{r eval=FALSE, include=FALSE}
# Avsa -----

#format for fitting for Megan's script
GEx_A_curve_avsa <- GExdata.dehy %>%
  filter(Species =="Avsa") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg, An.area) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs = An.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

# Hovu -------

GEx_A_curve_hovu <- GExdata.dehy %>%
  filter(Species =="Hovu") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg, An.area ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs = An.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()


# Trae -------

GEx_A_curve_trae <- GExdata.dehy %>%
  filter(Species =="Trae") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg, An.area ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs = An.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()  

# Pegl ----------

GEx_A_curve_pegl <- GExdata.dehy %>%
  filter(Species =="Pegl") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg, An.area) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs = An.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

# Chga -----------

GEx_A_curve_chga <- GExdata.dehy %>%
  filter(Species =="Chga") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg, An.area ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs = An.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

# Zema ----------


GEx_A_curve_zema <- GExdata.dehy %>%
  filter(Species =="Zema") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg, An.area ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs = An.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

#after fitting curve with "Closure Script 2017 for FvFm" and "R function MB 2017 for FvFm"

A <- rbind(GEx_A_curve_avsa, GEx_A_curve_hovu, GEx_A_curve_trae, GEx_A_curve_pegl, GEx_A_curve_zema, GEx_A_curve_chga)

write.csv(x = A, file = "../results/A/A.csv")
```

##AVSA - plot assimilation
```{r}
avsa_A_sig <-  read.csv("../results/A/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Avsa') %>%
  filter(model == 'Sigmoidal')

data_avsa <- GExdata.dehy %>%
  filter(Species == 'Avsa')

x_seq.avsa_A <- seq(0.1, 2, by=0.01)*(-1)
x_seq.avsa_A

# Correct the sign of the inflection point
C <- -avsa_A_sig$C
B <- -avsa_A_sig$B
A <- avsa_A_sig$A

# Recalculate the model
y_model.avsa_A_sigmoidal <- A / (1 + exp(-((x_seq.avsa_A - C) / B)))

avsa_A50= (-avsa_A_sig$B*(log(1+exp((avsa_A_sig$C/avsa_A_sig$B)-0.5)/0.5))+avsa_A_sig$C)*-1 
    
Avsa_GEx_A<-ggplot()+
 geom_point(data=data_avsa,aes(x=`Psileaf from RWC`,y=An.area),size=5,color="#6DB9F8", alpha = 0.3)+
 geom_line(aes(x = x_seq.avsa_A, y = y_model.avsa_A_sigmoidal), color = '#6DB9F8', size=1.5)+
  #geom_point(data= GExdata.midd %>% filter(Species == "Avsa"), aes(x= F.wp.leaf, y=An.area), color = 'red', size = 4, alpha = 0.3)+
  geom_vline(xintercept = avsa_A_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  # ggtitle("A. sativa")+
  ylab(expression(paste("A"[n], " ("*mu*"mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,45)
Avsa_GEx_A
```

##HOVU plot assimilation
```{r}
hovu_A_sig <-  read.csv("../results/A/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Hovu') %>%
  filter(model == 'Sigmoidal')

data_hovu <- GExdata.dehy %>%
  filter(Species == 'Hovu')

x_seq.hovu_A <- seq(0.1, 2, by=0.01)*(-1)

# Correct the sign of the inflection point
C <- -hovu_A_sig$C
B<- -hovu_A_sig$B
A <- hovu_A_sig$A

# Recalculate the model
y_model.hovu_A_sigmoidal <- A / (1 + exp(-((x_seq.hovu_A - C) / B)))

hovu_A50= (-hovu_A_sig$B*(log(1+exp((hovu_A_sig$C/hovu_A_sig$B)-0.5)/0.5))+hovu_A_sig$C)*-1 

Hovu_GEx_A<-ggplot()+
 geom_point(data=data_hovu,aes(x=`Psileaf from RWC`,y=An.area),size=5,color="#6DB9F8", alpha = 0.3)+
 geom_line(aes(x = x_seq.hovu_A, y = y_model.hovu_A_sigmoidal), color = '#6DB9F8', size=1.5)+
  # geom_point(data= GExdata.midd %>% filter(Species == "Hovu"), aes(x= F.wp.leaf, y=An.area), color = 'red', size = 4, alpha = 0.3)+
    geom_vline(xintercept = hovu_A_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
#   ggtitle("H. vulgare")+
ylab(expression(paste("A"[n], " ("*mu*"mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,45)
Hovu_GEx_A

```

##TRAE - plot assimilation
```{r}
trae_A_sig <-  read.csv("../results/A/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Trae') %>%
  filter(model == 'Sigmoidal')

data_trae <- GExdata.dehy %>%
  filter(Species == 'Trae')

x_seq.trae_A <- seq(0.1, 2, by=0.01)*(-1)

# Correct the sign of the inflection point
C <- -trae_A_sig$C
B <- -trae_A_sig$B
A <- trae_A_sig$A

# Recalculate the model
y_model.trae_A_sigmoidal <- A / (1 + exp(-((x_seq.trae_A - C) / B)))

trae_A50= (-trae_A_sig$B*(log(1+exp((trae_A_sig$C/trae_A_sig$B)-0.5)/0.5))+trae_A_sig$C)*-1 

Trae_GEx_A<-ggplot()+
 geom_point(data=data_trae,aes(x=`Psileaf from RWC`,y=An.area),size=5,color="#6DB9F8", alpha = 0.3)+
 geom_line(aes(x = x_seq.trae_A, y = y_model.trae_A_sigmoidal), color = '#6DB9F8', size=1.5)+
 # geom_point(data= GExdata.midd %>% filter(Species == "Trae"), aes(x= F.wp.leaf, y=An.area), color = 'red', size = 4, alpha = 0.3)+
    geom_vline(xintercept = trae_A_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   # ggtitle("T. aestivum")+
ylab(expression(paste("A"[n], " ("*mu*"mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,45)
Trae_GEx_A
```


##PEGL - plot assimilation

```{r}
Pegl_A_sig <-  read.csv("../results/A/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Pegl') %>%
  filter(model == 'Sigmoidal')

data_Pegl <- GExdata.dehy %>%
  filter(Species == 'Pegl')

x_seq.Pegl_A <- seq(0.1, 2, by=0.01)*(-1)
x_seq.Pegl_A

# Correct the sign of the inflection point
C <- -Pegl_A_sig$C
B <- -Pegl_A_sig$B
A <- Pegl_A_sig$A

# Recalculate the model
y_model.Pegl_A_sigmoidal <- A / (1 + exp(-((x_seq.Pegl_A - C) / B)))

Pegl_A50= (-Pegl_A_sig$B*(log(1+exp((Pegl_A_sig$C/Pegl_A_sig$B)-0.5)/0.5))+Pegl_A_sig$C)*-1 

Pegl_GEx_A<-ggplot()+
 geom_point(data=data_Pegl,aes(x=`Psileaf from RWC`,y=An.area),size=5,color="#D9AB33", alpha = 0.3)+
 geom_line(aes(x = x_seq.Pegl_A, y = y_model.Pegl_A_sigmoidal), color = '#D9AB33', size=1.5)+
  # geom_point(data= GExdata.midd %>% filter(Species == "Pegl"), aes(x= F.wp.leaf, y=An.area), color = 'red', size = 4, alpha = 0.3)+
    geom_vline(xintercept = Pegl_A_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
 #  ggtitle("P. glaucum")+
ylab(expression(paste("A"[n], " ("*mu*"mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,45)
Pegl_GEx_A
```

##CHGA - plot assimilation

```{r}

chga_A_sig <-  read.csv("../results/A/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Chga') %>%
  filter(model == 'Sigmoidal')

data_chga <- GExdata.dehy %>%
  filter(Species == 'Chga')

x_seq.chga_A <- seq(0.1, 2, by=0.01)*(-1)
x_seq.chga_A

# Correct the sign of the inflection point
C <- -chga_A_sig$C
B <- -chga_A_sig$B
A <- chga_A_sig$A

# Recalculate the model
y_model.chga_A_sigmoidal <- A / (1 + exp(-((x_seq.chga_A - C) / B)))

chga_A50= (-chga_A_sig$B*(log(1+exp((chga_A_sig$C/chga_A_sig$B)-0.5)/0.5))+chga_A_sig$C)*-1 


Chga_GEx_A<-ggplot()+
 geom_point(data=data_chga,aes(x=`Psileaf from RWC`,y=An.area),size=5,color="#D9AB33", alpha = 0.3)+
 geom_line(aes(x = x_seq.chga_A, y = y_model.chga_A_sigmoidal), color = '#D9AB33', size=1.5)+
  # geom_point(data= GExdata.midd %>% filter(Species == "Chga"), aes(x= F.wp.leaf, y=An.area), color = 'red', size = 4, alpha = 0.3)+
    geom_vline(xintercept = chga_A_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
#    ggtitle("C. gayan")+
ylab(expression(paste("A"[n], " ("*mu*"mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,45)
Chga_GEx_A
```

##ZEMA - plot assimilation
```{r}

zema_A_sig <- read.csv("../results/A/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Zema') %>%
  filter(model == 'Sigmoidal')

data_zema <- GExdata.dehy %>%
  filter(Species == 'Zema')

x_seq.zema_A <- seq(0.1, 2, by=0.01)*(-1)
x_seq.zema_A

# Correct the sign of the inflection point
C <- -zema_A_sig$C
B <- -zema_A_sig$B
A <- zema_A_sig$A

# Recalculate the model
y_model.zema_A_sigmoidal <- A / (1 + exp(-((x_seq.zema_A - C) / B)))

zema_A50= (-zema_A_sig$B*(log(1+exp((zema_A_sig$C/zema_A_sig$B)-0.5)/0.5))+zema_A_sig$C)*-1 


Zema_GEx_A<-ggplot()+
 geom_point(data=data_zema,aes(x=`Psileaf from RWC`,y=An.area),size=5,color="#D9AB33", alpha = 0.3)+
 geom_line(aes(x = x_seq.zema_A, y = y_model.zema_A_sigmoidal), color = '#D9AB33', size=1.5)+
  # geom_point(data= GExdata.midd %>% filter(Species == "Zema"), aes(x= F.wp.leaf, y=An.area), color = 'red', size = 4, alpha = 0.3)+
    geom_vline(xintercept = zema_A_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
 # ggtitle("Z. mays")+
ylab(expression(paste("A"[n], " ("*mu*"mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,45)
Zema_GEx_A
```


#gs -fit curves 
```{r}
# Avsa ------

GEx_g_curve_avsa <- GExdata.dehy %>%
  filter(Species =="Avsa") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, `psi_neg`,  gsw.area ) %>%
  dplyr::rename(psi = `psi_neg`) %>%
  dplyr::rename(gs =  `gsw.area`) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = GEx_g_curve_avsa, file = "../results/GEx_g_curve_avsa.csv") #ready for 

#after fitting curve with "Closure Script 2017 for FvFm" and "R function MB 2017 for FvFm"

# Hovu ---------

GEx_g_curve_hovu <- GExdata.dehy %>%
  filter(Species =="Hovu") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg,  gsw.area ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs =  gsw.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = GEx_g_curve_hovu, file = "../results/GEx_g_curve_hovu.csv")

# Trae -----------

GEx_g_curve_trae <- GExdata.dehy %>%
  filter(Species =="Trae") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg,  gsw.area ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs =  gsw.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = GEx_g_curve_trae, file = "../results/GEx_g_curve_trae.csv")

# Pegl ----------

GEx_g_curve_pegl <- GExdata.dehy %>%
  filter(Species =="Pegl") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg,  gsw.area) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs =  gsw.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = GEx_g_curve_pegl, file = "../results/GEx_g_curve_pegl.csv")

# Chga -------------

GEx_g_curve_chga <- GExdata.dehy %>%
  filter(Species =="Chga") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg,  gsw.area ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs =  gsw.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = GEx_g_curve_chga, file = "../results/GEx_g_curve_chga.csv")

# Zema ----------
GEx_g_curve_zema <- GExdata.dehy %>%
  filter(Species =="Zema") %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, psi_neg,  gsw.area ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs =  gsw.area) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = GEx_g_curve_zema, file = "../results/GEx_g_curve_zema.csv")

gs <- rbind(GEx_g_curve_avsa, GEx_g_curve_hovu, GEx_g_curve_trae, GEx_g_curve_chga, GEx_g_curve_pegl, GEx_g_curve_zema)

write.csv(x = gs, file = "../results/gs/gs.csv")
```

## AVSA - plot conductance
```{r}
avsa_g_sig <-  read.csv("../results/gs/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Avsa') %>%
  filter(model == 'Sigmoidal')

data_avsa <- GExdata.dehy %>%
  filter(Species == 'Avsa')

x_seq.avsa <- seq(0.1, 2, by=0.01)*(-1)
x_seq.avsa

# Correct the sign of the inflection point
C <- -avsa_g_sig$C
B <- -avsa_g_sig$B
A <- avsa_g_sig$A

# Recalculate the model
y_model.avsa_g_sigmoidal <- A / (1 + exp(-((x_seq.avsa - C) / B)))

avsa_g50= (-avsa_g_sig$B*(log(1+exp((avsa_g_sig$C/avsa_g_sig$B)-0.5)/0.5))+avsa_g_sig$C)*-1 


Avsa_GEx_g<-ggplot()+
 geom_point(data=data_avsa,aes(x=`Psileaf from RWC`,y=gsw.area),size=5,color="#6DB9F8", alpha = 0.3)+
   geom_line(aes(x = x_seq.avsa, y = y_model.avsa_g_sigmoidal), color = '#6DB9F8', size=1.5)+
  # geom_point(data= GExdata.midd %>% filter(Species == "Avsa"), aes(x= F.wp.leaf, y=gsw.area), color = 'red', size = 4, alpha = 0.3)+
    geom_vline(xintercept = avsa_g_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  # ggtitle("A. sativa")+
   ylab(expression(atop(g[s], "(mol" ~ m^{-2} ~ s^{-1}*")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,0.65)

Avsa_GEx_g
```

## HOVU plot conductance
```{r}
hovu_g_sig <-  read.csv("../results/gs/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Hovu') %>%
  filter(model == 'Sigmoidal')

data_hovu <- GExdata.dehy %>%
  filter(Species == 'Hovu')

x_seq.hovu <- seq(0.1, 2, by=0.01)*(-1)
x_seq.hovu

# Correct the sign of the inflection point
C <- -hovu_g_sig$C
B <- -hovu_g_sig$B
A <- hovu_g_sig$A

# Recalculate the model
y_model.hovu_g_sigmoidal <- A / (1 + exp(-((x_seq.hovu - C) / B)))

hovu_g50= (-hovu_g_sig$B*(log(1+exp((hovu_g_sig$C/hovu_g_sig$B)-0.5)/0.5))+hovu_g_sig$C)*-1 



Hovu_GEx_g<-ggplot()+
 geom_point(data=data_hovu,aes(x=`Psileaf from RWC`,y=gsw.area),size=5,color="#6DB9F8", alpha = 0.3)+
   geom_line(aes(x = x_seq.hovu, y = y_model.hovu_g_sigmoidal), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept = hovu_g_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
    ylab(expression(paste("g"[sw], " (mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,0.65)

Hovu_GEx_g
```

## TRAE - plot conductance
```{r}
trae_g_sig <-  read.csv("../results/gs/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Trae') %>%
  filter(model == 'Sigmoidal')

data_trae <- GExdata.dehy %>%
  filter(Species == 'Trae')

x_seq.trae <- seq(0.1, 2, by=0.01)*(-1)
x_seq.trae

# Correct the sign of the inflection point
C <- -trae_g_sig$C
B <- -trae_g_sig$B
A <- trae_g_sig$A

# Recalculate the model
y_model.trae_g_sigmoidal <- A / (1 + exp(-((x_seq.trae - C) / B)))

trae_g50= (-trae_g_sig$B*(log(1+exp((trae_g_sig$C/trae_g_sig$B)-0.5)/0.5))+trae_g_sig$C)*-1 


Trae_GEx_g<-ggplot()+
 geom_point(data=data_trae,aes(x=`Psileaf from RWC`,y=gsw.area),size=5,color="#6DB9F8", alpha = 0.3)+
   geom_line(aes(x = x_seq.trae, y = y_model.trae_g_sigmoidal), color = '#6DB9F8', size=1.5)+
#   geom_point(data= GExdata.midd %>% filter(Species == "Trae"), aes(x= F.wp.leaf, y=gsw.area), color = 'red', size = 4, alpha = 0.3)+
   geom_vline(xintercept = trae_g_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
#   ggtitle("T. aestivum")+
   ylab(expression(paste("g"[sw], " (mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,0.65)

Trae_GEx_g

```

## CHGA - plot conductance
```{r}
  
chga_g_sig <-  read.csv("../results/gs/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Chga') %>%
  filter(model == 'Sigmoidal')

data_chga <- GExdata.dehy %>%
  filter(Species == 'Chga')

x_seq.chga <- seq(0.1, 2, by=0.01)*(-1)
x_seq.chga

# Correct the sign of the inflection point
C <- -chga_g_sig$C
B <- -chga_g_sig$B
A <- chga_g_sig$A

# Recalculate the model
y_model.chga_g_sigmoidal <- A / (1 + exp(-((x_seq.chga - C) / B)))

chga_g50= (-chga_g_sig$B*(log(1+exp((chga_g_sig$C/chga_g_sig$B)-0.5)/0.5))+chga_g_sig$C)*-1 


Chga_GEx_g<-ggplot()+
 geom_point(data=data_chga,aes(x=`Psileaf from RWC`,y=gsw.area),size=5,color="#D9AB33", alpha = 0.3)+
   geom_line(aes(x = x_seq.chga, y = y_model.chga_g_sigmoidal), color = '#D9AB33', size=1.5)+
 #  geom_point(data= GExdata.midd %>% filter(Species == "Chga"), aes(x= F.wp.leaf, y=gsw.area), color = 'red', size = 4, alpha = 0.3)+
   geom_vline(xintercept = chga_g_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  # ggtitle("C. gayan")+
   ylab(expression(paste("g"[sw], " (mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,0.65)

Chga_GEx_g

```

## PEGL - plot conductance
```{r}
pegl_g_sig <-  read.csv("../results/gs/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Pegl') %>%
  filter(model == 'Sigmoidal')

data_pegl <- GExdata.dehy %>%
  filter(Species == 'Pegl')

x_seq.pegl <- seq(0.1, 2, by=0.01)*(-1)
x_seq.pegl

# Correct the sign of the inflection point
C <- -pegl_g_sig$C
B <- -pegl_g_sig$B
A <- pegl_g_sig$A

# Recalculate the model
y_model.pegl_g_sigmoidal <- A / (1 + exp(-((x_seq.pegl - C) / B)))

pegl_g50= (-pegl_g_sig$B*(log(1+exp((pegl_g_sig$C/pegl_g_sig$B)-0.5)/0.5))+pegl_g_sig$C)*-1 


Pegl_GEx_g<-ggplot()+
 geom_point(data=data_pegl,aes(x=`Psileaf from RWC`,y=gsw.area),size=5,color="#D9AB33", alpha = 0.3)+
   geom_line(aes(x = x_seq.pegl, y = y_model.pegl_g_sigmoidal), color = '#D9AB33', size=1.5)+
#   geom_point(data= GExdata.midd %>% filter(Species == "Pegl"), aes(x= F.wp.leaf, y=gsw.area), color = 'red', size = 4, alpha = 0.3)+
   geom_vline(xintercept = pegl_g_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
 #  ggtitle("P. glaucum")+
   ylab(expression(paste("g"[sw], " (mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,0.65)

Pegl_GEx_g
 
```

## ZEMA - plot conductance
```{r}

zema_g_sig <-  read.csv("../results/gs/model_fitting_results.csv") %>% #best model sigmodoidal
  filter(Species == 'Zema') %>%
  filter(model == 'Linear')

data_zema <- GExdata.dehy %>%
  filter(Species == 'Zema')

x_seq.zema <-seq(0.1, 2, by=0.01)*(-1)
x_seq.zema

# Correct the sign of the inflection point
C <- -zema_g_sig$C
B <- -zema_g_sig$B
A <- zema_g_sig$A

# Recalculate the model
y_model.zema_g_sigmoidal <- A + x_seq.zema * B

Zema_GEx_g<-ggplot()+
 geom_point(data=data_zema,aes(x=`Psileaf from RWC`,y=gsw.area),size=5,color="#D9AB33", alpha = 0.3)+
   geom_line(aes(x = x_seq.zema, y = y_model.zema_g_sigmoidal), color = '#D9AB33', size=1.5)+
  # geom_point(data= GExdata.midd %>% filter(Species == "Zema"), aes(x= F.wp.leaf, y=gsw.area), color = 'red', size = 4, alpha = 0.3)+
   geom_vline(xintercept = zema_g_sig$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
#  ggtitle("Z. mays")+
  ylab(expression(paste("g"[sw], " (mol m"^{-2}~"s"^{-1}*")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,0.65)

Zema_GEx_g
```


#Kleaf - fit curve

```{r}

#AVSA -----------
Kleaf_avsa<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "AVSA")
Kleaf_avsa$`Lowest Psileaf` <- as.numeric(Kleaf_avsa$`Lowest Psileaf`)*-1
Kleaf_avsa$`Kleaf Tcorr` <- as.numeric(Kleaf_avsa$`Kleaf Tcorr`)
Kleaf_avsa$Kleaf_relative <- Kleaf_avsa$`Kleaf Tcorr`/max(Kleaf_avsa$`Kleaf Tcorr`,na.rm=TRUE)*100

#HOVU--------

Kleaf_hovu<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "HOVU") %>% dplyr::select(-`...27`)
Kleaf_hovu$`Lowest Psileaf` <- as.numeric(Kleaf_hovu$`Lowest Psileaf`)*-1
Kleaf_hovu$`Kleaf Tcorr` <- as.numeric(Kleaf_hovu$`Kleaf Tcorr`)
Kleaf_hovu$Kleaf_relative <- Kleaf_hovu$`Kleaf Tcorr`/max(Kleaf_hovu$`Kleaf Tcorr`,na.rm=TRUE)*100

#TRAE -------------
Kleaf_trae<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "TRAE")
Kleaf_trae$`Lowest Psileaf` <- as.numeric(Kleaf_trae$`Lowest Psileaf`)*-1
Kleaf_trae$`Kleaf Tcorr` <- as.numeric(Kleaf_trae$`Kleaf Tcorr`)
Kleaf_trae$Kleaf_relative <- Kleaf_trae$`Kleaf Tcorr`/max(Kleaf_trae$`Kleaf Tcorr`,na.rm=TRUE)*100


#PEGL ---------
Kleaf_pegl<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "PEGL")
Kleaf_pegl$`Lowest Psileaf` <- as.numeric(Kleaf_pegl$`Lowest Psileaf`)*-1
Kleaf_pegl$`Kleaf Tcorr` <- as.numeric(Kleaf_pegl$`Kleaf Tcorr`)
Kleaf_pegl$Kleaf_relative <- Kleaf_pegl$`Kleaf Tcorr`/max(Kleaf_pegl$`Kleaf Tcorr`,na.rm=TRUE)*100

#CHGA----------
Kleaf_chga<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "CHGA")
Kleaf_chga$`Lowest Psileaf` <- as.numeric(Kleaf_chga$`Lowest Psileaf`)*-1
Kleaf_chga$`Kleaf Tcorr` <- as.numeric(Kleaf_chga$`Kleaf Tcorr`)
Kleaf_chga$Kleaf_relative <- Kleaf_chga$`Kleaf Tcorr`/max(Kleaf_chga$`Kleaf Tcorr`,na.rm=TRUE)*100

#ZEMA----------
Kleaf_zema<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "ZEMA")
Kleaf_zema$`Lowest Psileaf` <- as.numeric(Kleaf_zema$`Lowest Psileaf`)*-1
Kleaf_zema$`Kleaf Tcorr` <- as.numeric(Kleaf_zema$`Kleaf Tcorr`)
Kleaf_zema$Kleaf_relative <- Kleaf_zema$`Kleaf Tcorr`/max(Kleaf_zema$`Kleaf Tcorr`,na.rm=TRUE)*100

Kleaf <- rbind(Kleaf_avsa, Kleaf_hovu, Kleaf_trae, Kleaf_pegl, Kleaf_zema, Kleaf_chga)


Kleaf_curve <- Kleaf %>%
  mutate(psi_neg =  `Lowest Psileaf`*(-1)) %>%
  dplyr::select(Species, psi_neg, `Kleaf Tcorr` ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs = `Kleaf Tcorr`) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
 # mutate(psi =  psi*(-1)) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = Kleaf_curve, file = "../results/Kleaf/Kleaf_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017 for FvFm" and "R function MB 2017 for FvFm"


```

## AVSA - Plot Kleaf
```{r}
avsa_K <-   read.csv("../results/Kleaf/model_fitting_results.csv") %>% #best model log
  filter(Species == 'AVSA') %>%
  filter(model == 'Logistic')

x_seq.avsa.kleaf <- seq(-2, 0.1, by=0.01)
x_seq.avsa.kleaf

# Correct the sign of the inflection point
 C <- -avsa_K$C
 B <- avsa_K$B
 A <- avsa_K$A

# Recalculate the model
y_model.avsa_Kleaf <- A/(1+((x_seq.avsa.kleaf/C)^B))

Avsa_kleaf<-ggplot()+
  geom_point(data=Kleaf_avsa,aes(x=`Lowest Psileaf`,y=`Kleaf Tcorr`),size=5,color="#6DB9F8", alpha = 0.3)+
   geom_line(aes(x = x_seq.avsa.kleaf, y = y_model.avsa_Kleaf), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept = avsa_K$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
 #  ggtitle("A. sativa")+
   ylab(expression(atop(K[leaf], "(mmol" ~ m^{-2} ~ s^{-1} ~ MPa^{-1}*")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,60)
 
Avsa_kleaf


```
  
##HOVU - Plot Kleaf
```{r}
hovu_K <- read.csv("../results/Kleaf/model_fitting_results.csv") %>% #best model exp2
  filter(Species == 'HOVU') %>%
  filter(model == 'Exponential2')

x_seq.hovu.kleaf <- seq(0.1, 2, by=0.01)
x_seq.hovu.kleaf

# Recalculate the model
y_model.hovu_Kleaf <-  hovu_K$C+hovu_K$A*exp(-hovu_K$B*x_seq.hovu.kleaf)



Hovu_kleaf<-ggplot()+
  geom_point(data=Kleaf_hovu,aes(x=`Lowest Psileaf`,y=`Kleaf Tcorr`),size=5,color="#6DB9F8", alpha = 0.3)+
   geom_line(aes(x = (-1)*x_seq.hovu.kleaf, y = y_model.hovu_Kleaf), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept = hovu_K$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  ylab(expression(paste("K"[leaf], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,60)
 
Hovu_kleaf
```


##TRAE - Plot Kleaf

```{r}
trae_K <-   read.csv("../results/Kleaf/model_fitting_results.csv") %>% #best model exp
  filter(Species == 'TRAE') %>%
  filter(model == 'Exponential')

x_seq.trae.kleaf <-seq(-2, 0.1, by=0.01)
x_seq.trae.kleaf

# Correct the sign of the inflection point
 B <- trae_K$B
 A <- trae_K$A

# Recalculate the model
y_model.trae_Kleaf <- A * exp(B*x_seq.trae.kleaf)

 
Trae_kleaf<-ggplot()+
  geom_point(data=Kleaf_trae,aes(x=`Lowest Psileaf`,y=`Kleaf Tcorr`),size=5,color="#6DB9F8", alpha = 0.3)+
   geom_line(aes(x = x_seq.trae.kleaf, y = y_model.trae_Kleaf), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept = trae_K$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  ylab(expression(paste("K"[leaf], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,60)
 
Trae_kleaf

```


##CHGA - Plot Kleaf

```{r}
 
chga_K <-   read.csv("../results/Kleaf/model_fitting_results.csv") %>% #best model exp
  filter(Species == 'CHGA') %>%
  filter(model == 'Logistic')

x_seq.chga.kleaf <- seq(-2, 0.1, by=0.01)
x_seq.chga.kleaf

# Correct the sign of the inflection point
C <- -chga_K$C
B  <- chga_K$B
A <- chga_K$A

# Recalculate the model
y_model.chga_Kleaf <- A/(1+((x_seq.chga.kleaf/C)^B))


Chga_kleaf<-ggplot()+
  geom_point(data=Kleaf_chga,aes(x=`Lowest Psileaf`,y=`Kleaf Tcorr`),size=5,color="#D9AB33", alpha = 0.3)+
   geom_line(aes(x = x_seq.chga.kleaf, y = y_model.chga_Kleaf), color = '#D9AB33', size=1.5)+
   geom_vline(xintercept = chga_K$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  ylab(expression(paste("K"[leaf], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,60)
 
Chga_kleaf
```


##PEGL - Plot Kleaf

```{r}
pegl_K <-   read.csv("../results/Kleaf/model_fitting_results.csv") %>% #best model exp
  filter(Species == 'PEGL') %>%
  filter(model == 'Logistic')

x_seq.pegl.kleaf <- seq(-2, 0.1, by=0.01)
x_seq.pegl.kleaf

# Correct the sign of the inflection point
 C <- -pegl_K$C
 B <- pegl_K$B
 A <- pegl_K$A

# Recalculate the model
y_model.pegl_Kleaf <- A/(1+((x_seq.pegl.kleaf/C)^B))


Pegl_kleaf<-ggplot()+
  geom_point(data=Kleaf_pegl,aes(x=`Lowest Psileaf`,y=`Kleaf Tcorr`),size=5,color="#D9AB33", alpha = 0.3)+
   geom_line(aes(x = x_seq.pegl.kleaf, y = y_model.pegl_Kleaf), color = '#D9AB33', size=1.5)+
   geom_vline(xintercept = pegl_K$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  ylab(expression(paste("K"[leaf], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,60)
 
Pegl_kleaf
```


##ZEMA - Plot Kleaf

```{r}
zema_K <-     read.csv("../results/Kleaf/model_fitting_results.csv") %>% #best model exp
  filter(Species == 'ZEMA') %>%
  filter(model == 'Logistic')

x_seq.zema.kleaf <- seq(-2, 0.1, by=0.01)
x_seq.zema.kleaf

# Correct the sign of the inflection point
 C <- -zema_K$C
 B <- zema_K$B
 A <- zema_K$A

# Recalculate the model
y_model.zema_Kleaf <- A/(1+((x_seq.zema.kleaf/C)^B))


Zema_kleaf<-ggplot()+
  geom_point(data=Kleaf_zema,aes(x=`Lowest Psileaf`,y=`Kleaf Tcorr`),size=5,color="#D9AB33", alpha = 0.3)+
   geom_line(aes(x = x_seq.zema.kleaf, y = y_model.zema_Kleaf), color = '#D9AB33', size=1.5)+
   geom_vline(xintercept = zema_K$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
#  ggtitle("Z. mays")+
  ylab(expression(paste("K"[leaf], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,60)
 
Zema_kleaf
```


#Kplant - fit curve
```{r}
#AVSA -----------
Kplant_avsa<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21Aout25.xlsx", sheet = "AVSA")
Kplant_avsa$`psi Licor (Mpa)` <- as.numeric(Kplant_avsa$`psi Licor (Mpa)`)*-1
Kplant_avsa$Kplant <- as.numeric(Kplant_avsa$Kplant)
Kplant_avsa$Species <- 'AVSA'

Kplant_avsa <- Kplant_avsa %>% dplyr::select(`psi Licor (Mpa)`, Kplant, Species)

#HOVU--------

Kplant_hovu<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21aout25.xlsx", sheet = "HOVU")
Kplant_hovu$`psi Licor (Mpa)` <- as.numeric(Kplant_hovu$`psi Licor (Mpa)`)*-1
Kplant_hovu$Kplant <- as.numeric(Kplant_hovu$Kplant)
Kplant_hovu$Species <- 'HOVU'

Kplant_hovu <- Kplant_hovu%>% dplyr::select(`psi Licor (Mpa)`, Kplant, Species)

#TRAE -------------
Kplant_trae<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21aout25.xlsx", sheet = "TRAE")
Kplant_trae$`psi Licor (Mpa)` <- as.numeric(Kplant_trae$`psi Licor (Mpa)`)*-1
Kplant_trae$Kplant <- as.numeric(Kplant_trae$Kplant)
Kplant_trae$Species <- 'TRAE'

Kplant_trae <- Kplant_trae %>% dplyr::select(`psi Licor (Mpa)`, Kplant, Species)

#PEGL ---------
Kplant_pegl<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21aout25.xlsx", sheet = "PEGL")
Kplant_pegl$`psi Licor (Mpa)` <- as.numeric(Kplant_pegl$`psi Licor (Mpa)`)*-1
Kplant_pegl$Kplant <- as.numeric(Kplant_pegl$Kplant)
Kplant_pegl$Species <- 'PEGL'

Kplant_pegl <- Kplant_pegl %>% dplyr::select(`psi Licor (Mpa)`, Kplant, Species)

#CHGA----------
Kplant_chga<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21aout25.xlsx", sheet = "CHGA")
Kplant_chga$`psi Licor (Mpa)` <- as.numeric(Kplant_chga$`psi Licor (Mpa)`)*-1
Kplant_chga$Kplant <- as.numeric(Kplant_chga$Kplant)
Kplant_chga$Species <- 'CHGA'

Kplant_chga <- Kplant_chga %>% dplyr::select(`psi Licor (Mpa)`, Kplant, Species)

#ZEMA----------
Kplant_zema<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21aout25.xlsx", sheet = "ZEMA")
Kplant_zema$`psi Licor (Mpa)` <- as.numeric(Kplant_zema$`psi Licor (Mpa)`)*-1
Kplant_zema$Kplant <- as.numeric(Kplant_zema$Kplant)
Kplant_zema$Species <- 'ZEMA'

Kplant_zema <- Kplant_zema %>% dplyr::select(`psi Licor (Mpa)`, Kplant, Species)

Kplant <- rbind(Kplant_avsa, Kplant_hovu, Kplant_trae, Kplant_pegl, Kplant_zema, Kplant_chga)


Kplant_curve <- Kplant %>%
  mutate(psi_neg =  `psi Licor (Mpa)`*(-1)) %>%
  dplyr::select(Species, psi_neg, Kplant ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs = Kplant) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
 # mutate(psi =  psi*(-1)) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = Kplant_curve, file = "../results/KplantKroots_results/Kplant/Kplant_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017 for FvFm" and "R function MB 2017 for FvFm"

```

## AVSA - Plot Kplant
```{r}
avsa_Kplant_summary <-read.csv("../results/KplantKroots_results/Kplant/model_fitting_results.csv") %>% #best model exp
  filter(Species == 'AVSA') %>%
  filter(model == 'Exponential')

data_Kplant_avsa <-  read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21aout25.xlsx", 
    sheet = "AVSA", col_types = c("skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "numeric", "numeric")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.avsa.kplant <- seq(0.1, 2, by=0.01)

# Compute Kplant values using the equation - exponential
y.model.Kplant.avsa <- avsa_Kplant_summary$A  * exp(-avsa_Kplant_summary$B* x_seq.avsa.kplant)
y.model.Kplant.avsa

#plot
Avsa_kplant<- ggplot()+
 geom_point(data=data_Kplant_avsa,aes(x=(-1)*`psi Licor (Mpa)`,y=Kplant*10^3),size=5,color="#6DB9F8", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.avsa.kplant, y = y.model.Kplant.avsa*10^3), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept =avsa_Kplant_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
 #  ggtitle("A. sativa")+
   ylab(expression(atop(K[plant], "(mmol" ~ m^{-2} ~ s^{-1} ~ MPa^{-1}*")")))+
  xlab(expression(paste(Psi["plant"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,25)
 
Avsa_kplant
```

## HOVU - Plot Kplant
```{r}
hovu_Kplant_summary <-  read.csv("../results/KplantKroots_results/Kplant/model_fitting_results.csv") %>% #best model log
  filter(Species == 'HOVU') %>%
  filter(model == 'Sigmoidal')

data_Kplant_hovu <- read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "HOVU", col_types = c("skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "numeric", "numeric")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.hovu.kplant <-  seq(0.1, 2, by=0.01)
x_seq.hovu.kplant

# Correct the sign of the inflection point
C<- hovu_Kplant_summary$C
B <- hovu_Kplant_summary$B
A <- hovu_Kplant_summary$A

# model
y.model.Kplant.hovu <-  A  / (1 + exp(-((x_seq.hovu.kplant - C) / B)))


#plot
hovu_kplant<- ggplot()+
 geom_point(data=data_Kplant_hovu,aes(x=(-1)*`psi Licor (Mpa)`,y=Kplant*10^3),size=5,color="#6DB9F8", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.hovu.kplant, y = y.model.Kplant.hovu*10^3), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept =hovu_Kplant_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  # ggtitle("H. vulgare")+
  xlab(expression(paste(Psi["plant"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,25)
 
hovu_kplant
```

## TRAE - Plot Kplant
```{r}
trae_Kplant_summary <-  read.csv("../results/KplantKroots_results/Kplant/model_fitting_results.csv") %>% #best model
  filter(Species == 'TRAE') %>%
  filter(model == 'Sigmoidal')

data_Kplant_trae <- read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "TRAE", col_types = c("skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "numeric", "numeric")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.trae.kplant <-  seq(0.1, 2, by=0.01)
x_seq.trae.kplant

# Correct the sign of the inflection point
C <- trae_Kplant_summary$C
B<- trae_Kplant_summary$B
A <- trae_Kplant_summary$A

# Recalculate the model
y.model.Kplant.trae <- A / (1 + exp(-((x_seq.trae.kplant - C) / B)))
 
#plot
trae_kplant<- ggplot()+
 geom_point(data=data_Kplant_trae,aes(x=(-1)*`psi Licor (Mpa)`,y=Kplant*10^3),size=5,color="#6DB9F8", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.trae.kplant, y = y.model.Kplant.trae*10^3), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept =trae_Kplant_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  xlab(expression(paste(Psi["plant"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,25)
 
trae_kplant
```

## CHGA - Plot Kplant
```{r}
chga_Kplant_summary <-  read.csv("../results/KplantKroots_results/Kplant/model_fitting_results.csv") %>% #best model
  filter(Species == 'CHGA') %>%
  filter(model == 'Exponential')

data_Kplant_chga <-  read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "CHGA", col_types = c("skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "numeric", "numeric")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.chga.kplant <-  seq(0.1, 2, by=0.01)
x_seq.chga.kplant


# Compute Kplant values using the equation - exponential
y.model.Kplant.chga <- chga_Kplant_summary$A  * exp(-chga_Kplant_summary$B* x_seq.chga.kplant)

y.model.Kplant.chga


#plot
chga_kplant<- ggplot()+
 geom_point(data=data_Kplant_chga,aes(x=(-1)*`psi Licor (Mpa)`,y=Kplant*10^3),size=5,color="#D9AB33", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.chga.kplant, y = y.model.Kplant.chga*10^3), color = '#D9AB33', size=1.5)+
   geom_vline(xintercept =chga_Kplant_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
#  ggtitle("C. gayan")+
   ylab(expression(paste("K"[plant], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["plant"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,25)
 
chga_kplant
```

## PEGL - Plot Kplant
```{r}
pegl_Kplant_summary <-  read.csv("../results/KplantKroots_results/Kplant/model_fitting_results.csv") %>% #best model
  filter(Species == 'PEGL') %>%
  filter(model == 'Exponential')

data_Kplant_pegl <-  read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "PEGL", col_types = c("skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "numeric", "numeric")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.pegl.kplant <-  seq(0.1, 2, by=0.01)
x_seq.pegl.kplant

# Compute Kplant values using the equation - exponential
y.model.Kplant.pegl <- pegl_Kplant_summary$A * exp(-pegl_Kplant_summary$B* x_seq.pegl.kplant)
y.model.Kplant.pegl

#plot 
pegl_kplant<- ggplot()+
 geom_point(data=data_Kplant_pegl,aes(x=(-1)*`psi Licor (Mpa)`,y=Kplant*10^3),size=5,color="#D9AB33",alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.pegl.kplant, y = y.model.Kplant.pegl*10^3), color = '#D9AB33', size=1.5)+
   geom_vline(xintercept =pegl_Kplant_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   #ggtitle("P. glaucum")+
  xlab(expression(paste(Psi["plant"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,25)
 
pegl_kplant
```

## ZEMA - Plot Kplant
```{r}
zema_Kplant_summary <-    read.csv("../results/KplantKroots_results/Kplant/model_fitting_results.csv") %>% #best model
  filter(Species == 'ZEMA') %>%
  filter(model == 'Linear')

data_Kplant_zema <-  read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "ZEMA", col_types = c("skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "numeric", "numeric")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.zema.kplant <-  seq(0.1, 2, by=0.01)
x_seq.zema.kplant

# Compute Kplant values using the equation - exp
y.model.Kplant.zema <- zema_Kplant_summary$A  + zema_Kplant_summary$B* x_seq.zema.kplant
y.model.Kplant.zema


#plot 
zema_kplant<- ggplot()+
 geom_point(data=data_Kplant_zema,aes(x=(-1)*`psi Licor (Mpa)`,y=Kplant*10^3),size=5,color="#D9AB33", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.zema.kplant, y = y.model.Kplant.zema*10^3), color = '#D9AB33', size=1.5)+
   geom_vline(xintercept =zema_Kplant_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  # ggtitle("Z. mays")+
  xlab(expression(paste(Psi["plant"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,25)

zema_kplant
```

#Kroot - fit curve
```{r}
#AVSA -----------
Kroot_avsa<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21Aout25.xlsx", sheet = "AVSA")
Kroot_avsa$`psi roots` <- as.numeric(Kroot_avsa$`psi roots`)*-1
Kroot_avsa$Kroot <- as.numeric(Kroot_avsa$Kroot)
Kroot_avsa$Species <- 'AVSA'

Kroot_avsa <- Kroot_avsa %>% dplyr::select(Species, `psi roots`, Kroot ) 

#HOVU--------

Kroot_hovu<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21Aout25.xlsx", sheet = "HOVU")
Kroot_hovu$`psi roots` <- as.numeric(Kroot_hovu$`psi roots`)*-1
Kroot_hovu$Kroot <- as.numeric(Kroot_hovu$Kroot)
Kroot_hovu$Species <- 'HOVU'

Kroot_hovu <- Kroot_hovu %>% dplyr::select(Species, `psi roots`, Kroot )

#TRAE -------------
Kroot_trae<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21Aout25.xlsx", sheet = "TRAE")
Kroot_trae$`psi roots` <- as.numeric(Kroot_trae$`psi roots`)*-1
Kroot_trae$Kroot <- as.numeric(Kroot_trae$Kroot)
Kroot_trae$Species <- 'TRAE'


Kroot_trae <- Kroot_trae %>% dplyr::select(Species, `psi roots`, Kroot )

#PEGL ---------
Kroot_pegl<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21Aout25.xlsx", sheet = "PEGL")
Kroot_pegl$`psi roots` <- as.numeric(Kroot_pegl$`psi roots`)*-1
Kroot_pegl$Kroot <- as.numeric(Kroot_pegl$Kroot)
Kroot_pegl$Species <- 'PEGL'


Kroot_pegl <- Kroot_pegl %>% dplyr::select(Species, `psi roots`, Kroot )

#CHGA----------
Kroot_chga<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21Aout25.xlsx", sheet = "CHGA")
Kroot_chga$`psi roots` <- as.numeric(Kroot_chga$`psi roots`)*-1
Kroot_chga$Kroot <- as.numeric(Kroot_chga$Kroot)
Kroot_chga$Species <- 'CHGA'


Kroot_chga <- Kroot_chga %>% dplyr::select(Species, `psi roots`, Kroot )

#ZEMA----------
Kroot_zema<-read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs21Aout25.xlsx", sheet = "ZEMA")
Kroot_zema$`psi roots` <- as.numeric(Kroot_zema$`psi roots`)*-1
Kroot_zema$Kroot <- as.numeric(Kroot_zema$Kroot)
Kroot_zema$Species <- 'ZEMA'


Kroot_zema <- Kroot_zema %>% dplyr::select(Species, `psi roots`, Kroot )

Kroot <- rbind(Kroot_avsa, Kroot_hovu, Kroot_trae, Kroot_pegl, Kroot_zema, Kroot_chga)


Kroot_curve <- Kroot %>%
  mutate(psi_neg =  `psi roots`*(-1)) %>%
  dplyr::select(Species, psi_neg, Kroot ) %>%
  dplyr::rename(psi = psi_neg) %>%
  dplyr::rename(gs = Kroot) %>% #for the script by Megan
  dplyr::rename(species = Species) %>%
 # mutate(psi =  psi*(-1)) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = Kroot_curve, file = "../results/KplantKroots_results/Kroot/Kroot_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017 for FvFm" and "R function MB 2017 for FvFm"

```

## AVSA - Plot Kroot
```{r}
avsa_Kroot_summary <-   read.csv("../results/KplantKroots_results/Kroot/model_fitting_results.csv") %>% #best model
  filter(Species == 'AVSA') %>%
  filter(model == 'Logistic')

data_Kroot_avsa <-  read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "AVSA", col_types = c("numeric", 
        "numeric", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.avsa.kroot <-  seq(0.1, 2, by=0.01)
x_seq.avsa.kroot

# Compute Kroot values using the equation - exponential
y.model.Kroot.avsa <- avsa_Kroot_summary$A / (1+ ((x_seq.avsa.kroot / avsa_Kroot_summary$C)^avsa_Kroot_summary$B))
y.model.Kroot.avsa

#Plot
Avsa_kroot<- ggplot()+
 geom_point(data=data_Kroot_avsa,aes(x=(-1)*`psi roots`,y=Kroot*10^3),size=5,color="#6DB9F8", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.avsa.kroot, y = y.model.Kroot.avsa*10^3), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept =avsa_Kroot_summary$P50_0.1kmax*(-1), linetype =2)+
 theme_minimal()+
theme(axis.title.y=element_text(size=14),
axis.text.y=element_text(size=13),
axis.title.x=element_blank(),
axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
legend.title=element_text(),
title = element_text(size=13, face = "bold.italic"))+
  ggtitle("A. sativa")+
  ylab(expression(atop(K[root], "(mmol" ~ m^{-2} ~ s^{-1} ~ MPa^{-1}*")")))+
  xlab(expression(paste(Psi["root"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,155)
Avsa_kroot
```

## HOVU - Plot Kroot
```{r}
hovu_Kroot_summary <-   read.csv("../results/KplantKroots_results/Kroot/model_fitting_results.csv") %>% #best model
  filter(Species == 'HOVU') %>%
  filter(model == 'Exponential')

data_Kroot_hovu <-   read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "HOVU", col_types = c("numeric", 
        "numeric", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.hovu.kroot <-  seq(0.1, 2, by=0.01)
x_seq.hovu.kroot

# Compute Kroot values using the equation - exponential
y.model.Kroot.hovu <- hovu_Kroot_summary$A  * exp(-hovu_Kroot_summary$B* x_seq.hovu.kroot)
y.model.Kroot.hovu

#plot

hovu_kroot<- ggplot()+
 geom_point(data=data_Kroot_hovu,aes(x=(-1)*`psi roots`,y=Kroot*10^3),size=5,color="#6DB9F8", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.hovu.kroot, y = y.model.Kroot.hovu*10^3), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept =hovu_Kroot_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   ggtitle("H. vulgare")+
  ylab(expression(paste("K"[root], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["root"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,155)
 
hovu_kroot
```

## TRAE - Plot Kroot
```{r}
trae_Kroot_summary <-   read.csv("../results/KplantKroots_results/Kroot/model_fitting_results.csv") %>% #best model
  filter(Species == 'TRAE') %>%
  filter(model == 'Exponential2')

data_Kroot_trae <-  read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "TRAE", col_types = c("numeric", 
        "numeric", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.trae.kroot <-  seq(0.1, 2, by=0.01)
x_seq.trae.kroot


# Compute Kroot values using the equation - exp2
y.model.Kroot.trae <- trae_Kroot_summary$C + trae_Kroot_summary$A  * exp(-trae_Kroot_summary$B* x_seq.trae.kroot)
  

#plot
trae_kroot<- ggplot()+
 geom_point(data=data_Kroot_trae,aes(x=(-1)*`psi roots`,y=Kroot*10^3),size=5,color="#6DB9F8", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.trae.kroot, y = y.model.Kroot.trae*10^3), color = '#6DB9F8', size=1.5)+
   geom_vline(xintercept =trae_Kroot_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
   theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  ggtitle("T. aestivum")+
  ylab(expression(paste("K"[root], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["root"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,155)
 
trae_kroot
```

## CHGA - Plot Kroot
```{r}
chga_Kroot_summary <-   read.csv("../results/KplantKroots_results/Kroot/model_fitting_results.csv") %>% #best model
  filter(Species == 'CHGA') %>%
  filter(model == 'Exponential')

data_Kroot_chga <-  read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "CHGA", col_types = c("numeric", 
        "numeric", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.chga.kroot <-  seq(0.1, 2, by=0.01)
x_seq.chga.kroot

# Compute Kroot values using the equation - exponential 
y.model.Kroot.chga <- chga_Kroot_summary$A  * exp(-chga_Kroot_summary$B* x_seq.chga.kroot)
y.model.Kroot.chga

#plot
chga_kroot<- ggplot()+
  geom_point(data=data_Kroot_chga,aes(x=(-1)*`psi roots`,y=Kroot*10^3),size=5,color="#D9AB33", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.chga.kroot, y = y.model.Kroot.chga*10^3), color = '#D9AB33', size=1.5)+
  geom_vline(xintercept =chga_Kroot_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size = 13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   ggtitle("C. gayana")+
   ylab(expression(paste("K"[root], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["root"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,155)
 
chga_kroot
```

## PEGL - Plot Kroot
```{r}
pegl_Kroot_summary <-   read.csv("../results/KplantKroots_results/Kroot/model_fitting_results.csv") %>% #best model
  filter(Species == 'PEGL') %>%
  filter(model == 'Exponential')

data_Kroot_pegl <-  read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "PEGL", col_types = c("numeric", 
        "numeric", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip"))  %>% na.omit()

x_seq.pegl.kroot <-  seq(0.1, 2, by=0.01)
x_seq.pegl.kroot

# Compute Kroot values using the equation -exp
y.model.Kroot.pegl <- pegl_Kroot_summary$A  * exp(-pegl_Kroot_summary$B* x_seq.pegl.kroot)
  

#plot

pegl_kroot<- ggplot()+
 geom_point(data=data_Kroot_pegl,aes(x=(-1)*`psi roots`,y=Kroot*10^3),size=5,color="#D9AB33", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.pegl.kroot, y = y.model.Kroot.pegl*10^3), color = '#D9AB33', size=1.5)+
   geom_vline(xintercept =pegl_Kroot_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
   theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
         axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   ggtitle("P. glaucum")+
   ylab(expression(paste("K"[root], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["root"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,155)
 
pegl_kroot
```

## ZEMA - Plot Kroot
```{r}
zema_Kroot_summary <-   read.csv("../results/KplantKroots_results/Kroot/model_fitting_results.csv") %>% #best model
  filter(Species == 'ZEMA') %>%
  filter(model == 'Exponential')

data_Kroot_zema <-  read_excel("../data/Kroot_Kplants_no_outlier_MB2juin2025_Cs12Aout25.xlsx", 
    sheet = "ZEMA", col_types = c("numeric", 
        "numeric", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip")) 
#%>%   mutate(`psi Licor (Mpa)` = -1 * `psi Licor (Mpa)`)

x_seq.zema.kroot <-  seq(0.1, 2, by=0.01)
x_seq.zema.kroot

# Compute Kroot values using the equation - exponential
y.model.Kroot.zema <- zema_Kroot_summary$A  * exp(-zema_Kroot_summary$B* x_seq.zema.kroot)
y.model.Kroot.zema

#plot
zema_kroot<- ggplot()+
 geom_point(data=data_Kroot_zema,aes(x=(-1)*`psi roots`,y=Kroot*10^3),size=5,color="#D9AB33", alpha = 0.3)+
  geom_line(aes(x =(-1)*x_seq.zema.kroot, y = y.model.Kroot.zema*10^3), color = '#D9AB33', size=1.5)+
   geom_vline(xintercept =zema_Kroot_summary$P50_0.1kmax*(-1), linetype =2)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
  ggtitle("Z. mays")+
   ylab(expression(paste("K"[root], " (mmol "*m^{-2}*" "*s^{-1}*" "*MPa^{-1},")")))+
  xlab(expression(paste(Psi["root"]," (MPa)")))+
  xlim(0,-1.6)+
  ylim(0,155)
 
zema_kroot
```

#All plots together - Figure 1

## Assimilation
```{r}

Figure_A <- ggarrange(Avsa_GEx_A, Hovu_GEx_A, Trae_GEx_A, Chga_GEx_A, Pegl_GEx_A, Zema_GEx_A,  ncol =6, nrow = 1)

Figure_A
```

## Stomatal conductance
```{r}

Figure_g <- ggarrange(Avsa_GEx_g, Hovu_GEx_g, Trae_GEx_g, Chga_GEx_g, Pegl_GEx_g, Zema_GEx_g,  ncol =6, nrow = 1)

Figure_g
```


# Kleaf
```{r}

Figure_Kleaf <- ggarrange(Avsa_kleaf, Hovu_kleaf, Trae_kleaf, Chga_kleaf, Pegl_kleaf, Zema_kleaf, ncol =6, nrow = 1)

Figure_Kleaf
```

# Kplant
```{r}

Figure_kplant <-  ggarrange(Avsa_kplant, hovu_kplant, trae_kplant, chga_kplant, pegl_kplant, zema_kplant, ncol =6, nrow = 1)

Figure_kplant
```

# Kroot
```{r}

Figure_kroot <- ggarrange(Avsa_kroot, hovu_kroot, trae_kroot, chga_kroot, pegl_kroot, zema_kroot, ncol =6, nrow = 1)

Figure_kroot
```

## Figure 1 -together
```{r}
Figure1 <- ggarrange(Figure_kroot,Figure_Kleaf, Figure_kplant,Figure_g, Figure_A, ncol = 1, nrow = 5)
Figure1

ggsave(filename = "../results/Figure1.jpg", plot = Figure1, width = 12, height = 10)
```

#///////Figure 2

#Function

Getting r from sqrt(R2) is only valid for simple linear regressions. So, for Gaussian, do this:
1- Define the null model: assuming the trait (WUEi) is just a constant (the mean)
2-Take my model: the fitted Gaussian curve with 3 parameters (alpha, mu, sigma)
3-Compare the likelihoods of each model: *how likely the observed data are under the null model vs. how likely they are under the Gaussian model*
4-Likelihood ratio: take the difference in log-likelihoods (full vs. null), multiply by 2. A big ratio : Gaussian explains the data much better than just the mean.
4-p-value: Compare LR to a chi-square distribution with degrees of freedom equal to the difference in number of parameters (3  1 = 2).

```{r}
# Function to test significance of R simple regression
pval_from_R2_regression <- function(R2, n) {
  r <- sqrt(R2)                   # correlation from R
  tval <- r * sqrt((n - 2) / (1 - r^2))  # test statistic
  df <- n - 2                     # degrees of freedom
  pval <- 2 * pt(-abs(tval), df)  # two-sided p-value
  return(list(r = r, t = tval, df = df, pval = pval))
}

# Function to test significance of R using chi-square (LRT style) - For Gaussian
pval_from_R2_gaussian <- function(R2, n, k_full = 3, k_null = 1) {
  # Likelihood ratio statistic from R
  LR <- - (n * log(1 - R2))   # approx log-likelihood ratio
  LR <- 2 * LR                # standard LR test statistic, transforme la diffrence de log-vraisemblances en statistique de test .
  
  # Degrees of freedom = parameters in full - parameters in null
  df <- k_full - k_null
  
  # p-value from chi-square distribution
  pval <- pchisq(LR, df = df, lower.tail = FALSE)
  
  return(list(LR = LR, df = df, pval = pval))
}
```

#WUE - fit curves
```{r}
WUE <- GExdata.dehy %>%
  mutate(psi_neg =  `Psileaf from RWC`*(-1)) %>%
  dplyr::select(Species, `psi_neg`,  WUEi ) %>%
  filter(WUEi >0) %>%
  dplyr::rename(psi = `psi_neg`) %>%
  dplyr::rename(gs =  `WUEi`) %>% #for the script 
  dplyr::rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

write.csv(x = WUE, file = "../results/WUE/WUE_curve.csv")
```

##AVSA - plot WUE
```{r}
data_W_avsa <- GExdata.dehy %>% 
  filter(Species == "Avsa") %>%
  dplyr::select(Species, Metabolism, WUEi, `Psileaf from RWC`) %>%
  filter(WUEi >0)

avsa_W<-  read.csv("../results/WUE/model_fitting_results.csv") %>% 
  filter(Species == 'Avsa') 

x_seq.avsa_W <- seq(0.1, 2, by=0.01)
x_seq.avsa_W


avsa_W$rsq

pval_from_R2_gaussian(R2 = avsa_W$rsq, n = length(data_W_avsa$`Psileaf from RWC`))
pval_from_R2_regression(R2 = avsa_W$rsq, n = length(data_W_avsa$`Psileaf from RWC`))

#it's like an anova actually
# Observed data
y <- data_W_avsa$WUEi
psi <- data_W_avsa$`Psileaf from RWC`

# Nonlinear Gaussian fit
full_model <- nls(y ~ a * exp(-(psi - mu)^2 / (2 * sigma^2)),
  start = list(a = max(y),mu = mean(psi),sigma = 1),control = nls.control(maxiter = 1000, warnOnly = TRUE))
null_model <- nls(y ~ m,start = list(m = mean(y)))
anova(full_model, null_model, test= "LRT")
anova(full_model, null_model, test= "Chisq")



# Recalculate the model
y_model.avsa_W <- avsa_W$a * exp(-(x_seq.avsa_W - avsa_W$mu)^2 / (2 * avsa_W$sigma^2))

avsa_W_plot<-ggplot()+
 geom_point(data=data_W_avsa,aes(x=`Psileaf from RWC`,y=WUEi),size=5,color="#56B4E9", alpha = 0.7)+
 geom_line(aes(x = x_seq.avsa_W *(-1), y = y_model.avsa_W), color = '#56B4E9', size=3)+
  geom_vline(xintercept = avsa_W$mu*(-1), linetype = 2, linewidth = 1.5)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   ggtitle("A. sativa")+
   annotate("text", x = -2, y =200, label = "italic(R)^2 == 0.37", size = 5, parse= T)+
  annotate("text", x = -2, y =170, label = "italic(P) < 0.001", size = 5, parse =T)+
   ylab(expression(paste("WUE"[i])))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-3)+
  ylim(0,252)
  
avsa_W_plot
```

##HOVU - plot WUE
```{r}
data_W_hovu <- GExdata.dehy %>% 
  filter(Species == "Hovu") %>%
  dplyr::select(Species, Metabolism, WUEi, `Psileaf from RWC`)%>%
  filter(WUEi >0)

hovu_W<-  read.csv("../results/WUE/model_fitting_results.csv") %>% 
  filter(Species == 'Hovu') 

x_seq.hovu_W <- seq(0.1, 2, by=0.01)
x_seq.hovu_W

hovu_W$rsq

pval_from_R2_gaussian(R2 = hovu_W$rsq, n = length(data_W_hovu$`Psileaf from RWC`))
pval_from_R2_regression(R2 = hovu_W$rsq, n = length(data_W_hovu$`Psileaf from RWC`))

# Recalculate the model
y_model.hovu_W <- hovu_W$a * exp(-(x_seq.hovu_W - hovu_W$mu)^2 / (2 * hovu_W$sigma^2))

hovu_W_plot<-ggplot()+
 geom_point(data=data_W_hovu,aes(x=`Psileaf from RWC`,y=WUEi),size=5,color="#56B4E9", alpha = 0.7)+
 geom_line(aes(x = x_seq.hovu_W *(-1), y = y_model.hovu_W), color = '#56B4E9', size=3)+
  geom_vline(xintercept = hovu_W$mu*(-1), linetype = 2, linewidth = 1.5)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   ggtitle("H. vulgare")+
  annotate("text", x = -2, y =200, label = "italic(R)^2 == 0.21", size = 5, parse =T)+
   annotate("text", x = -2, y =170, label = "italic(P) < 0.001", size = 5, parse =T)+
   ylab(expression(paste("WUE"[i])))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-3)+
  ylim(0,252)
hovu_W_plot
```

##TRAE - plot WUE
```{r}
data_W_trae <- GExdata.dehy %>% 
  filter(Species == "Trae") %>%
  dplyr::select(Species, Metabolism, WUEi, `Psileaf from RWC`)%>%
  filter(WUEi >0)

trae_W<-  read.csv("../results/WUE/model_fitting_results.csv") %>% 
  filter(Species == 'Trae') 

x_seq.trae_W <- seq(0.1, 2, by=0.01)
x_seq.trae_W

trae_W$rsq

pval_from_R2_gaussian(R2 = trae_W$rsq, n = length(data_W_trae$`Psileaf from RWC`))
pval_from_R2_regression(R2 = trae_W$rsq, n = length(data_W_trae$`Psileaf from RWC`))

# Recalculate the model
y_model.trae_W <- trae_W$a * exp(-(x_seq.trae_W - trae_W$mu)^2 / (2 * trae_W$sigma^2))

trae_W_plot<-ggplot()+
 geom_point(data=data_W_trae,aes(x=`Psileaf from RWC`,y=WUEi),size=5,color="#56B4E9", alpha = 0.7)+
 geom_line(aes(x = x_seq.trae_W *(-1), y = y_model.trae_W), color = '#56B4E9', size=2)+
  geom_vline(xintercept = trae_W$mu*(-1), linetype = 2, linewidth = 1.5)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   ggtitle("T. aestivum")+
  annotate("text", x = -2, y =200, label = "italic(R)^2 == 0.16", size = 5, parse =T)+
   annotate("text", x = -2, y =170, label = "italic(P) < 0.01", size = 5, parse =T)+
   ylab(expression(paste("WUE"[i])))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-3)+
  ylim(0,252)
trae_W_plot
```

##CHGA - plot WUE

```{r}
data_W_chga <- GExdata.dehy %>% 
  filter(Species == "Chga") %>%
  dplyr::select(Species, Metabolism, WUEi, `Psileaf from RWC`)%>%
  filter(WUEi >0)

chga_W<-  read.csv("../results/WUE/model_fitting_results.csv") %>% 
  filter(Species == 'Chga') 

x_seq.chga_W <- seq(0.1, 2, by=0.01)
x_seq.chga_W

chga_W$rsq

pval_from_R2_gaussian(R2 = chga_W$rsq, n = length(data_W_chga$`Psileaf from RWC`))
pval_from_R2_regression(R2 = chga_W$rsq, n = length(data_W_chga$`Psileaf from RWC`))

# Recalculate the model
y_model.chga_W <- chga_W$a * exp(-(x_seq.chga_W - chga_W$mu)^2 / (2 * chga_W$sigma^2))

chga_W_plot<-ggplot()+
 geom_point(data=data_W_chga,aes(x=`Psileaf from RWC`,y=WUEi),size=5,color="#E69F00", alpha = 0.7)+
 geom_line(aes(x = x_seq.chga_W *(-1), y = y_model.chga_W), color = '#E69F00', size=2)+
  geom_vline(xintercept = chga_W$mu*(-1), linetype = 2, linewidth = 1.5)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   ggtitle("C. gayana")+
  annotate("text", x = -2, y =200, label = "italic(R)^2 == 0.61", size = 5, parse =T)+
   annotate("text", x = -2, y =170, label = "italic(P) < 0.001", size = 5,parse =T)+
   ylab(expression(paste("WUE"[i])))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-3)+
  ylim(0,252)

chga_W_plot
```

##PEGL - plot WUE
```{r}
data_W_pegl <- GExdata.dehy %>% 
  filter(Species == "Pegl") %>%
  dplyr::select(Species, Metabolism, WUEi, `Psileaf from RWC`)%>%
  filter(WUEi >0)

pegl_W<-  read.csv("../results/WUE/model_fitting_results.csv") %>% 
  filter(Species == 'Pegl') 

x_seq.pegl_W <- seq(0.1, 2, by=0.01)
x_seq.pegl_W

pegl_W$rsq
pval_from_R2_gaussian(R2 = pegl_W$rsq, n = length(data_W_pegl$`Psileaf from RWC`))
pval_from_R2_regression(R2 = pegl_W$rsq, n = length(data_W_pegl$`Psileaf from RWC`))

# Recalculate the model
y_model.pegl_W <- pegl_W$a * exp(-(x_seq.pegl_W - pegl_W$mu)^2 / (2 * pegl_W$sigma^2))

pegl_W_plot<-ggplot()+
 geom_point(data=data_W_pegl,aes(x=`Psileaf from RWC`,y=WUEi),size=5,color="#E69F00", alpha = 0.7)+
 geom_line(aes(x = x_seq.pegl_W *(-1), y = y_model.pegl_W), color = '#E69F00', size=2)+
  geom_vline(xintercept = pegl_W$mu*(-1), linetype = 2, linewidth = 1.5)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   ggtitle("P. glaucum")+
  annotate("text", x = -2, y =200, label = "italic(R)^2 == 0.53", size = 5, parse =T)+
  annotate("text", x = -2, y =170, label = "italic(P) < 0.001", size = 5, parse =T)+
   ylab(expression(paste("WUE"[i])))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-3)+
  ylim(0,252)
pegl_W_plot
```

##ZEMA - plot WUE
```{r}
data_W_zema <- GExdata.dehy %>% 
  filter(Species == "Zema") %>%
  dplyr::select(Species, Metabolism, WUEi, `Psileaf from RWC`)%>%
  filter(WUEi >0)

zema_W<-  read.csv("../results/WUE/model_fitting_results.csv") %>% 
  filter(Species == 'Zema') 

x_seq.zema_W <- seq(0.1, 2, by=0.01)
x_seq.zema_W

zema_W$rsq
pval_from_R2_gaussian(R2 = zema_W$rsq, n = length(data_W_zema$`Psileaf from RWC`))
pval_from_R2_regression(R2 = zema_W$rsq, n = length(data_W_zema$`Psileaf from RWC`))

# Recalculate the model
y_model.zema_W <- zema_W$a * exp(-(x_seq.zema_W - zema_W$mu)^2 / (2 * zema_W$sigma^2))

zema_W_plot<-ggplot()+
 geom_point(data=data_W_zema,aes(x=`Psileaf from RWC`,y=WUEi),size=5,color="#E69F00", alpha = 0.7)+
 geom_line(aes(x = x_seq.zema_W *(-1), y = y_model.zema_W), color = '#E69F00', size=2)+
  geom_vline(xintercept = zema_W$mu*(-1), linetype = 2, linewidth = 1.5)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=13),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13),
        legend.title=element_text(),
        title = element_text(size=13, face = "bold.italic"))+
   ggtitle("Z. mays")+
  annotate("text", x = -2, y =200, label = "italic(R)^2 == 0.22", size = 5, parse =T)+
  annotate("text", x = -2, y =170, label = "italic(P) < 0.05", size = 5, parse =T)+
   ylab(expression(paste("WUE"[i])))+
  xlab(expression(paste(Psi["leaf"]," (MPa)")))+
  xlim(0,-3)+
  ylim(0,252)

zema_W_plot
```

##all WUE plots
```{r}
WUE <- ggarrange(avsa_W_plot, chga_W_plot, hovu_W_plot, pegl_W_plot, trae_W_plot,  zema_W_plot, ncol = 2, nrow = 3, labels = c("A", "B", "C", "D", "E", "F"))
WUE
ggsave(filename = "../results/Figure2.jpg", plot = WUE, width = 9, height = 9)
```

#////////////Figure 3 
##CFD - FVFM dehydration

T for initial, fully hydrated or turgid -- STAGE 1
F for after dehydration or fresh -- STAGE 2
R for Rehydration -- STAGE 3
D for dry -- STAGE 4

```{r}
SRCdata = read.csv("../data/SRCdata.csv",header=TRUE)

SRCdata_dehydration <- SRCdata %>% dplyr::select(Species, Metabolism, F.RWC,F.FvFm)


# data per species, FvFm ####
SRCdata_dehydration$F.RWC <- as.numeric(SRCdata_dehydration$F.RWC)
SRCdata_dehydration$F.FvFm <- as.numeric(SRCdata_dehydration$F.FvFm)

SRCdata_dehydration$CFD <- SRCdata_dehydration$F.FvFm


#format for fitting for Megan's script for RWC
FVFM_dehydration_curve <- SRCdata_dehydration %>%
  dplyr::select(Species, F.RWC , CFD ) %>%
  dplyr::rename(species = Species) %>%
  drop_na()

#models
###comapring models directly
m_CFD<-drm(CFD~F.RWC,species,data=FVFM_dehydration_curve,fct=LN.4())
summary(m_CFD)

mselect(m_CFD, list(LL.3(), LL.4(), LL.5(), W1.3(), W1.4(), W2.3(), W2.4(), LN.3(), LN.4(), EXD.2(), EXD.3()), linreg = TRUE) #species separated but for linear it is comparing against a pooled linear model always

#best AIC 
m1_CFD<-drm(CFD~F.RWC,species,data=FVFM_dehydration_curve,fct=LL.3())
ED50_m1_CFD<- ED(m1_CFD,50)

#data per species
data.avsa <- FVFM_dehydration_curve %>% filter(species =="Avsa")
data.hovu <- FVFM_dehydration_curve %>% filter(species =="Hovu")
data.trae <- FVFM_dehydration_curve %>% filter(species =="Trae")
data.chga <- FVFM_dehydration_curve %>% filter(species =="Chga")
data.pegl <- FVFM_dehydration_curve %>% filter(species =="Pegl")
data.zema <- FVFM_dehydration_curve %>% filter(species =="Zema")

newdata<-expand.grid(F.RWC=seq(0,100,length=101)) ######### this is to plot the confidence intervals
m1.avsa<-drm(CFD~F.RWC,data=data.avsa,fct=LL.3())
summary(m1.avsa)
pm.avsa<-predict(m1.avsa,newdata=newdata,interval="confidence")
newdata$p.avsa<-pm.avsa[,1]
newdata$pmin.avsa<-pm.avsa[,2]
newdata$pmax.avsa<-pm.avsa[,3]

m1.hovu<-drm(CFD~F.RWC,data=data.hovu,fct=LL.3())
pm.hovu<-predict(m1.hovu,newdata=newdata,interval="confidence")
newdata$p.hovu<-pm.hovu[,1]
newdata$pmin.hovu<-pm.hovu[,2]
newdata$pmax.hovu<-pm.hovu[,3]

m1.trae<-drm(CFD~F.RWC,data=data.trae,fct=LL.3())
pm.trae<-predict(m1.trae,newdata=newdata,interval="confidence")
newdata$p.trae<-pm.trae[,1]
newdata$pmin.trae<-pm.trae[,2]
newdata$pmax.trae<-pm.trae[,3]

m1.chga<-drm(CFD~F.RWC,data=data.chga,fct=LL.3())
pm.chga<-predict(m1.chga,newdata=newdata,interval="confidence")
newdata$p.chga<-pm.chga[,1]
newdata$pmin.chga<-pm.chga[,2]
newdata$pmax.chga<-pm.chga[,3]

m1.pegl<-drm(CFD~F.RWC,data=data.pegl,fct=LL.3())
pm.pegl<-predict(m1.pegl,newdata=newdata,interval="confidence")
newdata$p.pegl<-pm.pegl[,1]
newdata$pmin.pegl<-pm.pegl[,2]
newdata$pmax.pegl<-pm.pegl[,3]


m1.zema<-drm(CFD~F.RWC,data=data.zema,fct=LL.3())
pm.zema<-predict(m1.zema,newdata=newdata,interval="confidence")
newdata$p.zema<-pm.zema[,1]
newdata$pmin.zema<-pm.zema[,2]
newdata$pmax.zema<-pm.zema[,3]

ED(m1.avsa,50,interval="delta") ################# retrieving the curve parameters for each species 
ED(m1.hovu,50,interval="delta")
ED(m1.trae,50,interval="delta")
ED(m1.chga,50,interval="delta")
ED(m1.pegl,50,interval="delta")
ED(m1.zema,50,interval="delta")

#compare
ED50.avsa<- ED(m1.avsa,50)[1]
ED50.hovu<- ED(m1.hovu,50)[1]
ED50.trae<- ED(m1.trae,50)[1]
ED50.chga<- ED(m1.chga,50)[1]
ED50.pegl<- ED(m1.pegl,50)[1]
ED50.zema<- ED(m1.zema,50)[1]

#save as csv
ED50_CFD <- data.frame(
  Trait = c("CFD", "CFD", "CFD", "CFD", "CFD", "CFD"),
  Species = c("Avsa", "Hovu", "Trae", "Chga", "Pegl", "Zema"),
  Metabolism = c("C3", "C3", "C3", "C4", "C4", "C4"),
  ED50 = c(ED50.avsa, ED50.hovu, ED50.trae, ED50.chga, ED50.pegl, ED50.zema))

ED50_CFD
write.csv(ED50_CFD, "../results/ED50_CFD.csv", row.names = FALSE)

#for plotting
newdata.avsa <- newdata %>% mutate(species = "Avsa")
newdata.trae <- newdata %>% mutate(species = "Trae")
newdata.hovu <- newdata %>% mutate(species = "Hovu")
newdata.pegl <- newdata %>% mutate(species = "Pegl")
newdata.chga <- newdata %>% mutate(species = "Chga")
newdata.zema <- newdata %>% mutate(species = "Zema")


# Plot
mycols <- c(
  "Avsa"="#6DB9F8",
  "Hovu"="#002F6C",
  "Trae"="#CFEAFF",
  "Pegl"="#E08C1F",
  "Chga"="#8A5F00",
  "Zema"="#F2D06A"
)

CFD <- ggplot(FVFM_dehydration_curve,aes(x=F.RWC,y=CFD))+
  geom_abline(slope=0,intercept=0,colour="grey")+
  geom_vline(xintercept=100,colour="grey")+
  geom_vline(xintercept=0,colour="grey")+
  geom_point(aes(fill = species), size = 2, alpha = 0.9, shape = 21,show.legend = FALSE) +
scale_fill_manual(values = mycols)+
  scale_color_manual(values = mycols)+
   ####################### ploting confidence intervals +
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.avsa,ymin=pmin.avsa,ymax=pmax.avsa),alpha=0.3,fill="grey")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.trae,ymin=pmin.trae,ymax=pmax.trae),alpha=0.3,fill="grey")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.hovu,ymin=pmin.hovu,ymax=pmax.hovu),alpha=0.3,fill="grey")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.pegl,ymin=pmin.pegl,ymax=pmax.pegl),alpha=0.3,fill="#F2D06A")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.chga,ymin=pmin.chga,ymax=pmax.chga),alpha=0.3,fill="#F2D06A")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.zema,ymin=pmin.zema,ymax=pmax.zema),alpha=0.3,fill="#F2D06A")+
 geom_line(data=newdata.avsa, aes(x=F.RWC, y=p.avsa, color = species), size = 2)+
  geom_line(data=newdata.trae, aes(x=F.RWC, y=p.trae, color=species), size=2)+
  geom_line(data=newdata.hovu, aes(x=F.RWC, y=p.hovu, color=species), size=2)+
  geom_line(data=newdata.pegl, aes(x=F.RWC, y=p.pegl, color=species), size=2)+
  geom_line(data=newdata.chga, aes(x=F.RWC, y=p.chga, color=species), size=2)+
 geom_line(data=newdata.zema, aes(x=F.RWC, y=p.zema, color=species), size=2)+
   geom_vline(xintercept=ED50.avsa,color=mycols["Avsa"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.trae,color=mycols["Trae"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.hovu,color=mycols["Hovu"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.pegl,color=mycols["Pegl"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.chga,color=mycols["Chga"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.zema,color=mycols["Zema"],lty=5, linewidth = 1)+
  xlim(0,100)+
  theme_minimal()+
  theme(panel.grid.minor=element_blank(),
        #panel.grid.major=element_blank(),
        axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=14),
        axis.title.x=element_blank(),
        axis.text.x=element_text(size=14),
        legend.title = element_text(size = 14),
        legend.text=element_text(size=14, face="italic"))+
  xlab(expression(paste("RWC (%)")))+
  ylab(expression(F[v]/F[m]))+
  labs(color = "Species", fill = "Species")+
  ylim(0,1)

CFD
```



##CFR - FVFM recovery

T for initial, fully hydrated or turgid -- STAGE 1
F for after dehydration or fresh -- STAGE 2
R for Rehydration -- STAGE 3
D for dry -- STAGE 4

```{r}
SRCdata = read.csv("../data/SRCdata.csv",header=TRUE)

SRCdata_recovery <- SRCdata %>% dplyr::select(Species, Metabolism, F.RWC,R.FvFm, T.FvFm)


# data per species, FvFm ####
SRCdata_recovery$F.RWC <- as.numeric(SRCdata_recovery$F.RWC)
SRCdata_recovery$T.FvFm <- as.numeric(SRCdata_recovery$T.FvFm)
SRCdata_recovery$R.FvFm <- as.numeric(SRCdata_recovery$R.FvFm)

SRCdata_recovery$CFR <- SRCdata_recovery$R.FvFm


#format for fitting for Megan's script for RWC
FVFM_recovery_curve <- SRCdata_recovery %>%
  dplyr::select(Species, F.RWC , CFR ) %>%
  dplyr::rename(species = Species) %>%
  drop_na()

#models
###comapring models directly
m_CFR<-drm(CFR~F.RWC,species,data=FVFM_recovery_curve,fct=LN.4())
summary(m_CFR)

mselect(m_CFR, list(LL.3(), LL.4(), LL.5(), W1.3(), W1.4(), W2.3(), W2.4(), LN.3(), LN.4(), EXD.2(), EXD.3()), linreg = TRUE) #species separated but for linear it is comparing against a pooled linear model always

#best AIC 
m1_CFR<-drm(CFR~F.RWC,species,data=FVFM_recovery_curve,fct=LL.4())
ED50_m1_CFR<- ED(m1_CFR,50)

#second best AIC 
m2_CFR<-drm(CFR~F.RWC,species,data=FVFM_recovery_curve,fct=W2.4())
ED50_m2_CFR<- ED(m2_CFR,50)

#third best AIC 
m3_CFR<-drm(CFR~F.RWC,species,data=FVFM_recovery_curve,fct=LN.4())
ED50_m3_CFR<- ED(m3_CFR,50)

#fourth best AIC 
m4_CFR<-drm(CFR~F.RWC,species,data=FVFM_recovery_curve,fct=LL.5())
ED50_m4_CFR<- ED(m4_CFR,50)

#problem for zema cannot compute a meaningful ED50 for Zema
m_Zema <- drm(CFR ~ F.RWC, data = subset(FVFM_recovery_curve, species=="Zema"), fct = LL.3 ())
#mselect(m_Zema_LL4, list(LL.3(), LL.4(), LL.5(), W1.3(), W1.4(), W2.3(), W2.4(), LN.3(), LN.4(), EXD.2(), EXD.3()), linreg = TRUE)
ED50_zema<- ED(m_Zema,50)

#data per species
data.avsa_CFR <- FVFM_recovery_curve %>% filter(species =="Avsa")
data.hovu_CFR<- FVFM_recovery_curve %>% filter(species =="Hovu")
data.trae_CFR <- FVFM_recovery_curve %>% filter(species =="Trae")
data.chga_CFR <- FVFM_recovery_curve %>% filter(species =="Chga")
data.pegl_CFR <- FVFM_recovery_curve %>% filter(species =="Pegl")
data.zema_CFR <- FVFM_recovery_curve %>% filter(species =="Zema")

newdata_CFR<-expand.grid(F.RWC=seq(0,100,length=101)) ######### this is to plot the confidence intervals
m1.avsa_CFR<-drm(CFR~F.RWC,data=data.avsa_CFR,fct=LL.4())
summary(m1.avsa_CFR)
pm.avsa_CFR<-predict(m1.avsa_CFR,newdata=newdata_CFR,interval="confidence")
newdata_CFR$p.avsa<-pm.avsa_CFR[,1]
newdata_CFR$pmin.avsa<-pm.avsa_CFR[,2]
newdata_CFR$pmax.avsa<-pm.avsa_CFR[,3]

m1.hovu_CFR<-drm(CFR~F.RWC,data=data.hovu_CFR,fct=LL.4())
pm.hovu_CFR<-predict(m1.hovu_CFR,newdata=newdata_CFR,interval="confidence")
newdata_CFR$p.hovu<-pm.hovu_CFR[,1]
newdata_CFR$pmin.hovu<-pm.hovu_CFR[,2]
newdata_CFR$pmax.hovu<-pm.hovu_CFR[,3]

m1.trae_CFR<-drm(CFR~F.RWC,data=data.trae_CFR,fct=LL.4())
pm.trae_CFR<-predict(m1.trae_CFR,newdata=newdata_CFR,interval="confidence")
newdata_CFR$p.trae<-pm.trae_CFR[,1]
newdata_CFR$pmin.trae<-pm.trae_CFR[,2]
newdata_CFR$pmax.trae<-pm.trae_CFR[,3]

m1.chga_CFR<-drm(CFR~F.RWC,data=data.chga_CFR,fct=LL.4())
pm.chga_CFR<-predict(m1.chga_CFR,newdata=newdata_CFR,interval="confidence")
newdata_CFR$p.chga<-pm.chga_CFR[,1]
newdata_CFR$pmin.chga<-pm.chga_CFR[,2]
newdata_CFR$pmax.chga<-pm.chga_CFR[,3]

m1.pegl_CFR<-drm(CFR~F.RWC,data=data.pegl_CFR,fct=LL.4())
pm.pegl_CFR<-predict(m1.pegl_CFR,newdata=newdata_CFR,interval="confidence")
newdata_CFR$p.pegl<-pm.pegl_CFR[,1]
newdata_CFR$pmin.pegl<-pm.pegl_CFR[,2]
newdata_CFR$pmax.pegl<-pm.pegl_CFR[,3]

ED(m1.avsa_CFR,50,interval="delta") ################# retrieving the curve parameters for each species 
ED(m1.hovu_CFR,50,interval="delta")
ED(m1.trae_CFR,50,interval="delta")
ED(m1.chga_CFR,50,interval="delta")
ED(m1.pegl_CFR,50,interval="delta")

#compare
ED50.avsa_CFR<- ED(m1.avsa_CFR,50)[1]
ED50.hovu_CFR<- ED(m1.hovu_CFR,50)[1]
ED50.trae_CFR<- ED(m1.trae_CFR,50)[1]
ED50.chga_CFR<- ED(m1.chga_CFR,50)[1]
ED50.pegl_CFR<- ED(m1.pegl_CFR,50)[1]

#save as csv
ED50_CFR <- data.frame(
  Trait = c("CFR", "CFR", "CFR", "CFR", "CFR", "CFR"),
  Species = c("Avsa", "Hovu", "Trae", "Chga", "Pegl", "Zema"),
  Metabolism = c("C3", "C3", "C3", "C4", "C4", "C4"),
  ED50 = c(ED50.avsa_CFR, ED50.hovu_CFR, ED50.trae_CFR, ED50.chga_CFR, ED50.pegl_CFR, NA))

ED50_CFR
write.csv(ED50_CFR, "../results/ED50_CFR.csv", row.names = FALSE)

#for plotting
FVFM_recovery_curve <- FVFM_recovery_curve %>%
  mutate(
    species = recode(species,
      "Zema" = "Z. mays",
      "Chga" = "C. gayana",
      "Pegl" = "P. glaucum",
      "Avsa" = "A. sativa",
      "Hovu" = "H. vulgare",
      "Trae" = "T. aestivum"
    )
  )

#for plotting
newdata.avsa_CFR <- newdata.avsa_CFR %>% mutate(species = "A. sativa")
newdata.trae_CFR <- newdata.trae_CFR %>% mutate(species = "T. aestivum")
newdata.hovu_CFR <- newdata.hovu_CFR%>% mutate(species = "H. vulgare")
newdata.pegl_CFR <- newdata.pegl_CFR %>% mutate(species = "P. glaucum")
newdata.chga_CFR <- newdata.chga_CFR  %>% mutate(species = "C. gayana")
newdata.zema_CFR <- newdata.zema_CFR %>% mutate(species = "Z. mays")

# Plot
mycols <- c(
  "A. sativa"="#6DB9F8",
  "H. vulgare"="#002F6C",
  "T. aestivum"="#CFEAFF",
  "P. glaucum"="#E08C1F",
  "C. gayana"="#8A5F00",
  "Z. mays"="#F2D06A"
)



CFR <- ggplot(FVFM_recovery_curve,aes(x=F.RWC,y=CFR))+
  geom_abline(slope=0,intercept=0,colour="grey")+
  geom_vline(xintercept=100,colour="grey")+
  geom_vline(xintercept=0,colour="grey")+
  geom_point(aes(fill = species), size = 2, alpha = 0.9, shape = 21,show.legend = FALSE) +
scale_fill_manual(values = mycols)+
  scale_color_manual(values = mycols)+
   ####################### ploting confidence intervals +
  geom_ribbon(data=newdata_CFR,aes(x=F.RWC,y=p.avsa,ymin=pmin.avsa,ymax=pmax.avsa),alpha=0.3,fill="grey")+
  geom_ribbon(data=newdata_CFR,aes(x=F.RWC,y=p.trae,ymin=pmin.trae,ymax=pmax.trae),alpha=0.3,fill="grey")+
  geom_ribbon(data=newdata_CFR,aes(x=F.RWC,y=p.hovu,ymin=pmin.hovu,ymax=pmax.hovu),alpha=0.3,fill="grey")+
  geom_ribbon(data=newdata_CFR,aes(x=F.RWC,y=p.pegl,ymin=pmin.pegl,ymax=pmax.pegl),alpha=0.3,fill="#F2D06A")+
  geom_ribbon(data=newdata_CFR,aes(x=F.RWC,y=p.chga,ymin=pmin.chga,ymax=pmax.chga),alpha=0.3,fill="#F2D06A")+
 # geom_ribbon(data=newdata,aes(x=F.RWC,y=p.zema,ymin=pmin.zema,ymax=pmax.zema),alpha=0.3,fill="#F2D06A")+
 geom_line(data=newdata.avsa_CFR, aes(x=F.RWC, y=p.avsa, color = species), size = 2)+
  geom_line(data=newdata.trae_CFR, aes(x=F.RWC, y=p.trae, color=species), size=2)+
  geom_line(data=newdata.hovu_CFR, aes(x=F.RWC, y=p.hovu, color=species), size=2)+
  geom_line(data=newdata.pegl_CFR, aes(x=F.RWC, y=p.pegl, color=species), size=2)+
  geom_line(data=newdata.chga_CFR, aes(x=F.RWC, y=p.chga, color=species), size=2)+
 # geom_line(data=newdata.zema, aes(x=F.RWC, y=p.zema, color=species), size=2)+
   geom_vline(xintercept=ED50.avsa_CFR,color=mycols["A. sativa"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.trae_CFR,color=mycols["T. aestivum"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.hovu_CFR,color=mycols["H. vulgare"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.pegl_CFR,color=mycols["P. glaucum"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.chga_CFR,color=mycols["C. gayana"],lty=5, linewidth = 1)+
 #  geom_vline(xintercept=ED50.zema,color=mycols["Zema"],lty=5, linewidth = 1)+
  xlim(0,100)+
  theme_minimal()+
 theme(panel.grid.minor=element_blank(),
        #panel.grid.major=element_blank(),
        axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size= 14),
        axis.text.x=element_text(size=14),
       legend.title = element_text(size = 14),
        legend.text=element_text(size=14, face="italic"))+
  xlab(expression(paste("RWC (%)")))+
  ylab(expression(F[v]/F[m]))+
  labs(color = "Species", fill = "Species")+
  ylim(0,1)


CFR

ggsave(filename = "../results/FigureSI_CFR.jpg", plot = CFR,  width = 8, height = 6)

```



##CFD/CFR - SI
```{r}
SRCdata = read.csv("../data/SRCdata.csv",header=TRUE)

# Plot
mycols <- c(
  "A. sativa"   = "#6DB9F8",
  "H. vulgare"  = "#002F6C",
  "T. aestivum" = "#CFEAFF",
  "P. glaucum"  = "#E08C1F",
  "C. gayana"   = "#8A5F00",
  "Z. mays"     = "#F2D06A")

SRCdata <- SRCdata %>%
  mutate(
    Species = recode(Species,
      "Zema" = "Z. mays",
      "Chga" = "C. gayana",
      "Pegl" = "P. glaucum",
      "Avsa" = "A. sativa",
      "Hovu" = "H. vulgare",
      "Trae" = "T. aestivum"))

SRCdata$Species <- factor(
  SRCdata$Species,
  levels = c(
    "A. sativa",
    "H. vulgare",
    "T. aestivum",
    "C. gayana",
    "P. glaucum",
    "Z. mays"))

FigureSI <- ggplot(data = SRCdata, aes(x = F.FvFm, y = R.FvFm, color = Species)) +
  geom_abline(intercept = 0, slope = 1, colour = "darkgrey") +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_vline(xintercept = 0, color = "darkgrey") +
  geom_point(size = 3, alpha = 0.8) +
  geom_smooth(se = FALSE, linewidth = 1) +
  scale_color_manual(values = mycols) +
  scale_y_continuous(limits = c(-0.25, 0.8),
                     breaks = c(0, 0.25, 0.5, 0.75)) +
  scale_x_continuous(limits = c(0, 0.8),
                     breaks = c(0, 0.25, 0.5, 0.7)) +
  facet_wrap(~Species, ncol = 3) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    strip.background = element_rect(fill = "white", color = NA),
    axis.title.y = element_text(size = 13),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 13),
    axis.text.x = element_text(size = 12),
    strip.text = element_text(size = 13, face = "italic"),
    legend.position = "none") +
  ylab(expression(paste("rehydration F"[v], "/F"[m]))) +
  xlab(expression(paste("dehydration F"[v], "/F"[m])))


ggsave(filename = "../results/FigureSI.jpg", plot = FigureSI,  width = 8, height = 8)
```



##PLRC
```{r}

#################Rehydration capacity
SRCdata = read.csv("../data/SRCdata.csv",header=TRUE)

SRCdata_RC <- SRCdata %>% select(Species, Metabolism, F.RWC,PLRC) 

# data per species, FvFm, PLRC ####
SRCdata_RC$F.RWC <- as.numeric(SRCdata_RC$F.RWC)
SRCdata_RC$PLRC <- as.numeric(SRCdata_RC$PLRC)

#format for fitting for Megan's script
PLRC_curve <- SRCdata_RC %>%
  dplyr::select(Species, `F.RWC`, PLRC) %>%
  rename(species = Species) %>%
 # mutate(`data type` = 1) %>%
 # relocate(`data type` , .after = species )%>%
  drop_na() %>%
  filter(PLRC > 0)

#write.csv(x = PLRC_curve, file = "../results/PLRC/PLRC_curve.csv") #ready for fitting with RWC
```

Model selection was based on the information criterion and parameter stability. Although the W2.4 model yielded the lowest AIC, it produced biologically unrealistic ED50 values and extremely large standard errors for several species, indicating overfitting and parameter instability. Therefore, this model was excluded.

Among the remaining models, LN.4 also failed to provide stable estimates for Zema (very large SE), while LL.4 yielded consistent and biologically coherent parameter estimates across all species and had an AIC within AIC < 2 of the minimum. We therefore selected LL.4 as the most appropriate and robust model.
```{r}

###comapring models directly
m<-drm(PLRC~F.RWC,species,data=PLRC_curve,fct=LN.4())
summary(m)

mselect(m, list(LL.3(), LL.4(), LL.5(), W1.3(), W1.4(), W2.3(), W2.4(), LN.3(), LN.4(), EXD.2(), EXD.3()), linreg = TRUE) #species separated but for linear it is comparing against a pooled linear model always

#best AIC W2.4 but unstable
m1<-drm(PLRC~F.RWC,species,data=PLRC_curve,fct=W2.4())
ED50_m1<- ED(m1,50)

#second best AIC but still unstable
m2<-drm(PLRC~F.RWC,species,data=PLRC_curve,fct=LN.4())
ED50_m2<- ED(m2,50)

#third best AIC and within AIC score +/-2
m3<-drm(PLRC~F.RWC,species,data=PLRC_curve,fct=LL.4())
ED50_m3<- ED(m3,50)


#data per species
data.avsa <- PLRC_curve %>% filter(species =="Avsa")
data.hovu <- PLRC_curve %>% filter(species =="Hovu")
data.trae <- PLRC_curve %>% filter(species =="Trae")
data.chga <- PLRC_curve %>% filter(species =="Chga")
data.pegl <- PLRC_curve %>% filter(species =="Pegl")
data.zema <- PLRC_curve %>% filter(species =="Zema")

newdata<-expand.grid(F.RWC=seq(0,100,length=101)) ######### this is to plot the confidence intervals
m1.avsa<-drm(PLRC~F.RWC,data=data.avsa,fct=LL.4())
summary(m1.avsa)
pm.avsa<-predict(m1.avsa,newdata=newdata,interval="confidence")
newdata$p.avsa<-pm.avsa[,1]
newdata$pmin.avsa<-pm.avsa[,2]
newdata$pmax.avsa<-pm.avsa[,3]

m1.hovu<-drm(PLRC~F.RWC,data=data.hovu,fct=LL.4())
pm.hovu<-predict(m1.hovu,newdata=newdata,interval="confidence")
newdata$p.hovu<-pm.hovu[,1]
newdata$pmin.hovu<-pm.hovu[,2]
newdata$pmax.hovu<-pm.hovu[,3]

m1.trae<-drm(PLRC~F.RWC,data=data.trae,fct=LL.4())
pm.trae<-predict(m1.trae,newdata=newdata,interval="confidence")
newdata$p.trae<-pm.trae[,1]
newdata$pmin.trae<-pm.trae[,2]
newdata$pmax.trae<-pm.trae[,3]

m1.chga<-drm(PLRC~F.RWC,data=data.chga,fct=LL.4())
pm.chga<-predict(m1.chga,newdata=newdata,interval="confidence")
newdata$p.chga<-pm.chga[,1]
newdata$pmin.chga<-pm.chga[,2]
newdata$pmax.chga<-pm.chga[,3]

m1.pegl<-drm(PLRC~F.RWC,data=data.pegl,fct=LL.4())
pm.pegl<-predict(m1.pegl,newdata=newdata,interval="confidence")
newdata$p.pegl<-pm.pegl[,1]
newdata$pmin.pegl<-pm.pegl[,2]
newdata$pmax.pegl<-pm.pegl[,3]

m1.zema<-drm(PLRC~F.RWC,data=data.zema,fct=LL.4())
#mselect(m1.zema, list(LL.3(), LL.4(), LL.5(), W1.3(), W1.4(), W2.3(), W2.4(), LN.3(), EXD.2(), EXD.3()), linreg = TRUE)
pm.zema<-predict(m1.zema,newdata=newdata,interval="confidence")
newdata$p.zema<-pm.zema[,1]
newdata$pmin.zema<-pm.zema[,2]
newdata$pmax.zema<-pm.zema[,3]


ED(m1.avsa,50,interval="delta") ################# retrieving the curve parameters for each species 
ED(m1.hovu,50,interval="delta")
ED(m1.trae,50,interval="delta")
ED(m1.chga,50,interval="delta")
ED(m1.pegl,50,interval="delta")
ED(m1.zema,50,interval="delta")

#compare
ED50.avsa<- ED(m1.avsa,50)[1]
ED50.hovu<- ED(m1.hovu,50)[1]
ED50.trae<- ED(m1.trae,50)[1]
ED50.chga<- ED(m1.chga,50)[1]
ED50.pegl<- ED(m1.pegl,50)[1]
ED50.zema<- ED(m1.zema,50)[1]

#save as csv
ED50_PLRC <- data.frame(
  Trait = c("PLRC", "PLRC", "PLRC", "PLRC", "PLRC", "PLRC"),
  Species = c("Avsa", "Hovu", "Trae", "Chga", "Pegl", "Zema"),
  Metabolism = c("C3", "C3", "C3", "C4", "C4", "C4"),
  ED50 = c(ED50.avsa, ED50.hovu, ED50.trae, ED50.chga, ED50.pegl, ED50.zema))

ED50_PLRC
write.csv(ED50_PLRC, "../results/ED50_PLRC.csv", row.names = FALSE)


#for plotting
newdata.avsa <- newdata %>% mutate(species = "A. sativa")
newdata.trae <- newdata %>% mutate(species = "T. aestivum")
newdata.hovu <- newdata %>% mutate(species = "H. vulgare")
newdata.pegl <- newdata %>% mutate(species = "P. glaucum")
newdata.chga <- newdata %>% mutate(species = "C. gayana")
newdata.zema <- newdata %>% mutate(species = "Z. mays")


# Plot
mycols <- c(
  "A. sativa"   = "#6DB9F8",
  "H. vulgare"  = "#002F6C",
  "T. aestivum" = "#CFEAFF",
  "P. glaucum"  = "#E08C1F",
  "C. gayana"   = "#8A5F00",
  "Z. mays"     = "#F2D06A"
)

PLRC_curve <- PLRC_curve %>%
  mutate(
    species = recode(species,
      "Zema" = "Z. mays",
      "Chga" = "C. gayana",
      "Pegl" = "P. glaucum",
      "Avsa" = "A. sativa",
      "Hovu" = "H. vulgare",
      "Trae" = "T. aestivum"
    )
  )

PLRC <- ggplot(PLRC_curve,aes(x=F.RWC,y=PLRC))+
  geom_abline(slope=0,intercept=0,colour="grey")+
  geom_vline(xintercept=100,colour="grey")+
  geom_vline(xintercept=0,colour="grey")+
  geom_point(aes(fill = species), size = 2, alpha = 0.9, shape = 21,show.legend = FALSE) +
scale_fill_manual(values = mycols)+
  scale_color_manual(values = mycols)+
   ####################### ploting confidence intervals +
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.avsa,ymin=pmin.avsa,ymax=pmax.avsa),alpha=0.3,fill="grey")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.trae,ymin=pmin.trae,ymax=pmax.trae),alpha=0.3,fill="grey")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.hovu,ymin=pmin.hovu,ymax=pmax.hovu),alpha=0.3,fill="grey")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.pegl,ymin=pmin.pegl,ymax=pmax.pegl),alpha=0.3,fill="#F2D06A")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.chga,ymin=pmin.chga,ymax=pmax.chga),alpha=0.3,fill="#F2D06A")+
  geom_ribbon(data=newdata,aes(x=F.RWC,y=p.zema,ymin=pmin.zema,ymax=pmax.zema),alpha=0.3,fill="#F2D06A")+
 geom_line(data=newdata.avsa, aes(x=F.RWC, y=p.avsa, color = species), size = 2)+
  geom_line(data=newdata.trae, aes(x=F.RWC, y=p.trae, color=species), size=2)+
  geom_line(data=newdata.hovu, aes(x=F.RWC, y=p.hovu, color=species), size=2)+
  geom_line(data=newdata.pegl, aes(x=F.RWC, y=p.pegl, color=species), size=2)+
  geom_line(data=newdata.chga, aes(x=F.RWC, y=p.chga, color=species), size=2)+
  geom_line(data=newdata.zema, aes(x=F.RWC, y=p.zema, color=species), size=2)+
   geom_vline(xintercept=ED50.avsa,color=mycols["A. sativa"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.trae,color=mycols["T. aestivum"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.hovu,color=mycols["H. vulgare"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.pegl,color=mycols["P. glaucum"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.chga,color=mycols["C. gayana"],lty=5, linewidth = 1)+
   geom_vline(xintercept=ED50.zema,color=mycols["Z. mays"],lty=5, linewidth = 1)+
  xlim(0,100)+
  theme_minimal()+
  theme(panel.grid.minor=element_blank(),
        #panel.grid.major=element_blank(),
        axis.title.y=element_text(size=14),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=14),
        legend.title = element_text(size=16, face="bold"),
        legend.text=element_text(size=14, face="italic"),
         legend.direction = "horizontal",
       # legend.position = "bottom"
       )+
  xlab(expression(paste("RWC (%)")))+
  ylab(expression(paste("PLRC (%)")))+
  labs(color = "Species", fill = "Species")+
  ylim(0,90)
PLRC
```


##Figure 3 - ALL PLOTS PLRC + CFD 

```{r}
# Extract the legend
legend <- get_legend(PLRC)
legend
plot(legend) #to check if it plots

#now remove the legend from the plots
PLRC_without_legend <- PLRC + theme(legend.position = "none")
CFD_without_legend <- CFD + theme(legend.position = "none")


Figure3 <- ggarrange(CFD_without_legend, PLRC_without_legend, legend, ncol = 1, nrow = 3, labels = c("A", "B", ""),heights = c(1,1,0.2))
Figure3

ggsave(filename = "../results/Figure3.jpg", plot = Figure3,  width = 8, height = 10)
```




#///////Figure X

##data
SRC, data loading, variable calculation, outliers, means 
```{r}
SRCdata <- read_xlsx(path = "../data/C3C4 Grasses - OV monitoring, SRC.xlsx", sheet = "C3C4G SRC") 
##variable calculations
SRCdata$Metabolism<-factor(SRCdata$Metabolism)
SRCdata$Species<-factor(SRCdata$Species,levels=c("Avsa","Hovu","Trae","Pegl","Zema","Chga"))

# variable calculation
#T for initial, fully hydrated or turgid -- STAGE 1
#F for after dehydration or fresh -- STAGE 2
#R for Rehydration -- STAGE 3
#D for dry -- STAGE 4

#leaf thickness average
SRCdata$T.LT<-rowMeans(SRCdata[c("T.LT1","T.LT2","T.LT3","T.LT4","T.LT5","T.LT6")],na.rm=T) #stage 1
SRCdata$F.LT2 <- as.numeric(SRCdata$F.LT2)
SRCdata$F.LT<-rowMeans(SRCdata[c("F.LT1","F.LT2","F.LT3","F.LT4","F.LT5","F.LT6")],na.rm=T) #stage 2
SRCdata$D.LT2 <- as.numeric(SRCdata$D.LT2)
SRCdata$D.LT<-rowMeans(SRCdata[c("D.LT1","D.LT2","D.LT3","D.LT4","D.LT5","D.LT6")],na.rm=T) #stage 4

#leaf width average
SRCdata$F.LW1 <- as.numeric(SRCdata$F.LW1)
SRCdata$F.LW2 <- as.numeric(SRCdata$F.LW2)
SRCdata$F.LW3 <- as.numeric(SRCdata$F.LW3)
SRCdata$F.LW4 <- as.numeric(SRCdata$F.LW4)
SRCdata$F.LW5 <- as.numeric(SRCdata$F.LW5)

SRCdata$T.LW1<-rowMeans(SRCdata[c("T.LW1","T.LW2","T.LW3")],na.rm=T) #stage 1 - middle
SRCdata$F.LW1<-rowMeans(SRCdata[c("F.LW1","F.LW2","F.LW3")],na.rm=T) #stage 2
SRCdata$T.LW2<-rowMeans(SRCdata[c("T.LW1","T.LW4","T.LW5")],na.rm=T) #stage 1 - base
SRCdata$F.LW2<-rowMeans(SRCdata[c("F.LW1","F.LW4","F.LW5")],na.rm=T) #stage 2

SRCdata$D.LW1 <- as.numeric(SRCdata$D.LW1)
SRCdata$D.LW2 <- as.numeric(SRCdata$D.LW2)
SRCdata$D.LW3 <- as.numeric(SRCdata$D.LW3)
SRCdata$D.LW4 <- as.numeric(SRCdata$D.LW4)
SRCdata$D.LW5 <- as.numeric(SRCdata$D.LW5)

SRCdata$D.LW<-rowMeans(SRCdata[c("D.LW1","D.LW2","D.LW3","D.LW4","D.LW5")],na.rm=T) #stage 4

#Leaf volume 
SRCdata$F.LA <- as.numeric(SRCdata$F.LA)
SRCdata$D.LA <- as.numeric(SRCdata$D.LA)

SRCdata$T.LV<-SRCdata$T.LA*SRCdata$T.LT/10 #stage 1
SRCdata$F.LV<-SRCdata$F.LA*SRCdata$F.LT/10 #stage 2
SRCdata$D.LV<-SRCdata$D.LA*SRCdata$D.LT/10  #stage 4

#PLX : Leaf percentage loss of X variable

#Leaf percentage loss during dehydration: thickness
SRCdata$F.PLT<-100-SRCdata$F.LT/SRCdata$T.LT*100 #stage 2 leaf thickness compared to stage 1 leaf thickness
SRCdata$D.PLT<-100-SRCdata$D.LT/SRCdata$T.LT*100 #stage 4 dry leaf thickness compared to stage 4 

#Leaf percentage loss during dehydration: leaf area
SRCdata$F.PLA<-100-SRCdata$F.LA/SRCdata$T.LA*100
SRCdata$D.PLA<-100-SRCdata$D.LA/SRCdata$T.LA*100

#Leaf percentage loss during dehydration: leaf width
SRCdata$F.PLW1<-100-SRCdata$F.LW1/SRCdata$T.LW1*100
SRCdata$D.PLW1<-100-SRCdata$D.LW/SRCdata$T.LW1*100

#Leaf percentage loss during dehydration: leaf length
SRCdata$F.LLe <- as.numeric(SRCdata$F.LLe)
SRCdata$T.LLe <- as.numeric(SRCdata$T.LLe)
SRCdata$D.LLe <- as.numeric(SRCdata$D.LLe)
SRCdata$F.PLLe<-100-SRCdata$F.LLe/SRCdata$T.LLe*100
SRCdata$D.PLLe<-100-SRCdata$D.LLe/SRCdata$T.LLe*100

##Leaf percentage loss during dehydration: leaf volume
SRCdata$F.PLV<-100-SRCdata$F.LV/SRCdata$T.LV*100
SRCdata$D.PLV<-100-SRCdata$D.LV/SRCdata$T.LV*100

#RWC calculations & other variables
SRCdata$T.SWC<-(SRCdata$TW-SRCdata$DW)/SRCdata$DW
SRCdata$F.SWC<-(SRCdata$FW-SRCdata$DW)/SRCdata$DW
SRCdata$R.SWC<-(SRCdata$RW-SRCdata$DW)/SRCdata$DW
SRCdata$F.RWC<-(SRCdata$FW-SRCdata$DW)/(SRCdata$TW-SRCdata$DW)*100
SRCdata$R.RWC<-(SRCdata$RW-SRCdata$DW)/(SRCdata$TW-SRCdata$DW)*100 #marion

#??
SRCdata$F.1_LWi.LWhy<-1-SRCdata$FW/SRCdata$TW #???

#LMA, leaf density, LDMC, 
SRCdata$LMA<-SRCdata$DW/1000/(SRCdata$T.LA/10000)
SRCdata$LD<-SRCdata$DW/1000/SRCdata$T.LV
SRCdata$LDMC<-SRCdata$DW/SRCdata$TW

#Rehydration capacity PLRC = 100- LW_rehy / LW_full saturation *100
#what the leaf recovers compared to its full turgid capacity
SRCdata$PLRC<-100-SRCdata$R.SWC/SRCdata$T.SWC*100

#formula for the percentage loss of chlorophyll fluorescence (PLCF, in %), as an index of loss of fluorescence  capacity after dehydration

# variable calculation
#T for initial, fully hydrated or turgid -- STAGE 1
#F for after dehydration or fresh -- STAGE 2
#R for Rehydration -- STAGE 3
#D for dry -- STAGE 4


SRCdata$PLCF = 100* (1- (as.numeric(SRCdata$F.FvFm)/as.numeric(SRCdata$T.FvFm)))

```

# SRC, outliers

```{r}
# PLRC of -20% 
#SRCdata$Species[!SRCdata$PLRC>-20] (Chga and Hovu)
SRCdata$PLRC[!SRCdata$PLRC>-20]<-NA #why input NA for the two values: -23.9 and -21.5?

#Species 
# Avsa
#SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==17,5:84]<-NA
#SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==20,5:84]<-NA
#SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==21,5:84]<-NA
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==22,5:84]<-NA # FvFm
#SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==24,5:84]<-NA
#SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==25,5:84]<-NA
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==26,5:84]<-NA # FvFm
#SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==29,5:84]<-NA
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==30,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==31,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==32,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==43,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==44,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==45,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==46,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==47,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==49,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==51,5:84]<-NA # too small leaf (!)
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==52,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==53,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==54,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==55,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==56,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==57,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==59,5:84]<-NA # PLA
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==17,84]<-NA # only PLRC
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==20,84]<-NA # only PLRC
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==21,84]<-NA # only PLRC
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==24,84]<-NA # only PLRC
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==25,84]<-NA # only PLRC
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==24,74]<-NA # only D.PLLe - to check photos!
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==27,74]<-NA # only D.PLLe - to check photos!
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==28,74]<-NA # only D.PLLe - to check photos!
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==65,74]<-NA # only D.PLLe - to check photos!
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==66,74]<-NA # only D.PLLe - to check photos!
SRCdata[SRCdata$Species=="Avsa" & SRCdata$Leaf==48,70]<-NA # only D.PLA - to check photos!

## Chga
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==1,5:84]<-NA # PLT - to check
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==6,5:84]<-NA # PLA - to check photos!
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==9,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==21,5:84]<-NA # PLT - to check
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==22,5:84]<-NA # LMA vs LDMC
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==24,74]<-NA # only D.PLLe - to check photos!
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==25,5:84]<-NA # LMA vs LDMC
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==30,5:84]<-NA # PLT - to check
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==31,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==32,5:84]<-NA # PLRC
SRCdata[SRCdata$Species=="Chga" & SRCdata$Leaf==48,5:84]<-NA # FvFm

## Hovu
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==3,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==4,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==5,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==6,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==7,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==8,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==15,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==17,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==19,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==49,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==50,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==56,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==55,84]<-NA # only PLRC
SRCdata[SRCdata$Species=="Hovu" & SRCdata$Leaf==14,c(69,75)]<-NA # only PLA, PLV - to check photos!

## Pegl 
SRCdata[SRCdata$Species=="Pegl" & SRCdata$Leaf==35,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Pegl" & SRCdata$Leaf==38,74]<-NA # only D.PLLe - to check photos!
SRCdata[SRCdata$Species=="Pegl" & SRCdata$Leaf==42,74]<-NA # only D.PLLe - to check photos!

## Trae
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==8,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==9,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==10,5:84]<-NA # FvFm
#SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==18,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==20,5:84]<-NA # FvFm
#SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==23,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==28,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==29,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==30,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==31,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==32,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==45,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==46,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==47,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==49,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==50,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==52,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==53,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Trae" & SRCdata$Leaf==42,44]<-NA # only R FvFm - to check!

## Zema
SRCdata[SRCdata$Species=="Zema" & SRCdata$Leaf==8,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Zema" & SRCdata$Leaf==10,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Zema" & SRCdata$Leaf==15,5:84]<-NA # LDMC vs LD
SRCdata[SRCdata$Species=="Zema" & SRCdata$Leaf==20,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Zema" & SRCdata$Leaf==23,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Zema" & SRCdata$Leaf==34,5:84]<-NA # FvFm
SRCdata[SRCdata$Species=="Zema" & SRCdata$Leaf==24,84]<-NA # only PLRC
SRCdata[SRCdata$Species=="Zema" & SRCdata$Leaf==6,c(70,76)]<-NA # only DPLA, DPLV - to check photos!
```


## means 
```{r}
m.SRCdata<-ddply(SRCdata,c("Species","Metabolism"),summarise,
                m.LMA=mean(LMA,na.rm=TRUE),n.LMA=sum(!is.na(LMA)),se.LMA=sd(LMA,na.rm=T)/sqrt(n.LMA),
                m.T.LT=mean(T.LT,na.rm=TRUE),n.T.LT=sum(!is.na(T.LT)),se.T.LT=sd(T.LT,na.rm=T)/sqrt(n.T.LT),
                m.LD=mean(LD,na.rm=TRUE),n.LD=sum(!is.na(LD)),se.LD=sd(LD,na.rm=T)/sqrt(n.LD),
                m.LDMC=mean(LDMC,na.rm=TRUE),n.LDMC=sum(!is.na(LDMC)),se.LDMC=sd(LDMC,na.rm=T)/sqrt(n.LDMC),
                m.D.PLT=mean(D.PLT,na.rm=TRUE),n.D.PLT=sum(!is.na(D.PLT)),se.D.PLT=sd(D.PLT,na.rm=T)/sqrt(n.D.PLT),
                m.D.PLA=mean(D.PLA,na.rm=TRUE),n.D.PLA=sum(!is.na(D.PLA)),se.D.PLA=sd(D.PLA,na.rm=T)/sqrt(n.D.PLA),
                m.D.PLV=mean(D.PLV,na.rm=TRUE),n.D.PLV=sum(!is.na(D.PLV)),se.D.PLV=sd(D.PLV,na.rm=T)/sqrt(n.D.PLV),
                m.D.PLLe=mean(D.PLLe,na.rm=TRUE),n.D.PLLe=sum(!is.na(D.PLLe)),se.D.PLLe=sd(D.PLLe,na.rm=T)/sqrt(n.D.PLLe),
                m.D.PLW1=mean(D.PLW1,na.rm=TRUE),n.D.PLW1=sum(!is.na(D.PLW1)),se.D.PLW1=sd(D.PLW1,na.rm=T)/sqrt(n.D.PLW1))
```

## SRC data for analysis
```{r}

#write.csv(m.SRCdata, file = "../data/m.SRCdata.csv")
#write.csv(SRCdata, file = "../data/SRCdata.csv")
```


## SRC data RWC converted to psi
```{r}
SRCdata = read.csv("../data/SRCdata.csv",header=TRUE)

SRCdata_PV <- SRCdata %>% 
  mutate(
    tlp.coef = case_when(
      Species == "Avsa" ~ -0.84,
      Species == "Chga" ~ -0.75,
      Species == "Hovu" ~ -0.83,
      Species == "Pegl" ~ -0.68,
      Species == "Trae" ~ -0.85,
      Species == "Zema" ~ -0.68,
      TRUE ~ NA_real_
    ),
    elasticity = case_when(
      Species == "Avsa" ~ 8.57,
      Species == "Chga" ~ 11.6,
      Species == "Hovu" ~ 9.27,
      Species == "Pegl" ~ 8.99,
      Species == "Trae" ~ 9.25,
      Species == "Zema" ~ 8.07,
      TRUE ~ NA_real_
    )) %>% 
  mutate(Psip =-(tlp.coef)-(elasticity*(1-F.RWC/100))) %>% 
  mutate(Psip = if_else(Psip < 0, 0, Psip))%>%  # Replace negative Psip with 0
  mutate(Ps=tlp.coef/(F.RWC/100)) %>% #tlp en neg 
  mutate(Psileaf.from.RWC= Psip + Ps)


write.csv(x = SRCdata_PV, file = "../data/SRCdata_PV.csv")

# #avsa
# tlp = -0.84 
# elasticity 8.57 
# 
# #chga
# tlp = -0.75 
# elasticity 11.6
# 
# #hovu
# tlp = -0.83 
# elasticity 9.27
# 
# #pegl
# tlp = -0.68 
# elasticity 8.99
# 
# #trae
# tlp = -0.85 
# elasticity 9.25
# 
# #zema
# tlp = -0.68 
# elasticity 8.07
```

##leaf structure
```{r}
## SRC, boxplots, stat analysis ####

# LMA
plot_LMA<-ggplot(SRCdata,aes(x=Species,y=LMA,fill=Metabolism))+
  geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c(C3 = "#6DB9F8", C4 = "#D9AB33"))+
   ggtitle(expression(paste("LMA (g m"^-2,")")))+
  #geom_point(data=GExdata.0[GExdata.0$Dataset=="Dehydration",],aes(x=Species,y=LMA),size=4,shape=21,fill="yellow")+
  ylim(0,50)+
  #geom_hline(yintercept=0,lty=2)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  #ylab(expression(paste("LMA (g m"^-2,")")))+
  annotate("text",x=1,y=7,label=expression(paste(italic(bar("x"))," = 31.1")),size=4)+
  annotate("text",x=1,y=4,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=7,label=expression(paste("21.2")),size=4)+
  annotate("text",x=2,y=4,label=expression(paste("48")),size=4)+
  annotate("text",x=3,y=7,label=expression(paste("27.4")),size=4)+
  annotate("text",x=3,y=4,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=7,label=expression(paste("24.7")),size=4)+
  annotate("text",x=4,y=4,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=7,label=expression(paste("20.6")),size=4)+
  annotate("text",x=5,y=4,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=7,label=expression(paste("27.5")),size=4)+
  annotate("text",x=6,y=4,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","LMA"],na.rm=T)+4,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","LMA"],na.rm=T)+4,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","LMA"],na.rm=T)+4,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","LMA"],na.rm=T)+4,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","LMA"],na.rm=T)+4,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","LMA"],na.rm=T)+4,label=expression(paste(bold("b"))),size=5)
plot_LMA

# stat
lm1<-lm(LMA~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# LT
plot_LT<-ggplot(SRCdata,aes(x=Species,y=T.LT,fill=Metabolism))+
  theme_minimal()+
  geom_boxplot(lwd=0.2,fatten=5)+
  scale_fill_manual(values=c(C3 = "#6DB9F8", C4 = "#D9AB33"))+
  #geom_point(data=GExdata.0[GExdata.0$Dataset=="Dehydration",],aes(x=Species,y=LMA),size=4,shape=21,fill="yellow")+
  ylim(0,0.4)+
  #geom_hline(yintercept=0,lty=2)+
  ggtitle("LT (mm)")+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=0.056,label=expression(paste(italic(bar("x"))," = 0.22")),size=4)+
  annotate("text",x=1,y=0.032,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=0.056,label=expression(paste("0.19")),size=4)+
  annotate("text",x=2,y=0.032,label=expression(paste("48")),size=4)+
  annotate("text",x=3,y=0.056,label=expression(paste("0.17")),size=4)+
  annotate("text",x=3,y=0.032,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=0.056,label=expression(paste("0.13")),size=4)+
  annotate("text",x=4,y=0.032,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=0.056,label=expression(paste("0.16")),size=4)+
  annotate("text",x=5,y=0.032,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=0.056,label=expression(paste("0.12")),size=4)+
  annotate("text",x=6,y=0.032,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("d"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("e"))),size=5)
plot_LT

# stat
lm1<-lm(T.LT~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# LD
plot_LD<-ggplot(SRCdata,aes(x=Species,y=LD,fill=Metabolism))+
  theme_minimal()+
  geom_boxplot(lwd=0.2,fatten=5)+
  scale_fill_manual(values=c(C3 = "#6DB9F8", C4 = "#D9AB33"))+
  #geom_point(data=GExdata.0[GExdata.0$Dataset=="Dehydration",],aes(x=Species,y=LMA),size=4,shape=21,fill="yellow")+
  ylim(0,0.4)+
  #geom_hline(yintercept=0,lty=2)+
  ggtitle(expression(paste("LD (g cm"^-3,")")))+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=0.040,label=expression(paste(italic(bar("x"))," = 0.14")),size=4)+
  annotate("text",x=1,y=0.016,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=0.040,label=expression(paste("0.11")),size=4)+
  annotate("text",x=2,y=0.016,label=expression(paste("48")),size=4)+
  annotate("text",x=3,y=0.040,label=expression(paste("0.17")),size=4)+
  annotate("text",x=3,y=0.016,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=0.040,label=expression(paste("0.19")),size=4)+
  annotate("text",x=4,y=0.016,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=0.040,label=expression(paste("0.13")),size=4)+
  annotate("text",x=5,y=0.016,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=0.040,label=expression(paste("0.24")),size=4)+
  annotate("text",x=6,y=0.016,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","LD"],na.rm=T)+0.032,label=expression(paste(bold("d"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","LD"],na.rm=T)+0.032,label=expression(paste(bold("e"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","LD"],na.rm=T)+0.032,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","LD"],na.rm=T)+0.032,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","LD"],na.rm=T)+0.032,label=expression(paste(bold("d"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","LD"],na.rm=T)+0.032,label=expression(paste(bold("a"))),size=5)
plot_LD

# stat
lm1<-lm(LD~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# LDMC
plot_LDMC<-ggplot(SRCdata,aes(x=Species,y=LDMC,fill=Metabolism))+
  theme_minimal()+
  geom_boxplot(lwd=0.2,fatten=5)+
  scale_fill_manual(values=c(C3 = "#6DB9F8", C4 = "#D9AB33"))+
  #geom_point(data=GExdata.0[GExdata.0$Dataset=="Dehydration",],aes(x=Species,y=LMA),size=4,shape=21,fill="yellow")+
  ylim(0,0.3)+
  #geom_hline(yintercept=0,lty=2)+
  ggtitle(expression(paste("LDMC (g g"^-1,")")))+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  #ylab(expression(paste("LDMC (g g"^-1,")")))+
  annotate("text",x=1,y=0.024,label=expression(paste(italic(bar("x"))," = 0.13")),size=4)+
  annotate("text",x=1,y=0,label=expression(paste(italic("n")," = 44")),size=4)+
  annotate("text",x=2,y=0.024,label=expression(paste("0.11")),size=4)+
  annotate("text",x=2,y=0,label=expression(paste("47")),size=4)+
  annotate("text",x=3,y=0.024,label=expression(paste("0.16")),size=4)+
  annotate("text",x=3,y=0,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=0.024,label=expression(paste("0.11")),size=4)+
  annotate("text",x=4,y=0,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=0.024,label=expression(paste("0.10")),size=4)+
  annotate("text",x=5,y=0,label=expression(paste("41")),size=4)+
  annotate("text",x=6,y=0.024,label=expression(paste("0.16")),size=4)+
  annotate("text",x=6,y=0,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("a"))),size=5)

plot_LDMC
# stat
lm1<-lm(LDMC~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups


##all graphs for leaf structure

Leaf_structure<- ggarrange(plot_LMA, plot_LT, plot_LD, plot_LDMC, ncol = 2, nrow = 2, common.legend= TRUE, legend = "bottom")
Leaf_structure

ggsave(filename = "../results/leaf_structure.jpg", plot = Leaf_structure, width = 10, height = 10)
```

##leaf percentage loss
```{r}
# PLTdry
PLTdry_plot<-ggplot(SRCdata,aes(x=Species,y=D.PLT,fill=Metabolism))+
   geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c(C3 = "#6DB9F8", C4 = "#D9AB33"))+
   ggtitle(expression(paste("PL Thickness"["dry"]," (%)")))+
  ylim(0,100)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.position = "none",
        #legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  #ylab()+
  annotate("text",x=1,y=10,label=expression(paste(italic(bar("x"))," = 46.1")),size=4)+
  annotate("text",x=1,y=4,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=10,label=expression(paste("69.8")),size=4)+
  annotate("text",x=2,y=4,label=expression(paste("48")),size=4)+
  annotate("text",x=3,y=10,label=expression(paste("45.8")),size=4)+
  annotate("text",x=3,y=4,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=10,label=expression(paste("56.5")),size=4)+
  annotate("text",x=4,y=4,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=10,label=expression(paste("69.2")),size=4)+
  annotate("text",x=5,y=4,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=10,label=expression(paste("46.4")),size=4)+
  annotate("text",x=6,y=4,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","D.PLT"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","D.PLT"],na.rm=T)+8,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","D.PLT"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","D.PLT"],na.rm=T)+8,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","D.PLT"],na.rm=T)+8,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","D.PLT"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)

PLTdry_plot
# stat
lm1<-lm(D.PLT~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# PLAdry
PLAdry_plot<-ggplot(SRCdata,aes(x=Species,y=D.PLA,fill=Metabolism))+
   geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c(C3 = "#6DB9F8", C4 = "#D9AB33"))+
   ggtitle(expression(paste("PL Area"["dry"]," (%)")))+
  ylim(10,90)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.position = "none",
        #legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=21.2,label=expression(paste(italic(bar("x"))," = 49.4")),size=4)+
  annotate("text",x=1,y=16.4,label=expression(paste(italic("n")," = 48")),size=4)+
  annotate("text",x=2,y=21.2,label=expression(paste("43.7")),size=4)+
  annotate("text",x=2,y=16.4,label=expression(paste("46")),size=4)+
  annotate("text",x=3,y=21.2,label=expression(paste("45.8")),size=4)+
  annotate("text",x=3,y=16.4,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=21.2,label=expression(paste("60.2")),size=4)+
  annotate("text",x=4,y=16.4,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=21.2,label=expression(paste("53.0")),size=4)+
  annotate("text",x=5,y=16.4,label=expression(paste("41")),size=4)+
  annotate("text",x=6,y=21.2,label=expression(paste("63.1")),size=4)+
  annotate("text",x=6,y=16.4,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("bc"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("d"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("cd"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("a"))),size=5)

PLAdry_plot

# stat
lm1<-lm(D.PLA~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups


# PLLedry
PLLedry_plot<-ggplot(SRCdata,aes(x=Species,y=D.PLLe,fill=Metabolism))+
  geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c(C3 = "#6DB9F8", C4 = "#D9AB33"))+
   ggtitle(expression(paste("PL Length"["dry"]," (%)")))+
  ylim(-15,20)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.position = "none",
        #legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=-6,label=expression(paste(italic(bar("x"))," = 1.9")),size=4)+
  annotate("text",x=1,y=-8,label=expression(paste(italic("n")," = 41")),size=4)+
  annotate("text",x=2,y=-6,label=expression(paste("2.0")),size=4)+
  annotate("text",x=2,y=-8,label=expression(paste("46")),size=4)+
  annotate("text",x=3,y=-6,label=expression(paste("1.4")),size=4)+
  annotate("text",x=3,y=-8,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=-6,label=expression(paste("2.9")),size=4)+
  annotate("text",x=4,y=-8,label=expression(paste("39")),size=4)+
  annotate("text",x=5,y=-6,label=expression(paste("3.2")),size=4)+
  annotate("text",x=5,y=-8,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=-6,label=expression(paste("3.4")),size=4)+
  annotate("text",x=6,y=-8,label=expression(paste("41")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","D.PLLe"],na.rm=T)+3,label=expression(paste(bold("bc"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","D.PLLe"],na.rm=T)+3,label=expression(paste(bold("bc"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","D.PLLe"],na.rm=T)+3,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","D.PLLe"],na.rm=T)+3,label=expression(paste(bold("ab"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","D.PLLe"],na.rm=T)+3,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","D.PLLe"],na.rm=T)+3,label=expression(paste(bold("a"))),size=5)

PLLedry_plot
# stat
lm1<-lm(D.PLLe~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# PLWidry (PLW1dry)
PLWdry_plot<-ggplot(SRCdata,aes(x=Species,y=D.PLW1,fill=Metabolism))+
  geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c(C3 = "#6DB9F8", C4 = "#D9AB33"))+
   ggtitle(expression(paste("PL Width"["dry"]," (%)")))+
  ylim(0,100)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.position = "none",
        #legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=14,label=expression(paste(italic(bar("x"))," = 49.0")),size=4)+
  annotate("text",x=1,y=8,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=14,label=expression(paste("44.9")),size=4)+
  annotate("text",x=2,y=8,label=expression(paste("46")),size=4)+
  annotate("text",x=3,y=14,label=expression(paste("46.8")),size=4)+
  annotate("text",x=3,y=8,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=14,label=expression(paste("57.9")),size=4)+
  annotate("text",x=4,y=8,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=14,label=expression(paste("56.3")),size=4)+
  annotate("text",x=5,y=8,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=14,label=expression(paste("61.6")),size=4)+
  annotate("text",x=6,y=8,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("ab"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("a"))),size=5)

PLWdry_plot

# stat
lm1<-lm(D.PLW1~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups


# PLV (PLW1dry)
PLV_plot<-ggplot(SRCdata,aes(x=Species,y=D.PLV,fill=Metabolism))+
  geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c(C3 = "#6DB9F8", C4 = "#D9AB33"))+
   ggtitle(expression(paste("PL Volume"["dry"]," (%)")))+
  ylim(40,110)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=50,label=expression(paste(italic(bar("x"))," = 71.6")),size=4)+
  annotate("text",x=1,y=45,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=50,label=expression(paste("82.5")),size=4)+
  annotate("text",x=2,y=45,label=expression(paste("46")),size=4)+
  annotate("text",x=3,y=50,label=expression(paste("70.5")),size=4)+
  annotate("text",x=3,y=45,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=50,label=expression(paste("82.7")),size=4)+
  annotate("text",x=4,y=45,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=50,label=expression(paste("85.3")),size=4)+
  annotate("text",x=5,y=45,label=expression(paste("41")),size=4)+
  annotate("text",x=6,y=50,label=expression(paste("80.2")),size=4)+
  annotate("text",x=6,y=45,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","D.PLV"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","D.PLV"],na.rm=T)+8,label=expression(paste(bold("ab"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","D.PLV"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","D.PLV"],na.rm=T)+8,label=expression(paste(bold("ab"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","D.PLV"],na.rm=T)+8,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","D.PLV"],na.rm=T)+8,label=expression(paste(bold("b"))),size=5)

PLV_plot


# stat
lm1<-lm(D.PLV~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

##all graphs for leaf structure

# Extract the legend
legend <- get_legend(
  PLV_plot +
    theme(legend.position = "right", text = element_text(size=20)) # Adjust position if needed
)

#legend <- plot(legend) #to check if it plots

#now remove the legend from the PLV plot
PLV_plot <- PLV_plot + theme(legend.position = "none")

Percent_loss_dry<- ggarrange(PLTdry_plot, PLAdry_plot, PLWdry_plot, ncol =3, nrow = 1, common.legend = T, legend = "bottom")

Percent_loss_dry

ggsave(filename = "../results/Percentloss_dry.jpg", plot = Percent_loss_dry, width = 10, height = 5)

```


#///////ANATOMY

#Absolute - leaf structure
##leaf structure
```{r}
## SRC, boxplots, stat analysis ####

SRCdata = read.csv("../data/SRCdata.csv",header=TRUE) #same data as in Figure 3 above

# Define order: all C3 species first, then all C4 species
species_order <- c("Avsa", "Hovu", "Trae", "Pegl", "Zema", "Chga")

# Set Species as factor with this order
SRCdata$Species <- factor(SRCdata$Species, levels = species_order)


# LMA
plot_LMA<-ggplot(SRCdata,aes(x=Species,y=LMA,fill=Metabolism))+
  geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c("#E1BE6A", "#40B0A6"))+
   ggtitle(expression(paste("LMA (g m"^-2,")")))+
  #geom_point(data=GExdata.0[GExdata.0$Dataset=="Dehydration",],aes(x=Species,y=LMA),size=4,shape=21,fill="yellow")+
  ylim(0,50)+
  #geom_hline(yintercept=0,lty=2)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  #ylab(expression(paste("LMA (g m"^-2,")")))+
  annotate("text",x=1,y=7,label=expression(paste(italic(bar("x"))," = 31.1")),size=4)+
  annotate("text",x=1,y=4,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=7,label=expression(paste("21.2")),size=4)+
  annotate("text",x=2,y=4,label=expression(paste("48")),size=4)+
  annotate("text",x=3,y=7,label=expression(paste("27.4")),size=4)+
  annotate("text",x=3,y=4,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=7,label=expression(paste("24.7")),size=4)+
  annotate("text",x=4,y=4,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=7,label=expression(paste("20.6")),size=4)+
  annotate("text",x=5,y=4,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=7,label=expression(paste("27.5")),size=4)+
  annotate("text",x=6,y=4,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","LMA"],na.rm=T)+4,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","LMA"],na.rm=T)+4,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","LMA"],na.rm=T)+4,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","LMA"],na.rm=T)+4,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","LMA"],na.rm=T)+4,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","LMA"],na.rm=T)+4,label=expression(paste(bold("b"))),size=5)
plot_LMA

# stat
lm1<-lm(LMA~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# LT
plot_LT<-ggplot(SRCdata,aes(x=Species,y=T.LT,fill=Metabolism))+
  theme_minimal()+
  geom_boxplot(lwd=0.2,fatten=5)+
  scale_fill_manual(values=c("#E1BE6A", "#40B0A6"))+
  #geom_point(data=GExdata.0[GExdata.0$Dataset=="Dehydration",],aes(x=Species,y=LMA),size=4,shape=21,fill="yellow")+
  ylim(0,0.4)+
  #geom_hline(yintercept=0,lty=2)+
  ggtitle("LT (mm)")+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=0.056,label=expression(paste(italic(bar("x"))," = 0.22")),size=4)+
  annotate("text",x=1,y=0.032,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=0.056,label=expression(paste("0.19")),size=4)+
  annotate("text",x=2,y=0.032,label=expression(paste("48")),size=4)+
  annotate("text",x=3,y=0.056,label=expression(paste("0.17")),size=4)+
  annotate("text",x=3,y=0.032,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=0.056,label=expression(paste("0.13")),size=4)+
  annotate("text",x=4,y=0.032,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=0.056,label=expression(paste("0.16")),size=4)+
  annotate("text",x=5,y=0.032,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=0.056,label=expression(paste("0.12")),size=4)+
  annotate("text",x=6,y=0.032,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("d"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","T.LT"],na.rm=T)+0.032,label=expression(paste(bold("e"))),size=5)
plot_LT

# stat
lm1<-lm(T.LT~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# LD
plot_LD<-ggplot(SRCdata,aes(x=Species,y=LD,fill=Metabolism))+
  theme_minimal()+
  geom_boxplot(lwd=0.2,fatten=5)+
  scale_fill_manual(values=c("#E1BE6A", "#40B0A6"))+
  #geom_point(data=GExdata.0[GExdata.0$Dataset=="Dehydration",],aes(x=Species,y=LMA),size=4,shape=21,fill="yellow")+
  ylim(0,0.4)+
  #geom_hline(yintercept=0,lty=2)+
  ggtitle(expression(paste("LD (g cm"^-3,")")))+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=0.040,label=expression(paste(italic(bar("x"))," = 0.14")),size=4)+
  annotate("text",x=1,y=0.016,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=0.040,label=expression(paste("0.11")),size=4)+
  annotate("text",x=2,y=0.016,label=expression(paste("48")),size=4)+
  annotate("text",x=3,y=0.040,label=expression(paste("0.17")),size=4)+
  annotate("text",x=3,y=0.016,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=0.040,label=expression(paste("0.19")),size=4)+
  annotate("text",x=4,y=0.016,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=0.040,label=expression(paste("0.13")),size=4)+
  annotate("text",x=5,y=0.016,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=0.040,label=expression(paste("0.24")),size=4)+
  annotate("text",x=6,y=0.016,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","LD"],na.rm=T)+0.032,label=expression(paste(bold("d"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","LD"],na.rm=T)+0.032,label=expression(paste(bold("e"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","LD"],na.rm=T)+0.032,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","LD"],na.rm=T)+0.032,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","LD"],na.rm=T)+0.032,label=expression(paste(bold("d"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","LD"],na.rm=T)+0.032,label=expression(paste(bold("a"))),size=5)
plot_LD

# stat
lm1<-lm(LD~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# LDMC
plot_LDMC<-ggplot(SRCdata,aes(x=Species,y=LDMC,fill=Metabolism))+
  theme_minimal()+
  geom_boxplot(lwd=0.2,fatten=5)+
  scale_fill_manual(values=c("#E1BE6A", "#40B0A6"))+
  #geom_point(data=GExdata.0[GExdata.0$Dataset=="Dehydration",],aes(x=Species,y=LMA),size=4,shape=21,fill="yellow")+
  ylim(0,0.3)+
  #geom_hline(yintercept=0,lty=2)+
  ggtitle(expression(paste("LDMC (g g"^-1,")")))+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  #ylab(expression(paste("LDMC (g g"^-1,")")))+
  annotate("text",x=1,y=0.024,label=expression(paste(italic(bar("x"))," = 0.13")),size=4)+
  annotate("text",x=1,y=0,label=expression(paste(italic("n")," = 44")),size=4)+
  annotate("text",x=2,y=0.024,label=expression(paste("0.11")),size=4)+
  annotate("text",x=2,y=0,label=expression(paste("47")),size=4)+
  annotate("text",x=3,y=0.024,label=expression(paste("0.16")),size=4)+
  annotate("text",x=3,y=0,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=0.024,label=expression(paste("0.11")),size=4)+
  annotate("text",x=4,y=0,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=0.024,label=expression(paste("0.10")),size=4)+
  annotate("text",x=5,y=0,label=expression(paste("41")),size=4)+
  annotate("text",x=6,y=0.024,label=expression(paste("0.16")),size=4)+
  annotate("text",x=6,y=0,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","LDMC"],na.rm=T)+0.024,label=expression(paste(bold("a"))),size=5)

plot_LDMC
# stat
lm1<-lm(LDMC~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups


##all graphs for leaf structure

Leaf_structure<- ggarrange(plot_LMA, plot_LT, plot_LD, plot_LDMC, ncol = 2, nrow = 2, common.legend= TRUE, legend = "bottom")
Leaf_structure

ggsave(filename = "../results/leaf_structure.jpg", plot = Leaf_structure,  width = 12, height = 8)

```

##percent loss - thickness, area and width
```{r}

SRCdata = read.csv("../data/SRCdata.csv",header=TRUE) #same data as in Figure 3

# Define order: all C3 species first, then all C4 species
species_order <- c("Avsa", "Hovu", "Trae", "Pegl", "Zema", "Chga")

# Set Species as factor with this order
SRCdata$Species <- factor(SRCdata$Species, levels = species_order)

# PLTdry
PLTdry_plot<-ggplot(SRCdata,aes(x=Species,y=D.PLT,fill=Metabolism))+
   geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c("#E1BE6A", "#40B0A6"))+
   ggtitle(expression(paste("PL Thickness"["dry"]," (%)")))+
  ylim(0,100)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.position = "none",
        #legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  #ylab()+
  annotate("text",x=1,y=10,label=expression(paste(italic(bar("x"))," = 46.1")),size=4)+
  annotate("text",x=1,y=4,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=10,label=expression(paste("69.8")),size=4)+
  annotate("text",x=2,y=4,label=expression(paste("48")),size=4)+
  annotate("text",x=3,y=10,label=expression(paste("45.8")),size=4)+
  annotate("text",x=3,y=4,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=10,label=expression(paste("56.5")),size=4)+
  annotate("text",x=4,y=4,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=10,label=expression(paste("69.2")),size=4)+
  annotate("text",x=5,y=4,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=10,label=expression(paste("46.4")),size=4)+
  annotate("text",x=6,y=4,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","D.PLT"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","D.PLT"],na.rm=T)+8,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","D.PLT"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","D.PLT"],na.rm=T)+8,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","D.PLT"],na.rm=T)+8,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","D.PLT"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)

PLTdry_plot
# stat
lm1<-lm(D.PLT~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# PLAdry
PLAdry_plot<-ggplot(SRCdata,aes(x=Species,y=D.PLA,fill=Metabolism))+
   geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c("#E1BE6A", "#40B0A6"))+
   ggtitle(expression(paste("PL Area"["dry"]," (%)")))+
  ylim(10,90)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.position = "none",
        #legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=21.2,label=expression(paste(italic(bar("x"))," = 49.4")),size=4)+
  annotate("text",x=1,y=16.4,label=expression(paste(italic("n")," = 48")),size=4)+
  annotate("text",x=2,y=21.2,label=expression(paste("43.7")),size=4)+
  annotate("text",x=2,y=16.4,label=expression(paste("46")),size=4)+
  annotate("text",x=3,y=21.2,label=expression(paste("45.8")),size=4)+
  annotate("text",x=3,y=16.4,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=21.2,label=expression(paste("60.2")),size=4)+
  annotate("text",x=4,y=16.4,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=21.2,label=expression(paste("53.0")),size=4)+
  annotate("text",x=5,y=16.4,label=expression(paste("41")),size=4)+
  annotate("text",x=6,y=21.2,label=expression(paste("63.1")),size=4)+
  annotate("text",x=6,y=16.4,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("bc"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("d"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("cd"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("a"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","D.PLA"],na.rm=T)+6.4,label=expression(paste(bold("a"))),size=5)

PLAdry_plot

# stat
lm1<-lm(D.PLA~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups

# PLWidry (PLW1dry)
PLWdry_plot<-ggplot(SRCdata,aes(x=Species,y=D.PLW1,fill=Metabolism))+
  geom_boxplot(lwd=0.2,fatten=5)+
  theme_minimal()+
  scale_fill_manual(values=c("#E1BE6A", "#40B0A6"))+
   ggtitle(expression(paste("PL Width"["dry"]," (%)")))+
  ylim(0,100)+
  theme(axis.text.y=element_text(size=13),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(angle=0,vjust=1,hjust=0.5,size=13,face="italic"),
        legend.position = "none",
        #legend.text=element_text(size=13),
        plot.title = element_text(size = 20, hjust = 0.5))+
  annotate("text",x=1,y=14,label=expression(paste(italic(bar("x"))," = 49.0")),size=4)+
  annotate("text",x=1,y=8,label=expression(paste(italic("n")," = 49")),size=4)+
  annotate("text",x=2,y=14,label=expression(paste("44.9")),size=4)+
  annotate("text",x=2,y=8,label=expression(paste("46")),size=4)+
  annotate("text",x=3,y=14,label=expression(paste("46.8")),size=4)+
  annotate("text",x=3,y=8,label=expression(paste("38")),size=4)+
  annotate("text",x=4,y=14,label=expression(paste("57.9")),size=4)+
  annotate("text",x=4,y=8,label=expression(paste("41")),size=4)+
  annotate("text",x=5,y=14,label=expression(paste("56.3")),size=4)+
  annotate("text",x=5,y=8,label=expression(paste("42")),size=4)+
  annotate("text",x=6,y=14,label=expression(paste("61.6")),size=4)+
  annotate("text",x=6,y=8,label=expression(paste("42")),size=4)+
  annotate("text",x=1,y=max(SRCdata[SRCdata$Species=="Avsa","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=2,y=max(SRCdata[SRCdata$Species=="Hovu","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=3,y=max(SRCdata[SRCdata$Species=="Trae","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("c"))),size=5)+
  annotate("text",x=4,y=max(SRCdata[SRCdata$Species=="Pegl","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("ab"))),size=5)+
  annotate("text",x=5,y=max(SRCdata[SRCdata$Species=="Zema","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("b"))),size=5)+
  annotate("text",x=6,y=max(SRCdata[SRCdata$Species=="Chga","D.PLW1"],na.rm=T)+8,label=expression(paste(bold("a"))),size=5)

PLWdry_plot

# stat
lm1<-lm(D.PLW1~Species,data=SRCdata)
anova(lm1)
tuk1<-HSD.test(lm1,"Species",group=T)
tuk1$groups


##all graphs for leaf structure

# Extract the legend
legend <- get_legend(
  PLTdry_plot +
    theme(legend.position = "right", text = element_text(size=20)) # Adjust position if needed
)

#legend <- plot(legend) #to check if it plots

#now remove the legend from the PLTdry_plot
PLTdry_plot <- PLTdry_plot + theme(legend.position = "none")

Percent_loss_dry<- ggarrange(PLTdry_plot, PLAdry_plot, PLWdry_plot, legend, ncol =2, nrow = 2)

Percent_loss_dry

ggsave(filename = "../results/Percentloss_dry.jpg", plot = Percent_loss_dry, width = 12, height = 8)

```

#Shrinkage - with RWC
```{r}

SRCdata = read.csv("../data/SRCdata.csv",header=TRUE) #same data as in Figure 3

#thickness
shrinkage_curve_thickness <- SRCdata %>%
  dplyr::select(Species, F.RWC , F.PLT ) %>%
  rename(psi = F.RWC) %>%
  rename(gs = F.PLT) %>% #for the script by Megan
  rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()
write.csv(x = shrinkage_curve_thickness, file = "../results/shrinkage/shrinkage_curve_thickness.csv")

#thickness with psi
SRCdata_PV = read.csv("../data/SRCdata_PV.csv",header=TRUE)
shrinkage_curve_thickness_psi <- SRCdata_PV %>%
  dplyr::select(Species, Psileaf.from.RWC , F.PLT ) %>%
  rename(psi = Psileaf.from.RWC) %>%
  rename(gs = F.PLT) %>% 
  rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()

shrinkage_curve_thickness_psi$psi <- shrinkage_curve_thickness_psi$psi*(-1)
write.csv(x = shrinkage_curve_thickness_psi, file = "../results/shrinkage/shrinkage_curve_thickness_psi.csv")


#AREA 
shrinkage_curve_area <- SRCdata %>%
  dplyr::select(Species, F.RWC , F.PLA ) %>%
  rename(psi = F.RWC) %>%
  rename(gs = F.PLA) %>% #for the script by Megan
  rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()
write.csv(x = shrinkage_curve_area, file = "../results/shrinkage/shrinkage_curve_area.csv")

#area with psi
SRCdata_PV = read.csv("../data/SRCdata_PV.csv",header=TRUE)
shrinkage_curve_area_psi <- SRCdata_PV %>%
  dplyr::select(Species, Psileaf.from.RWC , F.PLA ) %>%
  rename(psi = Psileaf.from.RWC) %>%
  rename(gs = F.PLA) %>% 
  rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()
shrinkage_curve_area_psi$psi <- shrinkage_curve_area_psi$psi*(-1)
write.csv(x = shrinkage_curve_area_psi, file = "../results/shrinkage/shrinkage_curve_area_psi.csv")


#Width
shrinkage_curve_width <- SRCdata %>%
  dplyr::select(Species, F.RWC , F.PLW1 ) %>%
  rename(psi = F.RWC) %>%
  rename(gs = F.PLW1) %>% #for the script by Megan
  rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()
write.csv(x = shrinkage_curve_width, file = "../results/shrinkage/shrinkage_curve_width.csv")

#width with psi
SRCdata_PV = read.csv("../data/SRCdata_PV.csv",header=TRUE)
shrinkage_curve_width_psi <- SRCdata_PV %>%
  dplyr::select(Species, Psileaf.from.RWC , F.PLW1 ) %>%
  rename(psi = Psileaf.from.RWC) %>%
  rename(gs = F.PLW1) %>% 
  rename(species = Species) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )%>%
  drop_na()
shrinkage_curve_width_psi$psi <- shrinkage_curve_width_psi$psi*(-1)
write.csv(x = shrinkage_curve_width_psi, file = "../results/shrinkage/shrinkage_curve_width_psi.csv")
```

##AVSA
```{r}

####################RWC############
SRCdata.avsa <- SRCdata%>% filter(Species == "Avsa")

#thickness
avsa_shrinkage_thickness <-  read.csv("../results/shrinkage/thickness/model_fitting_results.csv") %>%
  filter(Species == "Avsa") %>%
  filter(model =="Linear")

x_seq.avsa.thickness <-  seq(00, 100, length.out = length(SRCdata.avsa$F.PLT))
y_model.avsa.shrinkage.thickness <-  avsa_shrinkage_thickness$A + (x_seq.avsa.thickness*avsa_shrinkage_thickness$B) 


#area
avsa_shrinkage_area <-  read.csv("../results/shrinkage/area/model_fitting_results.csv") %>%
  filter(Species == "Avsa") %>%
  filter(model =="Exponential")

x_seq.avsa.area<-  seq(00, 100, length.out = length(SRCdata.avsa$F.PLA))
y_model.avsa.shrinkage.area<-  avsa_shrinkage_area$A * (exp(-avsa_shrinkage_area$B*x_seq.avsa.area)) 

#width
avsa_shrinkage_width <-  read.csv("../results/shrinkage/width/model_fitting_results.csv") %>%
  filter(Species == "Avsa") %>%
  filter(model =="Exponential")

x_seq.avsa.width <- seq(00, 100, length.out = length(SRCdata.avsa$F.PLW1))
y_model.avsa.shrinkage.width <-  avsa_shrinkage_width$A *(exp(-avsa_shrinkage_width$B*x_seq.avsa.width)) 


avsa_PLT25 = (25-avsa_shrinkage_thickness$A) / avsa_shrinkage_thickness$B
avsa_PLA25 = log(25/avsa_shrinkage_area$A) * (-1/avsa_shrinkage_area$B)
avsa_PLW25 = log(25/avsa_shrinkage_width$A) * (-1/avsa_shrinkage_width$B)

Avsa_shrinkage<-ggplot()+
  geom_point(data=SRCdata[SRCdata$Species=="Avsa",],aes(x=F.RWC,y=F.PLT),size=2,alpha=0.5,colour="#009E73")+
  geom_line(aes(x = x_seq.avsa.thickness, y = y_model.avsa.shrinkage.thickness), color = '#009E73', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Avsa",],aes(x=F.RWC,y=F.PLA),size=2,alpha=0.5,colour="#0072B2")+
  geom_line(aes(x = x_seq.avsa.area, y = y_model.avsa.shrinkage.area), color = '#0072B2', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Avsa",],aes(x=F.RWC,y=F.PLW1),size=2,alpha=0.5,fill="white",colour="#D55E00")+
 geom_line(aes(x = x_seq.avsa.width, y = y_model.avsa.shrinkage.width), color = '#D55E00', size=2, alpha=0.7)+
 geom_vline(xintercept=avsa_PLT25,color="#009E73",lty=5, linewidth = 1)+
  geom_vline(xintercept=avsa_PLA25,color="#0072B2",lty=5, linewidth = 1)+
  geom_vline(xintercept=avsa_PLW25,color="#D55E00",lty=5, linewidth = 1)+
  ylim(100,-10)+
  xlim(100,0)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=13),
        axis.text.y=element_text(size=12),
        axis.title.x=element_blank(),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  ylab(expression(paste("Leaf shrinkage (%)")))+
  xlab(expression(paste("Relative water content (%)")))+
  ggtitle("A. sativa")+
   annotate("text", x = 10, y = 95, label = "r^2 == 0.90", parse = TRUE, size = 5, fontface = "bold", color="#009E73")+ #in green
  annotate("text", x = 10, y = 90, label = "r^2 == 0.97", parse = TRUE, size = 5, fontface = "bold", color="#0072B2")+ #in blue
  annotate("text", x = 10, y = 85, label = "r^2 == 0.89", parse = TRUE,size = 5, fontface = "bold", color="#D55E00") # in orange
Avsa_shrinkage

#other plot
metab_cols <- c(C3 = "#6DB9F8", C4 = "#D9AB33")

Avsa_shrinkage <- ggplot() +
  
  # THICKNESS 
  geom_point(data = SRCdata[SRCdata$Species=="Avsa",],
    aes(x = F.RWC, y = F.PLT, 
        color = Metabolism,
        shape = "Thickness"),
    size = 2, alpha = 0.7 ) +
  geom_line(
    aes(x = x_seq.avsa.thickness,
        y = y_model.avsa.shrinkage.thickness,
        linetype = "Thickness",
        color = "C3"),     
    size = 1) +
  geom_vline(xintercept = avsa_PLT25, linetype = "solid", linewidth = 1) +
    
  # AREA 
  geom_point( data = SRCdata[SRCdata$Species=="Avsa",],
    aes(x = F.RWC, y = F.PLA, 
        color = Metabolism,
        shape = "Area"),
    size = 2, alpha = 0.7) +
  geom_line(aes(x = x_seq.avsa.area,
        y = y_model.avsa.shrinkage.area,
        linetype = "Area",
        color = "C3"),
    size = 1) +
  geom_vline(xintercept = avsa_PLA25, linetype = "dashed", linewidth = 1 ) +
  
    # WIDTH 
  geom_point( data = SRCdata[SRCdata$Species=="Avsa",],
    aes(x = F.RWC, y = F.PLW1, 
        color = Metabolism,
        shape = "Width"),
    size = 2, alpha = 0.7) +
  geom_line(
    aes(x = x_seq.avsa.width,
        y = y_model.avsa.shrinkage.width,
        linetype = "Width",
        color = "C3"),
    size = 1) +
  geom_vline(xintercept = avsa_PLW25, linetype = "dotted", linewidth = 1) +
  scale_color_manual(values = metab_cols, name = "Metabolism") +
  scale_shape_manual(values = c(Thickness=16, Area=17, Width=15),
                     name = "Trait") +
  scale_linetype_manual(values = c(Thickness="solid",
                                   Area="dashed",
                                   Width="dotted"),
                        name = "Trait") +
    ylim(100, -10) + xlim(100, 0) +
  theme_minimal(base_size = 14) +
  theme(axis.title.y=element_text(size=13, face= "plain"),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=13, face= "plain"),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  labs(y="Leaf shrinkage (%)",
       x="RWC (%)",
       title="A. sativa")

Avsa_shrinkage
```

##HOVU
```{r}
##### RWC####
SRCdata.hovu <- SRCdata%>% filter(Species == "Hovu")

#thickness
hovu_shrinkage_thickness <-  read.csv("../results/shrinkage/thickness/model_fitting_results.csv") %>%
  filter(Species == "Hovu") %>%
  filter(model =="Logistic")

x_seq.hovu.thickness <-  seq(00, 100, length.out = length(SRCdata.hovu$F.PLT))
y_model.hovu.shrinkage.thickness <- hovu_shrinkage_thickness$A / (1 + ((x_seq.hovu.thickness / hovu_shrinkage_thickness$C)^hovu_shrinkage_thickness$B))


#area
hovu_shrinkage_area <-  read.csv("../results/shrinkage/area/model_fitting_results.csv") %>%
  filter(Species == "Hovu") %>%
  filter(model =="Exponential")

x_seq.hovu.area<-  seq(00, 100, length.out = length(SRCdata.hovu$F.PLA))
y_model.hovu.shrinkage.area<-  hovu_shrinkage_area$A * (exp(-hovu_shrinkage_area$B*x_seq.hovu.area)) 

#width
hovu_shrinkage_width <-  read.csv("../results/shrinkage/width/model_fitting_results.csv") %>%
  filter(Species == "Hovu") %>%
  filter(model =="Exponential")

x_seq.hovu.width <- seq(00, 100, length.out = length(SRCdata.hovu$F.PLW1))
y_model.hovu.shrinkage.width <-  hovu_shrinkage_width$A *(exp(-hovu_shrinkage_width$B*x_seq.hovu.width)) 


hovu_PLT25 = hovu_shrinkage_thickness$C * ((hovu_shrinkage_thickness$A/25)-1)^(1/hovu_shrinkage_thickness$B)
hovu_PLA25 = log(25/hovu_shrinkage_area$A) * (-1/hovu_shrinkage_area$B)
hovu_PLW25 = log(25/hovu_shrinkage_width$A) * (-1/hovu_shrinkage_width$B)

# Hovu
Hovu_shrinkage<-ggplot()+
  geom_point(data=SRCdata[SRCdata$Species=="Hovu",],aes(x=F.RWC,y=F.PLT),size=2,alpha=0.5,colour="#009E73")+
  geom_line(aes(x = x_seq.hovu.thickness, y = y_model.hovu.shrinkage.thickness), color = '#009E73', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Hovu",],aes(x=F.RWC,y=F.PLA),size=2,alpha=0.5,colour="#0072B2")+
   geom_line(aes(x = x_seq.hovu.area, y = y_model.hovu.shrinkage.area), color = '#0072B2', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Hovu",],aes(x=F.RWC,y=F.PLW1),size=2,alpha=0.5,fill="white",colour="#D55E00")+
  geom_line(aes(x = x_seq.hovu.width, y = y_model.hovu.shrinkage.width), color = '#D55E00', size=2, alpha=0.7)+
   geom_vline(xintercept=hovu_PLT25,color="#009E73",lty=5, linewidth = 1)+
   geom_vline(xintercept=hovu_PLA25,color="#0072B2",lty=5, linewidth = 1)+
   geom_vline(xintercept=hovu_PLW25,color="#D55E00",lty=5, linewidth = 1)+
   ylim(100,-10)+
  xlim(100,0)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=12),
        axis.title.x=element_blank(),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  ylab(expression(paste("Leaf shrinkage (%)")))+
  xlab(expression(paste("Relative water content (%)")))+
  ggtitle("H. vulgare")+
   annotate("text", x = 10, y = 95, label = "r^2 == 0.93",parse = TRUE, size = 5, fontface = "bold", color="#009E73")+ #in green
  annotate("text", x = 10, y = 90, label = "r^2 == 0.93", parse = TRUE,size = 5, fontface = "bold", color="#0072B2")+ #in blue
  annotate("text", x = 10, y = 85, label = "r^2 == 0.82",parse = TRUE, size = 5, fontface = "bold", color="#D55E00") # in orange
Hovu_shrinkage

#other plot
metab_cols <- c(C3 = "#6DB9F8", C4 = "#D9AB33")

Hovu_shrinkage <- ggplot() +
  
  # THICKNESS 
  geom_point(data = SRCdata[SRCdata$Species=="Hovu",],
    aes(x = F.RWC, y = F.PLT, 
        color = Metabolism,
        shape = "Thickness"),
    size = 2, alpha = 0.7 ) +
  geom_line(
    aes(x = x_seq.hovu.thickness,
        y = y_model.hovu.shrinkage.thickness,
        linetype = "Thickness",
        color = "C3"),     
    size = 1) +
  geom_vline(xintercept = hovu_PLT25, linetype = "solid", linewidth = 1) +
    
  # AREA 
  geom_point( data = SRCdata[SRCdata$Species=="Hovu",],
    aes(x = F.RWC, y = F.PLA, 
        color = Metabolism,
        shape = "Area"),
    size = 2, alpha = 0.7) +
  geom_line(aes(x = x_seq.hovu.area,
        y = y_model.hovu.shrinkage.area,
        linetype = "Area",
        color = "C3"),
    size = 1) +
  geom_vline(xintercept = hovu_PLA25, linetype = "dashed", linewidth = 1 ) +
  
    # WIDTH 
  geom_point( data = SRCdata[SRCdata$Species=="Hovu",],
    aes(x = F.RWC, y = F.PLW1, 
        color = Metabolism,
        shape = "Width"),
    size = 2, alpha = 0.7) +
  geom_line(
    aes(x = x_seq.hovu.width,
        y = y_model.hovu.shrinkage.width,
        linetype = "Width",
        color = "C3"),
    size = 1) +
  geom_vline(xintercept = hovu_PLW25, linetype = "dotted", linewidth = 1) +
  scale_color_manual(values = metab_cols, name = "Metabolism") +
  scale_shape_manual(values = c(Thickness=16, Area=17, Width=15),
                     name = "Trait") +
  scale_linetype_manual(values = c(Thickness="solid",
                                   Area="dashed",
                                   Width="dotted"),
                        name = "Trait") +
    ylim(100, -10) + xlim(100, 0) +
  theme_minimal(base_size = 14) +
  theme(axis.title.y=element_text(size=13, face= "plain"),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=13, face= "plain"),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  labs(y="Leaf shrinkage (%)",
       x="RWC (%)",
       title="H. vulgare")

Hovu_shrinkage
```

##TRAE
```{r}
###RWC##########
SRCdata.trae <- SRCdata%>% filter(Species == "Trae")

#thickness
trae_shrinkage_thickness <-  read.csv("../results/shrinkage/thickness/model_fitting_results.csv") %>%
  filter(Species == "Trae") %>%
  filter(model =="Logistic")

x_seq.trae.thickness <-  seq(00, 100, length.out = length(SRCdata.trae$F.PLT))
y_model.trae.shrinkage.thickness <- trae_shrinkage_thickness$A / (1 + ((x_seq.trae.thickness / trae_shrinkage_thickness$C)^trae_shrinkage_thickness$B))


#area
trae_shrinkage_area <-  read.csv("../results/shrinkage/area/model_fitting_results.csv") %>%
  filter(Species == "Trae") %>%
  filter(model =="Exponential")

x_seq.trae.area<-  seq(00, 100, length.out = length(SRCdata.trae$F.PLA))
y_model.trae.shrinkage.area<-  trae_shrinkage_area$A * (exp(-trae_shrinkage_area$B*x_seq.trae.area)) 

#width
trae_shrinkage_width <-  read.csv("../results/shrinkage/width/model_fitting_results.csv") %>%
  filter(Species == "Trae") %>%
  filter(model =="Exponential")

x_seq.trae.width <- seq(00, 100, length.out = length(SRCdata.trae$F.PLW1))
y_model.trae.shrinkage.width <-  trae_shrinkage_width$A *(exp(-trae_shrinkage_width$B*x_seq.trae.width)) 


trae_PLT25 = trae_shrinkage_thickness$C * ((trae_shrinkage_thickness$A/25)-1)^(1/trae_shrinkage_thickness$B)
trae_PLA25 = log(25/trae_shrinkage_area$A) * (-1/trae_shrinkage_area$B)
trae_PLW25 = log(25/trae_shrinkage_width$A) * (-1/trae_shrinkage_width$B)

# Trae
Trae_shrinkage<-ggplot()+
  geom_point(data=SRCdata[SRCdata$Species=="Trae",],aes(x=F.RWC,y=F.PLT),size=2,alpha=0.5,colour="#009E73")+
  geom_line(aes(x = x_seq.trae.thickness, y = y_model.trae.shrinkage.thickness), color = '#009E73', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Trae",],aes(x=F.RWC,y=F.PLA),size=2,alpha=0.5,colour="#0072B2")+
   geom_line(aes(x = x_seq.trae.area, y = y_model.trae.shrinkage.area), color = '#0072B2', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Trae",],aes(x=F.RWC,y=F.PLW1),size=2,alpha=0.5,fill="white",colour="#D55E00")+
  geom_line(aes(x = x_seq.trae.width, y = y_model.trae.shrinkage.width), color = '#D55E00', size=2, alpha=0.7)+
   geom_vline(xintercept=trae_PLT25,color="#009E73",lty=5, linewidth = 1)+
   geom_vline(xintercept=trae_PLA25,color="#0072B2",lty=5, linewidth = 1)+
   geom_vline(xintercept=trae_PLW25,color="#D55E00",lty=5, linewidth = 1)+
   ylim(100,-10)+
  xlim(100,0)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=12),
        axis.title.x=element_blank(),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  ylab(expression(paste("Leaf shrinkage (%)")))+
  xlab(expression(paste("Relative water content (%)")))+
  ggtitle("T. aestivum")+
   annotate("text", x = 10, y = 95, label = "r^2 == 0.83",parse = TRUE, size = 5, fontface = "bold", color="#009E73")+ #in green
  annotate("text", x = 10, y = 90, label = "r^2 == 0.94", parse = TRUE,size = 5, fontface = "bold", color="#0072B2")+ #in blue
  annotate("text", x = 10, y = 85, label = "r^2 == 0.92", parse = TRUE,size = 5, fontface = "bold", color="#D55E00") # in orange
Trae_shrinkage

#other plot
metab_cols <- c(C3 = "#6DB9F8", C4 = "#D9AB33")

Trae_shrinkage <- ggplot() +
  
  # THICKNESS 
  geom_point(data = SRCdata[SRCdata$Species=="Trae",],
    aes(x = F.RWC, y = F.PLT, 
        color = Metabolism,
        shape = "Thickness"),
    size = 2, alpha = 0.7 ) +
  geom_line(
    aes(x = x_seq.trae.thickness,
        y = y_model.trae.shrinkage.thickness,
        linetype = "Thickness",
        color = "C3"),     
    size = 1) +
  geom_vline(xintercept = trae_PLT25, linetype = "solid", linewidth = 1) +
    
  # AREA 
  geom_point( data = SRCdata[SRCdata$Species=="Trae",],
    aes(x = F.RWC, y = F.PLA, 
        color = Metabolism,
        shape = "Area"),
    size = 2, alpha = 0.7) +
  geom_line(aes(x = x_seq.trae.area,
        y = y_model.trae.shrinkage.area,
        linetype = "Area",
        color = "C3"),
    size = 1) +
  geom_vline(xintercept = trae_PLA25, linetype = "dashed", linewidth = 1 ) +
  
    # WIDTH 
  geom_point( data = SRCdata[SRCdata$Species=="Trae",],
    aes(x = F.RWC, y = F.PLW1, 
        color = Metabolism,
        shape = "Width"),
    size = 2, alpha = 0.7) +
  geom_line(
    aes(x = x_seq.trae.width,
        y = y_model.trae.shrinkage.width,
        linetype = "Width",
        color = "C3"),
    size = 1) +
  geom_vline(xintercept = trae_PLW25, linetype = "dotted", linewidth = 1) +
  scale_color_manual(values = metab_cols, name = "Metabolism") +
  scale_shape_manual(values = c(Thickness=16, Area=17, Width=15),
                     name = "Trait") +
  scale_linetype_manual(values = c(Thickness="solid",
                                   Area="dashed",
                                   Width="dotted"),
                        name = "Trait") +
    ylim(100, -10) + xlim(100, 0) +
  theme_minimal(base_size = 14) +
  theme(axis.title.y=element_text(size=13, face= "plain"),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=13, face= "plain"),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  labs(y="Leaf shrinkage (%)",
       x="RWC (%)",
       title="T. aestivum")

Trae_shrinkage
```

##PEGL
```{r}

######RWC#########
SRCdata.pegl <- SRCdata%>% filter(Species == "Pegl")

#thickness
pegl_shrinkage_thickness <-  read.csv("../results/shrinkage/thickness/model_fitting_results.csv") %>%
  filter(Species == "Pegl") %>%
  filter(model =="Linear")

x_seq.pegl.thickness <-  seq(00, 100, length.out = length(SRCdata.pegl$F.PLT))
y_model.pegl.shrinkage.thickness <-  pegl_shrinkage_thickness$A + (x_seq.pegl.thickness*pegl_shrinkage_thickness$B) 


#area
pegl_shrinkage_area <-  read.csv("../results/shrinkage/area/model_fitting_results.csv") %>%
  filter(Species == "Pegl") %>%
  filter(model =="Exponential")

x_seq.pegl.area<-  seq(00, 100, length.out = length(SRCdata.pegl$F.PLA))
y_model.pegl.shrinkage.area<-  pegl_shrinkage_area$A * (exp(-pegl_shrinkage_area$B*x_seq.pegl.area)) 

#width
pegl_shrinkage_width <-  read.csv("../results/shrinkage/width/model_fitting_results.csv") %>%
  filter(Species == "Pegl") %>%
  filter(model =="Linear")

x_seq.pegl.width <- seq(00, 100, length.out = length(SRCdata.pegl$F.PLW1))
y_model.pegl.shrinkage.width <-  pegl_shrinkage_width$A + pegl_shrinkage_width$B*x_seq.pegl.width


pegl_PLT25 = (25-pegl_shrinkage_thickness$A) / pegl_shrinkage_thickness$B
pegl_PLA25 = log(25/pegl_shrinkage_area$A) * (-1/pegl_shrinkage_area$B)
pegl_PLW25 = (25-pegl_shrinkage_width$A) / pegl_shrinkage_width$B
  
# Pegl
Pegl_shrinkage<-ggplot()+
  geom_point(data=SRCdata[SRCdata$Species=="Pegl",],aes(x=F.RWC,y=F.PLT),size=2,alpha=0.5,colour="#009E73")+
 geom_line(aes(x = x_seq.pegl.thickness, y = y_model.pegl.shrinkage.thickness), color = '#009E73', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Pegl",],aes(x=F.RWC,y=F.PLA),size=2,alpha=0.5,colour="#0072B2")+
   geom_line(aes(x = x_seq.pegl.area, y = y_model.pegl.shrinkage.area), color = '#0072B2', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Pegl",],aes(x=F.RWC,y=F.PLW1),size=2,alpha=0.5,fill="white",colour="#D55E00")+
  geom_line(aes(x = x_seq.pegl.width, y = y_model.pegl.shrinkage.width), color = '#D55E00', size=2, alpha=0.7)+
   geom_vline(xintercept=pegl_PLT25,color="#009E73",lty=5, linewidth = 1)+
   geom_vline(xintercept=pegl_PLA25,color="#0072B2",lty=5, linewidth = 1)+
   geom_vline(xintercept=pegl_PLW25,color="#D55E00",lty=5, linewidth = 1)+
   ylim(100,-10)+
  xlim(100,0)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=13),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  ylab(expression(paste("Leaf shrinkage (%)")))+
  xlab(expression(paste("RWC (%)")))+
  ggtitle("P. glaucum")+
   annotate("text", x = 10, y = 95, label = "r^2 == 0.81", parse = TRUE,size = 5, fontface = "bold", color="#009E73")+ #in green
  annotate("text", x = 10, y = 90, label = "r^2 == 0.96", parse = TRUE,size = 5, fontface = "bold", color="#0072B2")+ #in blue
  annotate("text", x = 10, y = 85, label = "r^2 == 0.90", parse = TRUE,size = 5, fontface = "bold", color="#D55E00") # in orange
Pegl_shrinkage

#other plot
metab_cols <- c(C3 = "#6DB9F8", C4 = "#D9AB33")

Pegl_shrinkage <- ggplot() +
  
  # THICKNESS 
  geom_point(data = SRCdata[SRCdata$Species=="Pegl",],
    aes(x = F.RWC, y = F.PLT, 
        color = Metabolism,
        shape = "Thickness"),
    size = 2, alpha = 0.7 ) +
  geom_line(
    aes(x = x_seq.pegl.thickness,
        y = y_model.pegl.shrinkage.thickness,
        linetype = "Thickness",
        color = "C4"),     
    size = 1) +
  geom_vline(xintercept = pegl_PLT25, linetype = "solid", linewidth = 1) +
    
  # AREA 
  geom_point( data = SRCdata[SRCdata$Species=="Pegl",],
    aes(x = F.RWC, y = F.PLA, 
        color = Metabolism,
        shape = "Area"),
    size = 2, alpha = 0.7) +
  geom_line(aes(x = x_seq.pegl.area,
        y = y_model.pegl.shrinkage.area,
        linetype = "Area",
        color = "C4"),
    size = 1) +
  geom_vline(xintercept = pegl_PLA25, linetype = "dashed", linewidth = 1 ) +
  
    # WIDTH 
  geom_point( data = SRCdata[SRCdata$Species=="Pegl",],
    aes(x = F.RWC, y = F.PLW1, 
        color = Metabolism,
        shape = "Width"),
    size = 2, alpha = 0.7) +
  geom_line(
    aes(x = x_seq.pegl.width,
        y = y_model.pegl.shrinkage.width,
        linetype = "Width",
        color = "C4"),
    size = 1) +
  geom_vline(xintercept = pegl_PLW25, linetype = "dotted", linewidth = 1) +
  scale_color_manual(values = metab_cols, name = "Metabolism") +
  scale_shape_manual(values = c(Thickness=16, Area=17, Width=15),
                     name = "Trait") +
  scale_linetype_manual(values = c(Thickness="solid",
                                   Area="dashed",
                                   Width="dotted"),
                        name = "Trait") +
    ylim(100, -10) + xlim(100, 0) +
  theme_minimal(base_size = 14) +
  theme(axis.title.y=element_text(size=13, face= "plain"),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=13, face= "plain"),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  labs(y="Leaf shrinkage (%)",
       x="RWC (%)",
       title="P. glaucum")

Pegl_shrinkage
```

##ZEMA
```{r}

#######RWC###########
SRCdata.zema <- SRCdata%>% filter(Species == "Zema")
#thickness
zema_shrinkage_thickness <-  read.csv("../results/shrinkage/thickness/model_fitting_results.csv") %>%
  filter(Species == "Zema") %>%
  filter(model =="Logistic")

x_seq.zema.thickness <-  seq(00, 100, length.out = length(SRCdata.zema$F.PLT))
y_model.zema.shrinkage.thickness <- zema_shrinkage_thickness$A / (1 + ((x_seq.zema.thickness / zema_shrinkage_thickness$C)^zema_shrinkage_thickness$B))


#area
zema_shrinkage_area <-  read.csv("../results/shrinkage/area/model_fitting_results.csv") %>%
  filter(Species == "Zema") %>%
  filter(model =="Exponential")

x_seq.zema.area<-  seq(00, 100, length.out = length(SRCdata.zema$F.PLA))
y_model.zema.shrinkage.area<-  zema_shrinkage_area$A * (exp(-zema_shrinkage_area$B*x_seq.zema.area)) 

#width
zema_shrinkage_width <-  read.csv("../results/shrinkage/width/model_fitting_results.csv") %>%
  filter(Species == "Zema") %>%
  filter(model =="Exponential")

x_seq.zema.width <- seq(00, 100, length.out = length(SRCdata.zema$F.PLW1))
y_model.zema.shrinkage.width <-  zema_shrinkage_width$A *(exp(-zema_shrinkage_width$B*x_seq.zema.width)) 


zema_PLT25 = zema_shrinkage_thickness$C * ((zema_shrinkage_thickness$A/25)-1)^(1/zema_shrinkage_thickness$B)
zema_PLA25 = log(25/zema_shrinkage_area$A) * (-1/zema_shrinkage_area$B)
zema_PLW25 = log(25/zema_shrinkage_width$A) * (-1/zema_shrinkage_width$B)

#plot
Zema_shrinkage<-ggplot()+
  geom_point(data=SRCdata[SRCdata$Species=="Zema",],aes(x=F.RWC,y=F.PLT),size=2,alpha=0.5,colour="#009E73")+
  geom_line(aes(x = x_seq.zema.thickness, y = y_model.zema.shrinkage.thickness), color = '#009E73', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Zema",],aes(x=F.RWC,y=F.PLA),size=2,alpha=0.5,colour="#0072B2")+
  geom_line(aes(x = x_seq.zema.area, y = y_model.zema.shrinkage.area), color = '#0072B2', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Zema",],aes(x=F.RWC,y=F.PLW1),size=2,alpha=0.5,fill="white",colour="#D55E00")+
  geom_line(aes(x = x_seq.zema.width, y = y_model.zema.shrinkage.width), color = '#D55E00', size=2, alpha=0.7)+
   geom_vline(xintercept=zema_PLT25,color="#009E73",lty=5, linewidth = 1)+
   geom_vline(xintercept=zema_PLA25,color="#0072B2",lty=5, linewidth = 1)+
   geom_vline(xintercept=zema_PLW25,color="#D55E00",lty=5, linewidth = 1)+
   ylim(100,-10)+
  xlim(100,0)+
  theme_minimal()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=13),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  ylab(expression(paste("Leaf shrinkage (%)")))+
  xlab(expression(paste("RWC (%)")))+
  ggtitle("Z. mays")+
   annotate("text", x = 10, y = 95, label = "r^2 == 0.90", parse = TRUE,size = 5, fontface = "bold", color="#009E73")+ #in green
  annotate("text", x = 10, y = 90, label = "r^2 == 0.89", parse = TRUE,size = 5, fontface = "bold", color="#0072B2")+ #in blue
  annotate("text", x = 10, y = 85, label = "r^2 == 0.76", parse = TRUE,size = 5, fontface = "bold", color="#D55E00") # in orange
Zema_shrinkage

#other plot
metab_cols <- c(C3 = "#6DB9F8", C4 = "#D9AB33")

Zema_shrinkage <- ggplot() +
  
  # THICKNESS 
  geom_point(data = SRCdata[SRCdata$Species=="Zema",],
    aes(x = F.RWC, y = F.PLT, 
        color = Metabolism,
        shape = "Thickness"),
    size = 2, alpha = 0.7 ) +
  geom_line(
    aes(x = x_seq.zema.thickness,
        y = y_model.zema.shrinkage.thickness,
        linetype = "Thickness",
        color = "C4"),     
    size = 1) +
  geom_vline(xintercept = zema_PLT25, linetype = "solid", linewidth = 1) +
    
  # AREA 
  geom_point( data = SRCdata[SRCdata$Species=="Zema",],
    aes(x = F.RWC, y = F.PLA, 
        color = Metabolism,
        shape = "Area"),
    size = 2, alpha = 0.7) +
  geom_line(aes(x = x_seq.zema.area,
        y = y_model.zema.shrinkage.area,
        linetype = "Area",
        color = "C4"),
    size = 1) +
  geom_vline(xintercept = zema_PLA25, linetype = "dashed", linewidth = 1 ) +
  
    # WIDTH 
  geom_point( data = SRCdata[SRCdata$Species=="Zema",],
    aes(x = F.RWC, y = F.PLW1, 
        color = Metabolism,
        shape = "Width"),
    size = 2, alpha = 0.7) +
  geom_line(
    aes(x = x_seq.zema.width,
        y = y_model.zema.shrinkage.width,
        linetype = "Width",
        color = "C4"),
    size = 1) +
  geom_vline(xintercept = zema_PLW25, linetype = "dotted", linewidth = 1) +
  scale_color_manual(values = metab_cols, name = "Metabolism") +
  scale_shape_manual(values = c(Thickness=16, Area=17, Width=15),
                     name = "Trait") +
  scale_linetype_manual(values = c(Thickness="solid",
                                   Area="dashed",
                                   Width="dotted"),
                        name = "Trait") +
    ylim(100, -10) + xlim(100, 0) +
  theme_minimal(base_size = 14) +
  theme(axis.title.y=element_text(size=13, face= "plain"),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=13, face= "plain"),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  labs(y="Leaf shrinkage (%)",
       x="RWC (%)",
       title="Z. mays")

Zema_shrinkage
```

##CHGA
```{r}

#######RWC###############
SRCdata.chga <- SRCdata%>% filter(Species == "Chga")

#thickness
chga_shrinkage_thickness <-  read.csv("../results/shrinkage/thickness/model_fitting_results.csv") %>%
  filter(Species == "Chga") %>%
  filter(model =="Linear")

x_seq.chga.thickness <-  seq(00, 100, length.out = length(SRCdata.chga$F.PLT))
y_model.chga.shrinkage.thickness <-  chga_shrinkage_thickness$A + (x_seq.chga.thickness*chga_shrinkage_thickness$B) 


#area
chga_shrinkage_area <-  read.csv("../results/shrinkage/area/model_fitting_results.csv") %>%
  filter(Species == "Chga") %>%
  filter(model =="Exponential")

x_seq.chga.area<-  seq(00, 100, length.out = length(SRCdata.chga$F.PLA))
y_model.chga.shrinkage.area<-  chga_shrinkage_area$A * (exp(-chga_shrinkage_area$B*x_seq.chga.area)) 

#width
chga_shrinkage_width <-  read.csv("../results/shrinkage/width/model_fitting_results.csv") %>%
  filter(Species == "Chga") %>%
  filter(model =="Exponential")

x_seq.chga.width <- seq(00, 100, length.out = length(SRCdata.chga$F.PLW1))
y_model.chga.shrinkage.width <-  chga_shrinkage_width$A *(exp(-chga_shrinkage_width$B*x_seq.chga.width)) 


chga_PLT25 = (25-chga_shrinkage_thickness$A) / chga_shrinkage_thickness$B
chga_PLA25 = log(25/chga_shrinkage_area$A) * (-1/chga_shrinkage_area$B)
chga_PLW25 = log(25/chga_shrinkage_width$A) * (-1/chga_shrinkage_width$B)

# Plot
Chga_shrinkage<-ggplot()+
  geom_point(data=SRCdata[SRCdata$Species=="Chga",],aes(x=F.RWC,y=F.PLT),size=2,alpha=0.5,colour="#009E73")+
 geom_line(aes(x = x_seq.chga.thickness, y = y_model.chga.shrinkage.thickness), color = '#009E73', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Chga",],aes(x=F.RWC,y=F.PLA),size=2,alpha=0.5,colour="#0072B2")+
  geom_line(aes(x = x_seq.chga.area, y = y_model.chga.shrinkage.area), color = '#0072B2', size=2, alpha=0.7)+
  geom_point(data=SRCdata[SRCdata$Species=="Chga",],aes(x=F.RWC,y=F.PLW1),size=2,alpha=0.5,fill="white",colour="#D55E00")+
  geom_line(aes(x = x_seq.chga.width, y = y_model.chga.shrinkage.width), color = '#D55E00', size=2, alpha=0.7)+
   geom_vline(xintercept=chga_PLT25,color="#009E73",lty=5, linewidth = 1)+
   geom_vline(xintercept=chga_PLA25,color="#0072B2",lty=5, linewidth = 1)+
   geom_vline(xintercept=chga_PLW25,color="#D55E00",lty=5, linewidth = 1)+
   ylim(100,-10)+
  xlim(100,0)+
  theme_minimal()+
  theme(axis.title.y=element_text(size=13),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=13),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  ylab(expression(paste("Leaf shrinkage (%)")))+
  xlab(expression(paste("RWC (%)")))+
  ggtitle("C. gayana")+
   annotate("text", x = 10, y = 95, label = "r^2 == 0.81", parse = TRUE,size = 5, fontface = "bold", color="#009E73")+ #in green
  annotate("text", x = 10, y = 90, label = "r^2 == 0.97", parse = TRUE,size = 5, fontface = "bold", color="#0072B2")+ #in blue
  annotate("text", x = 10, y = 85, label = "r^2 == 0.93",parse = TRUE, size = 5, fontface = "bold", color="#D55E00") # in orange
Chga_shrinkage

#other plot
metab_cols <- c(C3 = "#6DB9F8", C4 = "#D9AB33")

Chga_shrinkage <- ggplot() +
  
  # THICKNESS 
  geom_point(data = SRCdata[SRCdata$Species=="Chga",],
    aes(x = F.RWC, y = F.PLT, 
        color = Metabolism,
        shape = "Thickness"),
    size = 2, alpha = 0.7 ) +
  geom_line(
    aes(x = x_seq.chga.thickness,
        y = y_model.chga.shrinkage.thickness,
        linetype = "Thickness",
        color = "C4"),     
    size = 1) +
  geom_vline(xintercept = chga_PLT25, linetype = "solid", linewidth = 1) +
    
  # AREA 
  geom_point( data = SRCdata[SRCdata$Species=="Chga",],
    aes(x = F.RWC, y = F.PLA, 
        color = Metabolism,
        shape = "Area"),
    size = 2, alpha = 0.7) +
  geom_line(aes(x = x_seq.chga.area,
        y = y_model.chga.shrinkage.area,
        linetype = "Area",
        color = "C4"),
    size = 1) +
  geom_vline(xintercept = chga_PLA25, linetype = "dashed", linewidth = 1 ) +
  
    # WIDTH 
  geom_point( data = SRCdata[SRCdata$Species=="Chga",],
    aes(x = F.RWC, y = F.PLW1, 
        color = Metabolism,
        shape = "Width"),
    size = 2, alpha = 0.7) +
  geom_line(
    aes(x = x_seq.chga.width,
        y = y_model.chga.shrinkage.width,
        linetype = "Width",
        color = "C4"),
    size = 1) +
  geom_vline(xintercept = chga_PLW25, linetype = "dotted", linewidth = 1) +
  scale_color_manual(values = metab_cols, name = "Metabolism") +
  scale_shape_manual(values = c(Thickness=16, Area=17, Width=15),
                     name = "Trait") +
  scale_linetype_manual(values = c(Thickness="solid",
                                   Area="dashed",
                                   Width="dotted"),
                        name = "Trait") +
    ylim(100, -10) + xlim(100, 0) +
  theme_minimal(base_size = 14) +
  theme(axis.title.y=element_text(size=13, face= "plain"),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=13, face= "plain"),
        axis.text.x=element_text(size=12),
        strip.text=element_text(size=13, face="italic"),
        title = element_text(face = "bold.italic"),
        legend.position = "none") +
  labs(y="Leaf shrinkage (%)",
       x="RWC (%)",
       title="C. gayana")

Chga_shrinkage
```

#ALL PLOTS
```{r}
### all plots ----
shrinkage_plot <- ggarrange(Avsa_shrinkage, Hovu_shrinkage, Trae_shrinkage, Chga_shrinkage, Pegl_shrinkage, Zema_shrinkage,  ncol =3, nrow = 2, labels = c("A", "B", "C", "D", "E", "F"))

shrinkage_plot 

ggsave(filename = "../results/FigureS5.jpg", plot = shrinkage_plot, width = 12, height = 8)
```


#PL50
```{r}
shrinkage <- tribble(
  ~Species, ~RWCPLT25, ~RWCPLA25, ~RWCPLW25,
  "Avsa", avsa_PLT25, avsa_PLA25, avsa_PLW25,
  "Hovu", hovu_PLT25, hovu_PLA25, hovu_PLW25,
  "Trae", trae_PLT25, trae_PLA25, trae_PLW25,
  "Pegl", pegl_PLT25, pegl_PLA25, pegl_PLW25,
  "Chga", chga_PLT25, chga_PLA25, chga_PLW25,
  "Zema", zema_PLT25, zema_PLA25, zema_PLW25)

write.csv(shrinkage, file = "../results/shrinkage_P25.csv")
```


##MicroCT graph

```{r}
microCT <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Post_doc_CalState_LA/Miquel_data/data/MicroCT_grasses_23Sept25_MB.xlsx", 
    sheet = "calcul") %>% select(Species, Metabolism,`Psi leaf`, `Embolism_midrib_%`, `RWC leaf`) %>%
  drop_na() %>%
   mutate(`Psi leaf` = round(as.numeric(`Psi leaf`), 2))

model_rwc <- lm(as.numeric(`RWC leaf`) ~ `Psi leaf`, data = microCT)
summary(model_rwc)


model_rwc <- lm(as.numeric(`RWC leaf`) ~ `Psi leaf`, data = microCT)
a <- coef(model_rwc)[1]     # intercept
b <- coef(model_rwc)[2]     # slope

FigureSI <- ggplot(microCT, aes(x = `Psi leaf`, y = `Embolism_midrib_%`, color = Metabolism)) +
  geom_point(size = 4) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  
  scale_x_continuous(
    name = expression(paste(Psi["leaf"]," (MPa)")),
    sec.axis = sec_axis(
      ~ a + b * ., 
      name = "RWC (%)"
    )
  ) +
  
  ylab("% Emobilized Conduits") +
  theme_minimal(base_size = 10) +
  theme(
    legend.title = element_blank(),
    axis.text.y = element_text(size = 10)
  )

FigureSI

ggsave(filename = "../results/FiguremicroCT.jpg", plot = FigureSI, width = 4, height = 3)
```


#/////// TABLE 1

## summary Max & P50 
```{r}
# Max values
all_species_summary_max <- tribble(
  ~Species, ~Amax, ~gsmax,~Kleafmax,~Krootmax,~Kplantmax, ~WUEimax,
  "Avsa",   avsa_A_sig$Kmax_at_0.1MPa, avsa_g_sig$Kmax_at_0.1MPa, avsa_K$Kmax_at_0.1MPa, avsa_Kroot_summary$Kmax_at_0.1MPa, avsa_Kplant_summary$Kmax_at_0.1MPa, avsa_W$a,
  "Hovu",   hovu_A_sig$Kmax_at_0.1MPa, hovu_g_sig$Kmax_at_0.1MPa, hovu_K$Kmax_at_0.1MPa, hovu_Kroot_summary$Kmax_at_0.1MPa, hovu_Kplant_summary$Kmax_at_0.1MPa, hovu_W$a,
  "Trae",   trae_A_sig$Kmax_at_0.1MPa, trae_g_sig$Kmax_at_0.1MPa, trae_K$Kmax_at_0.1MPa, trae_Kroot_summary$Kmax_at_0.1MPa, trae_Kplant_summary$Kmax_at_0.1MPa, trae_W$a,
  "Pegl",   Pegl_A_sig$Kmax_at_0.1MPa, pegl_g_sig$Kmax_at_0.1MPa, pegl_K$Kmax_at_0.1MPa, pegl_Kroot_summary$Kmax_at_0.1MPa, pegl_Kplant_summary$Kmax_at_0.1MPa, pegl_W$a,
  "Chga",   chga_A_sig$Kmax_at_0.1MPa, chga_g_sig$Kmax_at_0.1MPa, chga_K$Kmax_at_0.1MPa, chga_Kroot_summary$Kmax_at_0.1MPa, chga_Kplant_summary$Kmax_at_0.1MPa, chga_W$a,
  "Zema",   zema_A_sig$Kmax_at_0.1MPa, zema_g_sig$Kmax_at_0.1MPa, zema_K$Kmax_at_0.1MPa, zema_Kroot_summary$Kmax_at_0.1MPa, zema_Kplant_summary$Kmax_at_0.1MPa, zema_W$a
) %>%
  mutate(Metabolism = c("C3","C3","C3","C4","C4","C4"))

# -----------------------------
# P50 values
all_species_summary_P50 <- tribble(
  ~Species, ~PA50,~Pgs50,~PKleaf50, ~PKroot50,~PKplant50, ~PWUEimax,
  "Avsa",   -avsa_A_sig$P50_0.1kmax,         -avsa_g_sig$P50_0.1kmax,          -avsa_K$P50_0.1kmax,           -avsa_Kroot_summary$P50_0.1kmax,    -avsa_Kplant_summary$P50_0.1kmax, -avsa_W$mu,
  "Hovu",   -hovu_A_sig$P50_0.1kmax,         -hovu_g_sig$P50_0.1kmax,          -hovu_K$P50_0.1kmax,           -hovu_Kroot_summary$P50_0.1kmax,    -hovu_Kplant_summary$P50_0.1kmax, -hovu_W$mu,
  "Trae",   -trae_A_sig$P50_0.1kmax,         -trae_g_sig$P50_0.1kmax,          -trae_K$P50_0.1kmax,           -trae_Kroot_summary$P50_0.1kmax,    -trae_Kplant_summary$P50_0.1kmax,-trae_W$mu,
  "Pegl",   -Pegl_A_sig$P50_0.1kmax,         -pegl_g_sig$P50_0.1kmax,          -pegl_K$P50_0.1kmax,           -pegl_Kroot_summary$P50_0.1kmax,    -pegl_Kplant_summary$P50_0.1kmax,-pegl_W$mu,
  "Chga",   -chga_A_sig$P50_0.1kmax,         -chga_g_sig$P50_0.1kmax,          -chga_K$P50_0.1kmax,           -chga_Kroot_summary$P50_0.1kmax,    -chga_Kplant_summary$P50_0.1kmax,-chga_W$mu,
  "Zema",   -zema_A_sig$P50_0.1kmax,         -zema_g_sig$P50_0.1kmax,          -zema_K$P50_0.1kmax,           -zema_Kroot_summary$P50_0.1kmax,    -zema_Kplant_summary$P50_0.1kmax, -zema_W$mu
)


all_species_summary <- left_join(all_species_summary_max, all_species_summary_P50)

all_species_summary <- all_species_summary %>%
  mutate(Kleafmax_gsmax_ratio = Kleafmax/gsmax*10^-3)

write.csv(all_species_summary, file = "../results/Table1_max_P50.csv")

all_species_summary <- read.csv("../results/Table1_max_P50.csv")

  
#mean C3 and C4
mean_metabolism <- ddply(
  all_species_summary,
  c("Metabolism"),
  summarise,
  m.Amax = mean(Amax,    na.rm = TRUE),
  m.gsmax = mean(gsmax,  na.rm = TRUE),
  m.Kleafmax = mean(Kleafmax, na.rm = TRUE),
  m.Krootmax = mean(Krootmax, na.rm = TRUE),
  m.Kplantmax = mean(Kplantmax, na.rm = TRUE),
  m.WUEimax = mean(WUEimax, na.rm = TRUE),
  m.PA50 = mean(PA50, na.rm = TRUE),
  m.Pgs50 = mean(Pgs50, na.rm = TRUE),
  m.PKleaf50 = mean(PKleaf50, na.rm = TRUE),
  m.PKroot50 = mean(PKroot50, na.rm = TRUE),
  m.PKplant50 = mean(PKplant50, na.rm = TRUE),
  m.PWUEimax = mean(PWUEimax, na.rm = TRUE),
  m.Kleafmax_gsmax_ratio = mean(Kleafmax_gsmax_ratio, na.rm = TRUE))

# t-test comparing species means between C3 and C4
t_Amax <- t.test(log(abs(Amax)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = all_species_summary )
t_gsmax <- t.test(log(abs(gsmax)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = all_species_summary )
t_Kleafmax <- t.test(log(abs(Kleafmax)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = all_species_summary )
t_Kleafmax_gsmax <- t.test(log(abs(Kleafmax_gsmax_ratio)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = all_species_summary )
t_Krootmax<- t.test(log(abs(Krootmax)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data= all_species_summary )
t_Kplantmax <- t.test(log(abs(Kplantmax))~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = all_species_summary )
t_WUEimax <- t.test(log(abs(WUEimax)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = all_species_summary )


t_PA50x <- t.test(log(abs(PA50)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = all_species_summary )
t_Pgs50 <- t.test(log(abs(Pgs50)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = all_species_summary )
t_PKleaf50 <- t.test(log(abs(PKleaf50)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = all_species_summary )
t_PKroot50<- t.test(log(abs(PKroot50)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data= all_species_summary )
t_PKplant50<- t.test(log(abs(PKplant50))~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = all_species_summary )
t_PWUEimax <- t.test(log(abs(PWUEimax)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = all_species_summary )

#n individuals
A <- rbind(GEx_A_curve_avsa, GEx_A_curve_hovu, GEx_A_curve_trae, GEx_A_curve_pegl, GEx_A_curve_zema, GEx_A_curve_chga) #17-34
gs <- rbind(GEx_g_curve_avsa, GEx_g_curve_hovu, GEx_g_curve_trae, GEx_g_curve_chga, GEx_g_curve_pegl, GEx_g_curve_zema) #17-34

Kleaf <- rbind(Kleaf_avsa, Kleaf_hovu, Kleaf_trae, Kleaf_pegl, Kleaf_zema, Kleaf_chga) #40-66
Kplant <- rbind(Kplant_avsa, Kplant_hovu, Kplant_trae, Kplant_pegl, Kplant_zema, Kplant_chga) #13-38
Kroot <- rbind(Kroot_avsa, Kroot_hovu, Kroot_trae, Kroot_pegl, Kroot_zema, Kroot_chga) #13-38
WUE <- rbind(data_W_avsa, data_W_hovu, data_W_trae, data_W_pegl, data_W_chga, data_W_zema) #17-33
```

## PV data

```{r}
# PV data
PVdata <- read_xlsx("../data/C3C4 Grasses - PV.xlsx", sheet = "C3C4G PV R") %>%
  mutate(
    Metabolism = factor(Metabolism),
    Species = factor(Species, levels=c("Avsa","Hovu","Trae","Pegl","Zema","Chga")),
    T.LV  = T.LA * T.LT / 10,
    LMA   = DW/1000/(T.LA/10000),
    LD    = DW/1000/T.LV,
    LDMC  = DW/TW,
    em     = em.)

m.PVdata <- ddply(PVdata, c("Metabolism","Species"), summarise,
                  m.osp.tlp=mean(osp.tlp,na.rm=TRUE),
                  m.osp.ft=mean(osp.ft,na.rm=TRUE),
                  m.rwc.tlp=mean(rwc.tlp,na.rm=TRUE),
                  m.cft=mean(cft,na.rm=TRUE),
                  m.ctlp=mean(ctlp,na.rm=TRUE),
                  m.em=mean(em,na.rm=TRUE),
                  n.osp.tlp=sum(!is.na(osp.tlp)),
                  n.osp.ft=sum(!is.na(osp.ft)),
                  n.rwc.tlp=sum(!is.na(rwc.tlp)),
                  n.cft=sum(!is.na(cft)),
                  n.ctlp=sum(!is.na(ctlp)),
                  n.em=sum(!is.na(em)),
                  se.osp.tlp=sd(osp.tlp,na.rm=T)/sqrt(n.osp.tlp),
                  se.osp.ft=sd(osp.ft,na.rm=T)/sqrt(n.osp.ft),
                  se.rwc.tlp=sd(rwc.tlp,na.rm=T)/sqrt(n.rwc.tlp),
                  se.cft=sd(cft,na.rm=T)/sqrt(n.cft),
                  se.ctlp=sd(ctlp,na.rm=T)/sqrt(n.ctlp),
                  se.em=sd(em,na.rm=T)/sqrt(n.em))

write.csv(m.PVdata, file = "../results/Table1_PV.csv")

m.PVdata_mean_metabolism <- m.PVdata %>% 
  group_by(Metabolism) %>%
  summarise(osp.tlp=mean(m.osp.tlp,na.rm=TRUE),
                  osp.ft=mean(m.osp.ft,na.rm=TRUE),
                  rwc.tlp=mean(m.rwc.tlp,na.rm=TRUE),
                  cft=mean(m.cft,na.rm=TRUE),
                  ctlp=mean(m.ctlp,na.rm=TRUE),
                  em=mean(m.em,na.rm=TRUE),)

# t-test comparing species means between C3 and C4
t_osp.tlp <- t.test(log(abs(m.osp.tlp)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = m.PVdata)
t_osp.ft <- t.test(log(abs(m.osp.ft)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = m.PVdata)
t_rwc.tlp <- t.test(log(abs(m.rwc.tlp)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = m.PVdata)
t_cft <- t.test(log(abs(m.cft)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data= m.PVdata)
t_ctlp <- t.test(log(abs(m.ctlp))~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = m.PVdata)
t_em <- t.test(log(abs(m.em)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = m.PVdata)

```

##embolism onset

```{r}

#Embolism threshold
embolism_onset <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Post_doc_CalState_LA/Miquel_data/data/C3C4 Grasses - OV analysis.xlsx", 
    sheet = "Summary") %>% select(Species, Metabolism, Embolism_onset, outlier) %>%
 filter(is.na(outlier)) %>%
  mutate(Species = sub("[0-9X]+$", "", Species)) %>%
  group_by(Species, Metabolism) %>%
  summarise(
    m.embolism.onset = mean(Embolism_onset, na.rm = TRUE),
    n.embolism.onset = n(),
    se.embolism.onset = sd(Embolism_onset, na.rm = TRUE)/sqrt(n.embolism.onset)
  )

embolism_mean_metabolism <- embolism_onset %>% 
  group_by(Metabolism) %>%
  summarise(embolism.onset = mean(m.embolism.onset, na.rm = TRUE))

# t-test comparing species means between C3 and C4
t_embolism <- t.test(log(m.embolism.onset) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = embolism_onset)
t_embolism
```

##PLRC, CFD, CFR
```{r}
PLRC <- read.csv("../results/ED50_PLRC.csv")
CFD <- read.csv("../results/ED50_CFD.csv")
CFR <- read.csv("../results/ED50_CFR.csv")

ALL<- rbind(PLRC, CFD, CFR) 

ALL_mean_metabolism <- ALL %>%
  group_by(Trait, Metabolism) %>%
  summarise(mean_ED50 = mean(ED50, na.rm = TRUE),
            .groups = "drop")

# t-test comparing species means between C3 and C4
t_CFD <- t.test(log(abs(ED50)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE, data = ALL %>% filter(Trait =="CFD"))
t_CFR <- t.test(log(abs(ED50)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = ALL %>% filter(Trait =="CFR"))
t_PLRC <- t.test(log(abs(ED50)) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = ALL %>% filter(Trait =="PLRC"))
```


##anatomy 
```{r}
# Anatomy
anatomy <- read.csv("../data/m.SRCdata.csv", header=TRUE) %>%
  select(Species, Metabolism, m.LMA, m.T.LT, m.LDMC, m.LD, m.D.PLT, m.D.PLA, m.D.PLW1, 
                              n.LMA, n.T.LT, n.LDMC, n.LD, n.D.PLT, n.D.PLA, n.D.PLW1,
                              se.LMA, se.T.LT, se.LDMC, se.LD, se.D.PLT, se.D.PLA, se.D.PLW1)

#mean C3 C4
anatomy_mean_metabolism <- anatomy %>% 
  group_by(Metabolism) %>%
  summarise(LMA = mean(m.LMA, na.rm = TRUE),
            LT = mean(m.T.LT, na.rm = TRUE),
            LDMC = mean(m.LDMC, na.rm = TRUE),
            LD = mean(m.LD, na.rm = TRUE),
            PLT = mean(m.D.PLT, na.rm = TRUE),
            PLA = mean(m.D.PLA, na.rm = TRUE),
            PLW = mean(m.D.PLW1, na.rm = TRUE))

#ttest on means
t_LMA <- t.test(log(m.LMA) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = anatomy)
t_LMA
t_LT <- t.test(log(m.T.LT) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = anatomy)
t_LT
t_LDMC <- t.test(log(m.LDMC) ~ Metabolism,alternative = "two.sided", var.equal = TRUE, data = anatomy)
t_LDMC
t_LD <- t.test(log(m.LD) ~ Metabolism,alternative = "two.sided", var.equal = TRUE, data = anatomy)
t_LD
t_PLT <- t.test(log(m.D.PLT) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = anatomy)
t_PLT
t_PLA <- t.test(log(m.D.PLA) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = anatomy)
t_PLA
t_PLW <- t.test(log(m.D.PLW1) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = anatomy)
t_PLW
```

##shrinkage
```{r}
#Shrinkage PLX25
shrinkage <- read.csv("../results/shrinkage_P25.csv",header=TRUE) %>% select(-X) %>%
  mutate(Metabolism = c("C3","C3","C3","C4","C4","C4"))

#mean C3 and C4
mean_metabolism <- ddply(
  shrinkage,
  c("Metabolism"),
  summarise,
  m.RWCPLT25 = mean(RWCPLT25, na.rm = TRUE),
  m.RWCPLA25 = mean(RWCPLA25,  na.rm = TRUE),
  m.RWCPLW25 = mean(RWCPLW25, na.rm = TRUE))

#ttest on means
t_PLT25 <- t.test(log(RWCPLT25) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = shrinkage)
t_PLT25
t_PLA25 <- t.test(log(RWCPLA25) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = shrinkage)
t_PLA25
t_PLW25 <- t.test(log(RWCPLW25) ~ Metabolism, alternative = "two.sided", var.equal = TRUE,data = shrinkage)
t_PLW25
```

#Table 1 complete
```{r}
#Psi MPa
max_P50 <- read.csv("../results/Table1_max_P50.csv") %>% select(-X) %>% 
  select(
    Species,
    Metabolism,
    PA50,
    Pgs50,
    PKleaf50,
    PKroot50,
    PKplant50,
    PWUEimax)  

PVdata <- read.csv("../results/Table1_PV.csv") %>% select(Metabolism, Species, m.osp.tlp, m.osp.ft, m.rwc.tlp) 

Table1_MPa <- left_join(max_P50, PVdata, by = c("Metabolism","Species")) 

#RWC
embolism_onset <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Post_doc_CalState_LA/Miquel_data/data/C3C4 Grasses - OV analysis.xlsx", 
    sheet = "Summary") %>% select(Species, Metabolism, Embolism_onset, outlier) %>%
 filter(is.na(outlier)) %>%
  mutate(Species = sub("[0-9X]+$", "", Species)) %>%
  group_by(Species, Metabolism) %>%
  summarise(
    m.embolism.onset = mean(Embolism_onset, na.rm = TRUE))

PLRC <- read.csv("../results/ED50_PLRC.csv")
CFD <- read.csv("../results/ED50_CFD.csv")
CFR <- read.csv("../results/ED50_CFR.csv")

ALL<- rbind(PLRC, CFD, CFR)  %>%
  tidyr::pivot_wider(
    names_from = Trait,
    values_from = ED50)

Table1_RWC_A <- left_join(embolism_onset, ALL,by = c("Metabolism","Species") ) 

shrinkage <- read.csv("../results/shrinkage_P25.csv",header=TRUE) %>% select(-X) %>%
  mutate(Metabolism = c("C3","C3","C3","C4","C4","C4"))

Table1_RWC <- left_join(Table1_RWC_A, shrinkage,by = c("Metabolism","Species"))

Table1 <- left_join(Table1_MPa, Table1_RWC, by = c("Metabolism","Species"))

write.csv(x = Table1, "../results/Table1_forconversion.csv")
```

#//////////SEQUENCE OF EVENTS 

```{r}
Table1 <- read.csv("../results/Table1_forconversion.csv") %>% select(-X)

Psi_to_RWC <- Table1 %>%
  select(Species, Metabolism, m.osp.tlp, m.osp.ft, m.rwc.tlp,
         PA50, Pgs50, PKleaf50, PKroot50, PKplant50, PWUEimax) %>%
  rowwise() %>%  # Needed because each row has different parameters
  mutate(
    a = -m.osp.ft,
    c = (-m.osp.ft)/(-1*(1 - m.rwc.tlp/100)),
    d = ((-1/m.osp.ft) - (-1/m.osp.tlp))/(-1*(1 - m.rwc.tlp/100)),
    e = -1/m.osp.ft) %>%
  mutate(
    RWC.Kroot = ( sqrt(2*c*d*(-e*a + e*PKroot50 + 2) + d^2*(a - PKroot50)^2 + e^2*c^2) + a*d + 2*c*d + e*c - d*PKroot50) / (2*c*d),
    RWC.PA50     = ( sqrt(2*c*d*(-e*a + e*PA50 + 2) + d^2*(a - PA50)^2 + e^2*c^2) + a*d + 2*c*d + e*c - d*PA50) / (2*c*d),
    RWC.Pgs50    = ( sqrt(2*c*d*(-e*a + e*Pgs50 + 2) + d^2*(a - Pgs50)^2 + e^2*c^2) + a*d + 2*c*d + e*c - d*Pgs50) / (2*c*d),
    RWC.Kleaf50  = ( sqrt(2*c*d*(-e*a + e*PKleaf50 + 2) + d^2*(a - PKleaf50)^2 + e^2*c^2) + a*d + 2*c*d + e*c - d*PKleaf50) / (2*c*d),
    RWC.PKplant50 = ( sqrt(2*c*d*(-e*a + e*PKplant50 + 2) + d^2*(a - PKplant50)^2 + e^2*c^2) + a*d + 2*c*d + e*c - d*PKplant50) / (2*c*d),
    RWC.WUEi = ( sqrt(2*c*d*(-e*a + e*PWUEimax + 2) + d^2*(a - PWUEimax)^2 + e^2*c^2) + a*d + 2*c*d + e*c - d*PWUEimax) / (2*c*d))


#Now RWC to Psi
# traits to convert
traits <- c("m.embolism.onset", "PLRC", "CFD", "CFR", "RWCPLT25", "RWCPLA25", "RWCPLW25")

RWC_to_PSI <- Table1 %>%
  select(Species, Metabolism, m.osp.tlp, m.osp.ft, m.rwc.tlp, all_of(traits)) %>%
  
  # elasticity per species
  mutate(
    elasticity = case_when(
      Species == "Avsa" ~ 8.57,
      Species == "Chga" ~ 11.6,
      Species == "Hovu" ~ 9.27,
      Species == "Pegl" ~ 8.99,
      Species == "Trae" ~ 9.25,
      Species == "Zema" ~ 8.07,
      TRUE ~ NA_real_
    )
  ) %>%

  # convert all traits from % to proportion
  mutate(across(all_of(traits), ~ .x / 100)) %>%
  
  rowwise() %>%
  mutate(
    across(
      all_of(traits),
      .fns = list(psi = ~ {

        trait_value <- .x  # becomes 01

        # Psip (linear elasticity part)
        Psip <- -m.osp.tlp - elasticity * (1 - trait_value)
        Psip <- ifelse(Psip < 0, 0, Psip)

        # Ps: sigmoid osmotic part
        Ps <- m.osp.tlp / trait_value   # trait_value is 01

        # total psi
        Psip + Ps
      })
    )
  ) %>%
  ungroup()

Table1_RWC <- left_join(Psi_to_RWC %>% 
                          select(Species, Metabolism, m.rwc.tlp, RWC.Kroot, RWC.PA50, RWC.Pgs50, RWC.Kleaf50, RWC.PKplant50, RWC.WUEi) %>%
                          mutate(
                            RWC.Kroot = RWC.Kroot*100,
                            RWC.PA50 = RWC.PA50*100, 
                            RWC.Pgs50 = RWC.Pgs50*100,
                            RWC.Kleaf50 = RWC.Kleaf50*100,
                            RWC.PKplant50 = RWC.PKplant50*100,
                            RWC.WUEi = RWC.WUEi*100),    
                        RWC_to_PSI %>% 
  select(Species, Metabolism, m.embolism.onset, PLRC, CFD, CFR, RWCPLT25, RWCPLA25, RWCPLW25) %>%
    mutate(
      m.embolism.onset= m.embolism.onset*100,
                            PLRC = PLRC*100,
                            CFD = CFD*100,
                            CFR = CFR*100,
                            RWCPLT25 = RWCPLT25*100,
                            RWCPLA25= RWCPLA25*100,
                            RWCPLW25 =RWCPLW25*100), by = c("Metabolism", "Species"))

Table1_psi <- left_join(Psi_to_RWC %>% select(Species, Metabolism, m.osp.tlp, PKroot50, PA50, Pgs50, PKleaf50, PKplant50, PWUEimax), 
                        RWC_to_PSI %>% select(Species, Metabolism, m.embolism.onset_psi, PLRC_psi, CFD_psi, CFR_psi, RWCPLT25_psi, RWCPLA25_psi, RWCPLW25_psi), by = c("Metabolism", "Species"))

#write csv
write.csv(Table1_RWC,  "../results/Table1_RWC.csv")
write.csv(Table1_psi,  "../results/Table1_psi.csv")
```

#format data table RWC 
```{r}

Table1_RWC_summary <- Table1_RWC %>%
  group_by(Metabolism) %>%
  summarise(
    across(
      where(is.numeric),
      list(
        mean = ~ mean(.x, na.rm = TRUE),
        se   = ~ sd(.x, na.rm = TRUE) / sqrt(sum(!is.na(.x)))
      ),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  )

#remove CFR
Table1_RWC_summary <- Table1_RWC_summary %>%
  select(-CFR_mean, -CFR_se)

# Passer en format long
Table1_RWC_long <- Table1_RWC_summary %>%
  pivot_longer(
    cols = -Metabolism,
    names_to = c("trait", ".value"),
    names_pattern = "(.*)_(mean|se)"
  )

# Dterminer lordre des traits selon leur vulnrabilit
trait_order <- Table1_RWC_long  %>%
  group_by(trait) %>%
  summarise(meanRWC = mean(mean, na.rm = TRUE)) %>%
  arrange(meanRWC) %>%
  pull(trait)

Table1_RWC_long  <- Table1_RWC_long  %>%
  mutate(trait = factor(trait, levels = trait_order))

trait_labels <- c(
  RWC.Kleaf50   = expression(italic(K)[leaf50]),
  RWC.Kroot   = expression(italic(K)[root50]),
  RWC.PKplant50  = expression(italic(K)[plant50]),
  m.rwc.tlp    = expression(pi[tlp]),
  RWC.WUEi   = expression(WUE[imax]),
  RWC.Pgs50      = expression(italic(g)[s50]),
  RWC.PA50       = expression(italic(A)[50]),
  CFD = expression(italic(F)[v]/italic(F)[m50]),
#  CFR     = expression(CFR[50]),
  m.embolism.onset = "Embolism onset",
  PLRC       = expression(PLRC[50]),
  RWCPLA25      = expression(PLA[25]),
  RWCPLT25      = expression(PLT[25]),
  RWCPLW25      = expression(PLW[25]))
  

Figure4_RWC <- ggplot(Table1_RWC_long, aes(x = mean, y = trait, color = Metabolism)) +
  geom_point(size = 4, position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(xmin = mean - se, xmax = mean + se, group = Metabolism),
                 height = 0.3,
                 position = position_dodge(width = 0.5), color = "#404040") +
  
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33"))  +
  scale_y_discrete(labels = trait_labels) +   # <-- pretty trait labels
  labs(
    x = expression(RWC~"(%)"),
    y = ""
  ) +
  theme_minimal(base_size = 16) +
  theme(
    legend.title = element_blank(),
    axis.text.y = element_text(size = 16)
  ) +
  xlim(100,0)

Figure4_RWC

```


#format data table PSI
```{r}

Table1_psi_summary <- Table1_psi %>%
  group_by(Metabolism) %>%
  summarise(
    across(
      where(is.numeric),
      list(
        mean = ~ mean(.x, na.rm = TRUE),
        se   = ~ sd(.x, na.rm = TRUE) / sqrt(sum(!is.na(.x)))
      ),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  )

#remove CFR
Table1_psi_summary  <- Table1_psi_summary  %>%
  select(-CFR_psi_mean, -CFR_psi_se)

# Passer en format long
Table1_psi_long <- Table1_psi_summary %>%
  pivot_longer(
    cols = -Metabolism,
    names_to = c("trait", ".value"),
    names_pattern = "(.*)_(mean|se)"
  )

# Dterminer lordre des traits selon leur vulnrabilit
trait_order <- Table1_psi_long  %>%
  group_by(trait) %>%
  summarise(meanPSI = mean(mean, na.rm = TRUE)) %>%
  arrange(meanPSI) %>%
  pull(trait)

Table1_psi_long  <- Table1_psi_long  %>%
  mutate(trait = factor(trait, levels = trait_order))

trait_labels <- c(
  PKleaf50   = expression(italic(K)[leaf50]),
  PKroot50   = expression(italic(K)[root50]),
  PKplant50  = expression(italic(K)[plant50]),
  m.osp.tlp    = expression(pi[tlp]),
  PWUEimax   = expression(WUE[imax]),
  Pgs50      = expression(italic(g)[s50]),
  PA50       = expression(italic(A)[50]),
  CFD_psi =  expression(italic(F)[v]/italic(F)[m50]),
#  CFR_psi   = expression(CFR[50]),
  m.embolism.onset_psi = "Embolism onset",
  PLRC_psi       = expression(PLRC[50]),
  RWCPLA25_psi      = expression(PLA[25]),
  RWCPLT25_psi  = expression(PLT[25]),
  RWCPLW25_psi  = expression(PLW[25]))

Figure4_PSI <- ggplot(Table1_psi_long, aes(x = mean, y = trait, color = Metabolism)) +
  geom_point(size = 4, position = position_dodge(width = 0.5)) +
  geom_errorbarh(aes(xmin = mean - se, xmax = mean + se, group = Metabolism),
                 height = 0.3,
                 color = "#404040",
                 position = position_dodge(width = 0.5)) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33"))  +
  scale_y_discrete(labels = trait_labels) +   # <-- pretty trait labels
  labs(
    x = expression(Psi~"(MPa)"),
    y = ""
  ) +
  theme_minimal(base_size = 16) +
  theme(
    legend.title = element_blank(),
    axis.text.y = element_text(size = 16)
  ) +
  xlim(0, -15.5)

Figure4_PSI
```

##both figures
```{r}
Figure4 <- ggarrange(Figure4_PSI, Figure4_RWC, nrow=1, ncol=2, labels = c("A", "B"), common.legend = T, legend = "bottom")

ggsave(filename = "../results/Figure4.jpg", plot = Figure4, width = 14, height = 7)
```

# Correlations

## All correlations - pearson and spearman
```{r}

#Table with PSI
max_P50 <- read.csv("../results/Table1_max_P50.csv") %>% select(-X)
PVdata <- read.csv("../results/Table1_PV.csv")  %>% select(Species, Metabolism, m.osp.tlp, m.osp.ft, m.rwc.tlp, m.cft, m.ctlp, m.em)
CFD_CFR_PLRC_shrinakge <- read.csv("../results/Table1_psi.csv") %>% select(Species, Metabolism, m.embolism.onset_psi, PLRC_psi, CFD_psi, CFR_psi, RWCPLT25_psi, RWCPLA25_psi, RWCPLW25_psi)
anatomy <- read.csv("../data/m.SRCdata.csv", header=TRUE) %>%
  select(Species, Metabolism, m.LMA, m.T.LT, m.LDMC, m.LD, m.D.PLT, m.D.PLA, m.D.PLW1)

Table_psi <- left_join(max_P50, left_join(PVdata, left_join(CFD_CFR_PLRC_shrinakge, anatomy))) %>% select(-m.rwc.tlp)

#rename
Table_psi_rename <- Table_psi %>% 
  rename( `Kleafmax:gsmax` = Kleafmax_gsmax_ratio,
         tlp = m.osp.tlp,
         ft= m.osp.ft, 
         Cft= m.cft, 
         Ctlp =m.ctlp, 
         e = m.em, 
         `Embolism onset` = m.embolism.onset_psi,
         PLRC = PLRC_psi,
         FvFm50D = CFD_psi,
         FvFvm50R = CFR_psi,
         PLT25 = RWCPLT25_psi,
         PLA25 = RWCPLA25_psi,
         PLW25 = RWCPLW25_psi,
         LMA= m.LMA,
         LT = m.T.LT,
         LDMC = m.LDMC,
         LD = m.LD,
         PLTdry = m.D.PLT,
         PLAdry = m.D.PLA,
         PLWdry= m.D.PLW1)


df_num <- Table_psi_rename %>% select(where(is.numeric))

#also with RWC
# max_P50 <- read.csv("../results/Table1_max_P50.csv") %>% select(Species, Metabolism, Amax, gsmax, Kleafmax, Krootmax, Kplantmax, WUEimax, Kleafmax_gsmax_ratio)
# PVdata <- read.csv("../results/Table1_PV.csv")  %>% select(Species, Metabolism, m.osp.tlp, m.osp.ft, m.rwc.tlp, m.cft, m.ctlp, m.em)
# CFD_CFR_PLRC_shrinakge <- read.csv("../results/Table1_RWC.csv") %>% select(Species, Metabolism, RWC.Kroot, RWC.Kleaf50, RWC.PKplant50, RWC.PA50, RWC.Pgs50, RWC.WUEi, m.embolism.onset, PLRC, CFD, CFR, RWCPLT25, RWCPLA25, RWCPLW25)
# anatomy <- read.csv("../data/m.SRCdata.csv", header=TRUE) %>%
#   select(Species, Metabolism, m.LMA, m.T.LT, m.LDMC, m.LD, m.D.PLT, m.D.PLA, m.D.PLW1)
# Table_rwc <- left_join(max_P50, left_join(PVdata, left_join(CFD_CFR_PLRC_shrinakge, anatomy)))


# pairwise Spearman correlations
cor_res_s <- rcorr(as.matrix(df_num), type = "spearman")

# Extract correlation coefficients and p-values 
cor_table_s<- cor_res_s$r %>%
  as.data.frame() %>%
  rownames_to_column("var1") %>%
  pivot_longer(-var1, names_to = "var2", values_to = "rho") %>%
  left_join(
    cor_res_s$P %>%
      as.data.frame() %>%
      rownames_to_column("var1") %>%
      pivot_longer(-var1, names_to = "var2", values_to = "pval"),
    by = c("var1", "var2")
  ) %>%
  filter(var1 < var2) # avoid duplicates 

# Rank by strongest correlations
top_pairs_s <- cor_table_s %>%
  filter(!is.na(rho)) %>%
  arrange(pval, desc(abs(rho))) %>%
  filter(pval < 0.05)


write.csv(top_pairs_s, file = "../results/spearmancorr_psi.csv")

# pairwise pearson correlations
cor_res_p <- rcorr(as.matrix(df_num), type = "pearson")

# Extract correlation coefficients and p-values 
cor_table_p <- cor_res_p$r %>%
  as.data.frame() %>%
  rownames_to_column("var1") %>%
  pivot_longer(-var1, names_to = "var2", values_to = "rho") %>%
  left_join(
    cor_res_p$P %>%
      as.data.frame() %>%
      rownames_to_column("var1") %>%
      pivot_longer(-var1, names_to = "var2", values_to = "pval"),
    by = c("var1", "var2")
  ) %>%
  filter(var1 < var2) # avoid duplicates 

# Rank by strongest correlations
top_pairs_p <- cor_table_p %>%
  filter(!is.na(rho)) %>%
  arrange(pval, desc(abs(rho))) %>%
  filter(pval < 0.05)

write.csv(top_pairs_p, file = "../results/pearsoncorr_psi.csv")

#plots
##corrplot spearman
####Together combine###########

png(height=800, width=1600, file="../results/combined_corr_plots_psi.png", type = "cairo")

par(mfrow=c(1,2), oma=c(0,0,0,0), mar=c(0,0,0,0))

#  Spearman
cor_res <- rcorr(as.matrix(df_num), type = "spearman")
rho_matrix <- cor_res$r
p_matrix   <- cor_res$P  

#don't know why i had mismatches
common <- intersect(rownames(rho_matrix), rownames(p_matrix))
rho_matrix <- rho_matrix[common, common]
p_matrix   <- p_matrix[common, common]

corrplot(rho_matrix,
         method = 'color',
         order = 'original',
         type= 'upper',
         p.mat = p_matrix,
         sig.level = 0.05,
         insig = "blank",  
         diag = FALSE, 
         addgrid.col = "grey70", 
         cl.cex = 1.5, 
         tl.col = "black", 
         tl.srt = 40, 
         tl.cex = 1)
title(main = "Spearman", adj= 0.2, line = -5, cex.main = 3, col.main= "black")  

# Pearson 
cor_res <- rcorr(as.matrix(df_num), type = "pearson")
rho_matrix <- cor_res$r
p_matrix   <- cor_res$P

common <- intersect(rownames(rho_matrix), rownames(p_matrix))
rho_matrix <- rho_matrix[common, common]
p_matrix   <- p_matrix[common, common]

corrplot(rho_matrix,
         method = 'color',
         order = 'original',
         type= 'upper',
         p.mat = p_matrix,
         sig.level = 0.05,
         insig = "blank",  
         diag = FALSE, 
         addgrid.col = "grey70", 
         cl.cex = 1.5,
         tl.col = "black",
         tl.srt = 40,
         tl.cex = 1)
title(main = "Pearson", adj= 0.2, line = -5, cex.main = 3, col.main= "black")  

dev.off()


```


#Kleaf max with (max) Kroot, An and gs
```{r}
#some plots
round(cor_res_s$r["Kleafmax","Krootmax"], 2)
signif(cor_res_s$P["Kleafmax","Krootmax"], 2)
round(cor_res_p$r["Kleafmax","Krootmax"], 2)
signif(cor_res_p$P["Kleafmax","Krootmax"], 2)
label_text <- "atop(italic(r)[s] == 0.83 * '*',                     italic(r)[p] == 0.78 * 'ns')"

Kleafmax_Krootmax <-ggplot(Table_psi_rename , aes(x = Krootmax, y = Kleafmax, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  geom_smooth(aes(x = Krootmax, y = Kleafmax), method = "lm",
              se = FALSE, color = "black", linetype = "dashed",
              inherit.aes = FALSE) +
  annotate("text",
           x =0.08,
           y = 60,
           label = label_text,
           parse= T,
           size = 5) +
  xlab(expression(italic(K)[rootmax] ~ "(" * mol ~ m^{-2} ~ s^{-1} ~ MPa^{-1} * ")"))+
  ylab(expression(italic(K)[leafmax] ~ "(" * mmol ~ m^{-2} ~ s^{-1} ~ MPa^{-1} * ")"))+
  theme_minimal(base_size = 14) + ggtitle("A.")
Kleafmax_Krootmax
#to plot rho instead of R for Spearman: directly change in the function the output like that
#trace(ggpubr:::.cor_test, edit=TRUE)
#and edit italic(R) to become rho in
# if (output.type == "expression") {
#     z <- z %>% dplyr::mutate(r.label = paste("rho", r, sep = "~`=`~"),
#but I actually modofied to [2]


#####
round(cor_res_s$r["Kleafmax","Amax"], 2)
signif(cor_res_s$P["Kleafmax","Amax"], 2)
round(cor_res_p$r["Kleafmax","Amax"], 2)
signif(cor_res_p$P["Kleafmax","Amax"], 2)
label_text <- "atop(italic(r)[s] == 0.2 * 'ns',                     italic(r)[p] == -0.25 * 'ns')"

Kleafmax_Amax <-ggplot(Table_psi_rename , aes(x = Amax, y = Kleafmax, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  # geom_smooth(aes(x = Amax, y = Kleafmax), method = "lm",
  #             se = FALSE, color = "black", linetype = "dashed",
  #             inherit.aes = FALSE) +
  annotate("text",
           x =38,
           y = 60,
           label = label_text,
           parse= T,
           size = 5) +
  xlab(expression(italic(A)[nmax] ~ "(" * mol ~ m^{-2} ~ s^{-1} * ")"))+
  ylab(expression(" "))+
  theme_minimal(base_size = 14) + ggtitle("B.")
Kleafmax_Amax

######
round(cor_res_s$r["Kleafmax","gsmax"], 2)
signif(cor_res_s$P["Kleafmax","gsmax"], 2)
round(cor_res_p$r["Kleafmax","gsmax"], 2)
signif(cor_res_p$P["Kleafmax","gsmax"], 2)
label_text <- "atop(italic(r)[s] == 0.83 * '*',                     italic(r)[p] == 0.1 * 'ns')"

Kleafmax_gsmax <-ggplot(Table_psi_rename , aes(x = gsmax, y = Kleafmax, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  geom_smooth(aes(x = gsmax, y = Kleafmax), method = "lm",
              se = FALSE, color = "black", linetype = "dashed",
              inherit.aes = FALSE) +
  annotate("text",
           x =1.1,
           y = 60,
           label = label_text,
           parse= T,
           size = 5) +
  xlab(expression(italic(g)[smax] ~ "(" * mol ~ m^{-2} ~ s^{-1} * ")"))+
  ylab(expression(" "))+
  theme_minimal(base_size = 14) + ggtitle("C.")
Kleafmax_gsmax


theme1 <- ggarrange(Kleafmax_Krootmax, Kleafmax_Amax, Kleafmax_gsmax, nrow= 1)
theme1
```

##TLP vs (A50, gs50, Kleaf50, embolism)
```{r}
######
round(cor_res_s$r["tlp", "PA50"], 2)
signif(cor_res_s$P["tlp", "PA50"], 2)
round(cor_res_p$r["tlp", "PA50"], 2)
signif(cor_res_p$P["tlp", "PA50"], 2)
label_text <- "atop(italic(r)[s] ~ '=' * '0.89' ~ '*',italic(r)[p] ~ '=' * '0.95' ~ '**')"

tlp_A50 <-ggplot(Table_psi_rename, aes(y = tlp , x = PA50, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  geom_smooth(
    aes(y = tlp , x = PA50),   # re-specify to ignore grouping
    method = "lm", se = FALSE, color = "black", linetype = "dashed",
    inherit.aes = FALSE ) +
  annotate("text",
           x = -1.11,
           y = -0.80,
           label = label_text,
           parse= T,
           hjust = 0, vjust = 0.2, size = 5) +
   xlab(expression(italic(P)[An50] ~ "(MPa)"))+
    ylab(expression(pi[tlp] ~ "(MPa)"))+
  theme_minimal(base_size = 14) + ggtitle("D.")+
  ylim(-1.05, -0.7)

tlp_A50

############
round(cor_res_s$r["tlp", "Pgs50"], 2)
signif(cor_res_s$P["tlp", "Pgs50"], 2)
round(cor_res_p$r["tlp", "Pgs50"], 2)
signif(cor_res_p$P["tlp", "Pgs50"], 2)
label_text <- "atop(italic(r)[s] ~ '=' * '0.94' ~ '**',italic(r)[p] ~ '=' * '0.86' ~ '*')"

tlp_gs50 <-ggplot(Table_psi_rename, aes(y = tlp, x = Pgs50, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  geom_smooth(
    aes(y = tlp, x = Pgs50),   # re-specify to ignore grouping
    method = "lm", se = FALSE, color = "black", linetype = "dashed",
    inherit.aes = FALSE ) +
  annotate("text",
           x = -0.95,
           y = -0.8,
           label = label_text,
           parse= T,
           hjust = 0, vjust = 0.2, size = 5) +
    xlab(expression(italic(P)[gs50] ~ "(MPa)"))+
    ylab(expression(" "))+
  theme_minimal(base_size = 14) + ggtitle("E.")+
  ylim(-1.05, -0.7)

tlp_gs50


####
round(cor_res_s$r["tlp", "PKleaf50"], 2)
signif(cor_res_s$P["tlp", "PKleaf50"], 2)
round(cor_res_p$r["tlp", "PKleaf50"], 2)
signif(cor_res_p$P["tlp", "PKleaf50"], 2)
label_text <-"atop(italic(r)[s] ~ '=' * '0.49' ~ 'ns',italic(r)[p] ~ '=' * '0.31' ~ 'ns')"

tlp_Kleaf50 <-ggplot(Table_psi_rename, aes(y = tlp, x = PKleaf50, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  # geom_smooth(
  #   aes(y = tlp, x = PKleaf50),   # re-specify to ignore grouping
  #   method = "lm", se = FALSE, color = "black", linetype = "dashed",
  #   inherit.aes = FALSE ) +
  annotate("text",
           x = -0.4,
           y = -0.8,
           label = label_text,
           parse= T,
           hjust = 0, vjust = 0.2, size = 5) +
    xlab(expression(italic(P)[Kleaf50] ~ "(MPa)"))+
    ylab(expression(" "))+
  theme_minimal(base_size = 14) + ggtitle("F.")+
  ylim(-1.05, -0.7)
tlp_Kleaf50 


####
round(cor_res_s$r["tlp", "Embolism onset"], 2)
signif(cor_res_s$P["tlp", "Embolism onset"], 2)
round(cor_res_p$r["tlp", "Embolism onset"], 2)
signif(cor_res_p$P["tlp", "Embolism onset"], 2)
label_text <-"atop(italic(r)[s] ~ '=' * '-0.94' ~ '**',italic(r)[p] ~ '=' * '-0.97' ~ '**')"

tlp_embolism <-ggplot(Table_psi_rename, aes(y = tlp, x = `Embolism onset`, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  geom_smooth(
    aes(y = tlp, x = `Embolism onset`),   
    method = "lm", se = FALSE, color = "black", linetype = "dashed",
    inherit.aes = FALSE ) +
  annotate("text",
           y = -0.8,
           x = -2.3,
           label = label_text,
           parse= T,
           hjust = 0, vjust = 0.2, size = 5) +
    xlab(expression("Embolism onset" ~ "(MPa)"))+
    ylab(expression(" "))+
  theme_minimal(base_size = 14) + ggtitle("G.")+
  ylim(-1.05, -0.7)
tlp_embolism 


theme2 <- ggarrange(tlp_A50, tlp_gs50, tlp_Kleaf50, tlp_embolism, nrow= 1)
theme2

```

##embolism vs An50, gs50, Kleaf50, CFD, (CFR)
```{r}
##########
round(cor_res_s$r["PA50", "Embolism onset"], 2)
signif(cor_res_s$P["PA50", "Embolism onset"], 2)
round(cor_res_p$r["PA50", "Embolism onset"], 2)
signif(cor_res_p$P["PA50", "Embolism onset"], 2)
label_text <-"atop(italic(r)[s] ~ '=' * '-0.94' ~ '**',italic(r)[p] ~ '=' * '-0.96' ~ '**')"


embolism_PA50 <-ggplot(Table_psi_rename, aes(y = `Embolism onset` , x = PA50, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  geom_smooth(
    aes(y = `Embolism onset` , x = PA50),  
    method = "lm", se = FALSE, color = "black", linetype = "dashed",
    inherit.aes = FALSE ) +
  annotate("text",
           x = -0.9,
           y = -1.5,
           label = label_text,
           parse= T,
           hjust = 0, vjust = 0.2, size = 5) +
   ylab(expression("Embolism onset" ~ "(MPa)"))+
   xlab(expression(italic(P)[An50] ~ "(" * MPa * ")"))+
  theme_minimal(base_size = 14)+ ggtitle("H.")+
  ylim(-4.5, -1)
  
embolism_PA50

#########
round(cor_res_s$r["Pgs50", "Embolism onset"], 2)
signif(cor_res_s$P["Pgs50", "Embolism onset"], 2)
round(cor_res_p$r["Pgs50", "Embolism onset"], 2)
signif(cor_res_p$P["Pgs50", "Embolism onset"], 2)
label_text <-"atop(italic(r)[s] ~ '=' * '-0.89' ~ '*',italic(r)[p] ~ '=' * '-0.85' ~ '*')"


embolism_gs50 <-ggplot(Table_psi_rename, aes(y = `Embolism onset` , x = Pgs50, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  geom_smooth(
    aes(y = `Embolism onset` , x = Pgs50),  
    method = "lm", se = FALSE, color = "black", linetype = "dashed",
    inherit.aes = FALSE ) +
  annotate("text",
           x = -0.79,
          y = -1.5,
           label = label_text,
           parse= T,
           hjust = 0, vjust = 0.2, size = 5) +
   ylab(expression(" "))+
   xlab(expression(italic(P)[gs50] ~ "(" * MPa * ")"))+
  theme_minimal(base_size = 14)+ ggtitle("I.")+
  ylim(-4.5, -1)
embolism_gs50

###############
round(cor_res_s$r["PKleaf50", "Embolism onset"], 2)
signif(cor_res_s$P["PKleaf50", "Embolism onset"], 2)
round(cor_res_p$r["PKleaf50", "Embolism onset"], 2)
signif(cor_res_p$P["PKleaf50", "Embolism onset"], 2)
label_text <-"atop(italic(r)[s] ~ '=' * '-0.54' ~ 'ns',italic(r)[p] ~ '=' * '-0.4' ~ 'ns')"


embolism_Kleaf50 <-ggplot(Table_psi_rename, aes(y = `Embolism onset` , x = PKleaf50, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  # geom_smooth(
  #   aes(y = `Embolism onset` , x = PKleaf50),  
  #   method = "lm", se = FALSE, color = "black", linetype = "dashed",
  #   inherit.aes = FALSE ) +
  annotate("text",
           x = -0.35,
           y = -1.5,
           label = label_text,
           parse= T,
           hjust = 0, vjust = 0.2, size = 5) +
   ylab(expression(" "))+
   xlab(expression(italic(P)[Kleaf50] ~ "(" * MPa * ")"))+
  theme_minimal(base_size = 14)+ ggtitle("J.")+
  ylim(-4.5, -1)
embolism_Kleaf50

##############
round(cor_res_s$r["CFD", "Embolism onset"], 2)
signif(cor_res_s$P["CFD", "Embolism onset"], 2)
round(cor_res_p$r["CFD", "Embolism onset"], 2)
signif(cor_res_p$P["CFD", "Embolism onset"], 2)
label_text <-"atop(italic(r)[s] ~ '=' * '0.71' ~ 'ns',italic(r)[p] ~ '=' * '0.69' ~ 'ns')"


embolism_CFD <-ggplot(Table_psi_rename, aes(y = `Embolism onset` , x = CFD, colour = Metabolism)) +
  geom_point(size = 3.6) +
  scale_color_manual(values = c(C3 = "#6DB9F8", C4 = "#D9AB33")) +
  # geom_smooth(
  #   aes(y = `Embolism onset` , x = CFD),  
  #   method = "lm", se = FALSE, color = "black", linetype = "dashed",
  #   inherit.aes = FALSE ) +
  annotate("text",
           x = -6,
           y = -1.5,
           label = label_text,
           parse= T,
           hjust = 0, vjust = 0.2, size = 5) +
   ylab(expression(" "))+
   xlab(expression(CFD[50] ~ "(" * MPa * ")"))+
  theme_minimal(base_size = 14)+ ggtitle("K.")+
  ylim(-4.5, -1)

embolism_CFD

###
round(cor_res_s$r["CFR", "Embolism onset"], 2)
signif(cor_res_s$P["CFR", "Embolism onset"], 2)
round(cor_res_p$r["CFR", "Embolism onset"], 2)
signif(cor_res_p$P["CFR", "Embolism onset"], 2)
label_text <-"atop(italic(r)[s] ~ '=' * '0.71' ~ 'ns',italic(r)[p] ~ '=' * '0.69' ~ 'ns')"
```


##all correlations together plotted
```{r}
Figure6 <- ggarrange(Kleafmax_Krootmax, Kleafmax_Amax, Kleafmax_gsmax, NULL, 
                     tlp_A50, tlp_gs50, tlp_Kleaf50, tlp_embolism,
                     embolism_PA50, embolism_gs50, embolism_Kleaf50, embolism_CFD,
                     common.legend = T, legend= "bottom", ncol = 4, nrow=3) 


#Figure6
ggsave("../results/correlation.jpg", Figure6, width = 15, height = 15, dpi = 300)

```

#Lawren's analysis

We tested for differences between photosynthetic types using linear mixed-effects models (nested ANOVA), with photosynthetic type as a fixed effect, species nested within photosynthetic type, and individual plants treated as random effects. Analyses were performed separately for K, A, g, and K/g using individual-level measurements restricted to  > 1 MPa.

This increases power, avoids pseudoreplication and we do not claim generality across all C3 and C4. We therefore can affirm that the tested species differ and affirm that these tested differences align with a photosynthetic type.
```{r}

GExdata<-read_xlsx(path = "../data/C3C4 Grasses - GEx_PsifrompVcurves.xlsx", sheet = "C3C4G GEx R")
colnames(GExdata)
GExdata$Dataset<-factor(GExdata$Dataset)
GExdata$Metabolism<-factor(GExdata$Metabolism)
GExdata$Species<-factor(GExdata$Species,levels=c("Avsa","Hovu","Trae","Pegl","Zema","Chga"))
GExdata$Individual<-factor(GExdata$Individual)
GExdata$Leaf<-factor(GExdata$Leaf)
GExdata$Time.min<-factor(GExdata$Time.min)
GExdata.dehy<-subset(GExdata,Dataset== "Dehydration") #here time varies from 0 to X minutes

#get the correct invidual number:
GExdata_indv<-read_xlsx(path = "../data/C3C4 Grasses - GEx_PsifrompVcurves.xlsx", sheet = "Dehydration (Data)") %>% select("...5", outlier, "leaf", "Ca...20")

#rename conlumns
GExdata_indv<- GExdata_indv %>%
  rename(Individual = outlier,
         Species = "...5", 
         "F.wp.leaf" = "leaf",
         Ca = "Ca...20") 

GExdata_indv$F.wp.leaf <-as.numeric(GExdata_indv$F.wp.leaf)
GExdata_indv$Ca <-as.numeric(GExdata_indv$Ca)

#remove first row
GExdata_indv<- GExdata_indv[-1,]

#make the correspondance
GExdata.dehy_with_indv<-GExdata.dehy %>%
  select(-Individual) %>%
  left_join(GExdata_indv, by=c("Species", "F.wp.leaf", "Ca")) %>%
  relocate(Individual, .after = Metabolism)

#select variables
GExdata.dehy_with_indv<-GExdata.dehy_with_indv %>%
  select(Species, Individual, Metabolism, "Psileaf from RWC", RWC, An.area, gsw.area)



#add Kleaf
#AVSA -----------
Kleaf_avsa<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "AVSA")
Kleaf_avsa$`Lowest Psileaf` <- as.numeric(Kleaf_avsa$`Lowest Psileaf`)*-1
Kleaf_avsa$`Kleaf Tcorr` <- as.numeric(Kleaf_avsa$`Kleaf Tcorr`)
Kleaf_avsa$Kleaf_relative <- Kleaf_avsa$`Kleaf Tcorr`/max(Kleaf_avsa$`Kleaf Tcorr`,na.rm=TRUE)*100

#HOVU--------

Kleaf_hovu<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "HOVU") %>% dplyr::select(-`...27`)
Kleaf_hovu$`Lowest Psileaf` <- as.numeric(Kleaf_hovu$`Lowest Psileaf`)*-1
Kleaf_hovu$`Kleaf Tcorr` <- as.numeric(Kleaf_hovu$`Kleaf Tcorr`)
Kleaf_hovu$Kleaf_relative <- Kleaf_hovu$`Kleaf Tcorr`/max(Kleaf_hovu$`Kleaf Tcorr`,na.rm=TRUE)*100

#TRAE -------------
Kleaf_trae<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "TRAE")
Kleaf_trae$`Lowest Psileaf` <- as.numeric(Kleaf_trae$`Lowest Psileaf`)*-1
Kleaf_trae$`Kleaf Tcorr` <- as.numeric(Kleaf_trae$`Kleaf Tcorr`)
Kleaf_trae$Kleaf_relative <- Kleaf_trae$`Kleaf Tcorr`/max(Kleaf_trae$`Kleaf Tcorr`,na.rm=TRUE)*100


#PEGL ---------
Kleaf_pegl<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "PEGL")
Kleaf_pegl$`Lowest Psileaf` <- as.numeric(Kleaf_pegl$`Lowest Psileaf`)*-1
Kleaf_pegl$`Kleaf Tcorr` <- as.numeric(Kleaf_pegl$`Kleaf Tcorr`)
Kleaf_pegl$Kleaf_relative <- Kleaf_pegl$`Kleaf Tcorr`/max(Kleaf_pegl$`Kleaf Tcorr`,na.rm=TRUE)*100

#CHGA----------
Kleaf_chga<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "CHGA")
Kleaf_chga$`Lowest Psileaf` <- as.numeric(Kleaf_chga$`Lowest Psileaf`)*-1
Kleaf_chga$`Kleaf Tcorr` <- as.numeric(Kleaf_chga$`Kleaf Tcorr`)
Kleaf_chga$Kleaf_relative <- Kleaf_chga$`Kleaf Tcorr`/max(Kleaf_chga$`Kleaf Tcorr`,na.rm=TRUE)*100

#ZEMA----------
Kleaf_zema<-read_excel("../data/Kleaf_september13_2022.xlsx", sheet = "ZEMA")
Kleaf_zema$`Lowest Psileaf` <- as.numeric(Kleaf_zema$`Lowest Psileaf`)*-1
Kleaf_zema$`Kleaf Tcorr` <- as.numeric(Kleaf_zema$`Kleaf Tcorr`)
Kleaf_zema$Kleaf_relative <- Kleaf_zema$`Kleaf Tcorr`/max(Kleaf_zema$`Kleaf Tcorr`,na.rm=TRUE)*100

Kleaf <- rbind(Kleaf_avsa, Kleaf_hovu, Kleaf_trae, Kleaf_pegl, Kleaf_zema, Kleaf_chga)


Kleaf_curve <- Kleaf %>%
  mutate(psi_neg =  `Lowest Psileaf`) %>%
  dplyr::select(Species,Individual, psi_neg, `Kleaf Tcorr`) 

Kleaf_curve <- Kleaf_curve %>%
  rename("F.wp.leaf" = psi_neg)

Kleaf_curve$Individual <- as.character(Kleaf_curve$Individual)


#No individual numbers for Kplant Add Kroot


#Add dataframe together
#before adding Kleaf, let's add a column to this dataset 
GExdata.dehy_with_indv$`Kleaf Tcorr` <- NA
Kleaf_curve$"An.area"  <- NA
Kleaf_curve$"gsw.area"  <- NA
Kleaf_curve$RWC  <- NA

GExdata.dehy_with_indv <- GExdata.dehy_with_indv%>%
  rename("F.wp.leaf" = "Psileaf from RWC")

colnames(GExdata.dehy_with_indv)
colnames(Kleaf_curve)

Kleaf_curve <- Kleaf_curve %>%
  mutate(Metabolism = case_when(
    Species == "AVSA" ~ "C3",
    Species == "HOVU" ~ "C3",
    Species == "TRAE" ~ "C3",
    Species == "CHGA" ~ "C4",
    Species == "PEGL" ~ "C4",
    Species == "ZEMA" ~ "C4",
    TRUE ~ NA))

colnames(GExdata.dehy_with_indv)
colnames(Kleaf_curve)

df <- rbind(GExdata.dehy_with_indv, Kleaf_curve, by= c("Species"))
df <- df %>% filter(!is.na(Species))


#Pre-processing: filter and compute K/g
df$F.wp.leaf <- as.numeric(df$F.wp.leaf)

df <- df %>%
  mutate(
    F.wp.leaf   = parse_number(F.wp.leaf),
    gsw.area    = parse_number(gsw.area),
    `Kleaf Tcorr` = parse_number(`Kleaf Tcorr`))


df_filt <- df %>%
  filter(F.wp.leaf > -1) %>%                 # threshold for "well-watered-ish"
  mutate(
    Kleaf = as.numeric(`Kleaf Tcorr`),
    gs = as.numeric(gsw.area),
    Kg = Kleaf / gs,
    Species = factor(Species),
    Metabolism = factor(Metabolism),
    Individual = factor(Individual))

library(lme4)
library(lmerTest)   # gives p-values

mod_Kleaf <- lmer(
  Kleaf ~ Metabolism + Species + (1 | Individual),
  data = df_filt)

summary(mod_Kleaf)
anova(mod_Kleaf)

#Although mean Kleaf tended to be lower in C4 species under well-watered conditions, this difference was not significant (p = 0.20) and was small relative to interspecific and interindividual variability.

df_filt$An.area<- as.numeric(df_filt$An.area)

mod_A <- lmer(
  An.area ~ Metabolism + Species + (1 | Individual),
  data = df_filt)

summary(mod_A)
anova(mod_A)

#Assimilation was significantly lower in C4 than in C3 species  p = 0.042)

df_filt$gsw.area<- as.numeric(df_filt$gsw.area)

mod_g <- lmer(
  gsw.area  ~  Metabolism + Species + (1 | Individual),
  data = df_filt)

summary(mod_g)
anova(mod_g)

#gs was significantly lower in C4 than in C3 species (linear mixed model with species as a random effect; p = 0.016), with negligible variance attributable to individuals within species.


#testing speceis difference within photosynthetic types
library(emmeans)

emmeans(mod_Kleaf, ~ Species)
emmeans(mod_A, ~ Species)
emmeans(mod_g, ~ Species)


```

